
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Lee">
      
      
        <link rel="canonical" href="https://dongqianyu99.github.io/dongqianyu-blog/HPC%20101/Lab%20Notebook/notebook/">
      
      
        <link rel="prev" href="../../HPC%20Learning/notebook/HPC%20Learning/">
      
      
        <link rel="next" href="../../Lab%20Reports/lab1%20report/lab1%20report/">
      
      
      <link rel="icon" href="https://s2.loli.net/2024/04/26/PmRdM9iGnvOJHgu.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.39">
    
    
      
        <title>Lab Notebook - Dongqianyu's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8c3ca2c6.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bitter:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Bitter";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../../stylesheets/link.css">
    
      <link rel="stylesheet" href="../../../stylesheets/customize.css">
    
      <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&display=swap">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hpc101" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="Dongqianyu&#39;s Blog" class="md-header__button md-logo" aria-label="Dongqianyu's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Dongqianyu's Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab Notebook
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="关闭自动模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="关闭自动模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue"  aria-label="切换至夜间模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换至夜间模式" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="切换至日间模式"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="切换至日间模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/dongqianyu99/dongqianyu99.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    dongqianyu99
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  README

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../HPC%20Learning/notebook/HPC%20Learning/" class="md-tabs__link">
          
  
    
  
  HPC 101

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../ADS/ADS%20notebook/notebook/" class="md-tabs__link">
          
  
    
  
  ADS

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90/%E8%AE%A1%E7%BB%84%20notebook/notebook/" class="md-tabs__link">
          
  
    
  
  计算机组成

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Dongqianyu&#39;s Blog" class="md-nav__button md-logo" aria-label="Dongqianyu's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    Dongqianyu's Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/dongqianyu99/dongqianyu99.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    dongqianyu99
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    README
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    HPC 101
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            HPC 101
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../HPC%20Learning/notebook/HPC%20Learning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HPC-Learning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Lab Notebook
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Lab Notebook
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lab0linux-crash-course" class="md-nav__link">
    <span class="md-ellipsis">
      Lab0：Linux Crash Course
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab0：Linux Crash Course">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#01-linux" class="md-nav__link">
    <span class="md-ellipsis">
      0.1 创建虚拟机&amp;安装配置Linux环境
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#02-shelllinux-basics" class="md-nav__link">
    <span class="md-ellipsis">
      0.2 Shell&amp;Linux Basics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="0.2 Shell&Linux Basics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#021-command-line-interfacecli" class="md-nav__link">
    <span class="md-ellipsis">
      0.2.1 Command Line Interface(CLI)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="0.2.1 Command Line Interface(CLI)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0211the-linux-command-line-for-beginners-ubuntu" class="md-nav__link">
    <span class="md-ellipsis">
      0.2.1.1The Linux command line for beginners - Ubuntu
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#022-linux-file-system" class="md-nav__link">
    <span class="md-ellipsis">
      0.2.2 Linux File System
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#023the-advanced-packaging-toolapt" class="md-nav__link">
    <span class="md-ellipsis">
      0.2.3The Advanced Packaging Tool(APT)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#03-access-the-virtual-machine-using-ssh" class="md-nav__link">
    <span class="md-ellipsis">
      0.3 Access the Virtual Machine using SSH
    </span>
  </a>
  
    <nav class="md-nav" aria-label="0.3 Access the Virtual Machine using SSH">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#031-basic-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      0.3.1 basic concepts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#032-network-in-virtual-machines" class="md-nav__link">
    <span class="md-ellipsis">
      0.3.2 Network in Virtual Machines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#033-ssh" class="md-nav__link">
    <span class="md-ellipsis">
      0.3.3 SSH
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#04-more-on-linux" class="md-nav__link">
    <span class="md-ellipsis">
      0.4 More on Linux
    </span>
  </a>
  
    <nav class="md-nav" aria-label="0.4 More on Linux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#041-user-and-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      0.4.1 User and Permissions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="0.4.1 User and Permissions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0411-users-and-groups" class="md-nav__link">
    <span class="md-ellipsis">
      0.4.1.1 Users and Groups
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0412-environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      0.4.1.2 Environment Variables
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#05-git" class="md-nav__link">
    <span class="md-ellipsis">
      0.5 Git
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#06-lab0-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      0.6 Lab0 Tasks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab1" class="md-nav__link">
    <span class="md-ellipsis">
      Lab1:简单集群搭建
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab1:简单集群搭建">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-linux-angband" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 从源码构建Linux应用-以Angband为例
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1 从源码构建Linux应用-以Angband为例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.1 软件包源码的组织方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.2 令人头疼的依赖关系与数据库
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.3 不怎么自动的自动化构建工具
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1.3 不怎么自动的自动化构建工具">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1131-gnu-autotools" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.3.1 GNU Autotools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1132-cmake" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.3.2 CMake
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-openmpihpl" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 任务一：从源码构建OpenMPI和HPL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 任务一：从源码构建OpenMPI和HPL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-makefile" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.1 Makefile基本语法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.2 Tasks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 集群环境搭建与配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.3 集群环境搭建与配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#131" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.1 集群节点间的连接与互访
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.3.1 集群节点间的连接与互访">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1311" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.1.1 网络基础
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1312" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.1.2 计算机集群概念
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1313-ssh" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.1.3 SSH的密钥认证
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#132-mpi" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.2 MPI的运行方式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.3.2 MPI的运行方式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1321-quick-start-launching-mpi-applications" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.2.1 Quick start: Launching MPI applications
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1322-launching-with-ssh" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.2.2 Launching with SSH
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#133-benchmark" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.3 性能测试Benchmark
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-hpl" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 使用 HPL 测试虚拟机集群的性能
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.4 使用 HPL 测试虚拟机集群的性能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#141" class="md-nav__link">
    <span class="md-ellipsis">
      1.4.1 连接与互访
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#142-mpi" class="md-nav__link">
    <span class="md-ellipsis">
      1.4.2 测试MPI正常运行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#143-hpl" class="md-nav__link">
    <span class="md-ellipsis">
      1.4.3 运行HPL
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15" class="md-nav__link">
    <span class="md-ellipsis">
      1.5 技术杂谈
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.5 技术杂谈">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#151" class="md-nav__link">
    <span class="md-ellipsis">
      1.5.1 包管理器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#152-docker" class="md-nav__link">
    <span class="md-ellipsis">
      1.5.2 Docker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#153-nfs" class="md-nav__link">
    <span class="md-ellipsis">
      1.5.3 NFS
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab2" class="md-nav__link">
    <span class="md-ellipsis">
      Lab2:向量化计算
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab2:向量化计算">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 实验介绍
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 实验环境
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 实验基础知识
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.3 实验基础知识">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#231-numpy" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.1 Numpy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.3.1 Numpy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#numpy-array-vs-python-list" class="md-nav__link">
    <span class="md-ellipsis">
      Numpy Array vs Python List
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vectorsthe-1d-arrays" class="md-nav__link">
    <span class="md-ellipsis">
      Vectors,the 1D Arrays
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matricesthe-2d-arrays" class="md-nav__link">
    <span class="md-ellipsis">
      Matrices,the 2D Arrays
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3d-and-above" class="md-nav__link">
    <span class="md-ellipsis">
      3D and Above
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#232" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.2 双线性插值算法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#233-nhwc" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.3 NHWC 数据格式
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 实验步骤
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.4 实验步骤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#241" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.1 接口定义
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#242" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.2 基准代码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#243" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.3 完成向量化实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#244" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.4 检测实现正确与加速效果
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25" class="md-nav__link">
    <span class="md-ellipsis">
      2.5 实验初始代码
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab1-bonus" class="md-nav__link">
    <span class="md-ellipsis">
      Lab1 bonus
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab1 bonus">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-docker" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Docker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1 Docker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311-docker" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.1 为什么使用Docker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#312-docker" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.2 安装Docker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1.2 安装Docker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#windowsmacos" class="md-nav__link">
    <span class="md-ellipsis">
      在Windows或macOS上安装
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      在Linux上安装
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registry-mirror" class="md-nav__link">
    <span class="md-ellipsis">
      配置Registry Mirror
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hello-worlddocker" class="md-nav__link">
    <span class="md-ellipsis">
      使用Hello World测试Docker安装
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#313-docker" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.3 使用Docker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1.3 使用Docker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ubuntushell" class="md-nav__link">
    <span class="md-ellipsis">
      在Ubuntu容器中使用shell
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pythonpython" class="md-nav__link">
    <span class="md-ellipsis">
      在Python容器中使用Python命令行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mkdocs" class="md-nav__link">
    <span class="md-ellipsis">
      在MkDocs容器运行文档
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-dockerlab1" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 尝试使用Docker复现Lab1
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 尝试使用Docker复现Lab1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-ubuntu-containerthe-one" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.1 在ubuntu-container容器中复现The one的环境
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.2 手动构建镜像
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab25-bonus-simd" class="md-nav__link">
    <span class="md-ellipsis">
      Lab2.5-Bonus 手写 SIMD 向量化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab2.5-Bonus 手写 SIMD 向量化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 实验基础知识
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 实验步骤
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.2 实验步骤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#421-multicpp" class="md-nav__link">
    <span class="md-ellipsis">
      4.2.1 实验初始代码 multi.cpp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#422-avx" class="md-nav__link">
    <span class="md-ellipsis">
      4.2.2 AVX指令集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#423" class="md-nav__link">
    <span class="md-ellipsis">
      4.2.3 优化思路
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-godbolt" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 godbolt
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab5" class="md-nav__link">
    <span class="md-ellipsis">
      Lab5 简单神经网络训练与加速
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab5 简单神经网络训练与加速">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      实验介绍
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      实验环境
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      实验基础知识
    </span>
  </a>
  
    <nav class="md-nav" aria-label="实验基础知识">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Model Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attention" class="md-nav__link">
    <span class="md-ellipsis">
      Attention
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#embeddings-and-softmax" class="md-nav__link">
    <span class="md-ellipsis">
      Embeddings and Softmax
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#positional-encoding" class="md-nav__link">
    <span class="md-ellipsis">
      Positional Encoding
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-norm" class="md-nav__link">
    <span class="md-ellipsis">
      Add &amp; Norm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#position-wise-feed-forward-networks" class="md-nav__link">
    <span class="md-ellipsis">
      Position-wise Feed-Forward Networks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-head-attention" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Head Attention
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#encoder-stacks" class="md-nav__link">
    <span class="md-ellipsis">
      Encoder Stacks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decoder-stacks" class="md-nav__link">
    <span class="md-ellipsis">
      Decoder Stacks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#projection-layers" class="md-nav__link">
    <span class="md-ellipsis">
      Projection Layers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transformer-build-transformer" class="md-nav__link">
    <span class="md-ellipsis">
      Transformer &amp; Build Transformer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Lab Reports
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Lab Reports
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Lab%20Reports/lab1%20report/lab1%20report/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab1 Report
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Lab%20Reports/lab2%20report/lab2%20report/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab2 Report
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Lab%20Reports/lab2.5%20report/lab2.5%20report/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab2.5 Report
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Lab%20Reports/lab3%20report/lab3%20report/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab3 Report
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Lab%20Reports/lab4%20report/lab4%20report/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab4 Report
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Lab%20Reports/lab5%20report/lab5%20report/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab5 Report
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../PAC%20Note/PAC%20Notebook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PAC Notebook
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ADS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            ADS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ADS/ADS%20notebook/notebook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ADS Notebook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ADS/PTA%20Homework/homework/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PTA Homework
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    计算机组成
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            计算机组成
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90/%E8%AE%A1%E7%BB%84%20notebook/notebook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    计组 Notebook
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lab0linux-crash-course" class="md-nav__link">
    <span class="md-ellipsis">
      Lab0：Linux Crash Course
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab0：Linux Crash Course">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#01-linux" class="md-nav__link">
    <span class="md-ellipsis">
      0.1 创建虚拟机&amp;安装配置Linux环境
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#02-shelllinux-basics" class="md-nav__link">
    <span class="md-ellipsis">
      0.2 Shell&amp;Linux Basics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="0.2 Shell&Linux Basics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#021-command-line-interfacecli" class="md-nav__link">
    <span class="md-ellipsis">
      0.2.1 Command Line Interface(CLI)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="0.2.1 Command Line Interface(CLI)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0211the-linux-command-line-for-beginners-ubuntu" class="md-nav__link">
    <span class="md-ellipsis">
      0.2.1.1The Linux command line for beginners - Ubuntu
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#022-linux-file-system" class="md-nav__link">
    <span class="md-ellipsis">
      0.2.2 Linux File System
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#023the-advanced-packaging-toolapt" class="md-nav__link">
    <span class="md-ellipsis">
      0.2.3The Advanced Packaging Tool(APT)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#03-access-the-virtual-machine-using-ssh" class="md-nav__link">
    <span class="md-ellipsis">
      0.3 Access the Virtual Machine using SSH
    </span>
  </a>
  
    <nav class="md-nav" aria-label="0.3 Access the Virtual Machine using SSH">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#031-basic-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      0.3.1 basic concepts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#032-network-in-virtual-machines" class="md-nav__link">
    <span class="md-ellipsis">
      0.3.2 Network in Virtual Machines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#033-ssh" class="md-nav__link">
    <span class="md-ellipsis">
      0.3.3 SSH
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#04-more-on-linux" class="md-nav__link">
    <span class="md-ellipsis">
      0.4 More on Linux
    </span>
  </a>
  
    <nav class="md-nav" aria-label="0.4 More on Linux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#041-user-and-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      0.4.1 User and Permissions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="0.4.1 User and Permissions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0411-users-and-groups" class="md-nav__link">
    <span class="md-ellipsis">
      0.4.1.1 Users and Groups
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0412-environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      0.4.1.2 Environment Variables
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#05-git" class="md-nav__link">
    <span class="md-ellipsis">
      0.5 Git
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#06-lab0-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      0.6 Lab0 Tasks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab1" class="md-nav__link">
    <span class="md-ellipsis">
      Lab1:简单集群搭建
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab1:简单集群搭建">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-linux-angband" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 从源码构建Linux应用-以Angband为例
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1 从源码构建Linux应用-以Angband为例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.1 软件包源码的组织方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.2 令人头疼的依赖关系与数据库
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.3 不怎么自动的自动化构建工具
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1.3 不怎么自动的自动化构建工具">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1131-gnu-autotools" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.3.1 GNU Autotools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1132-cmake" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.3.2 CMake
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-openmpihpl" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 任务一：从源码构建OpenMPI和HPL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 任务一：从源码构建OpenMPI和HPL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-makefile" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.1 Makefile基本语法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.2 Tasks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 集群环境搭建与配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.3 集群环境搭建与配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#131" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.1 集群节点间的连接与互访
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.3.1 集群节点间的连接与互访">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1311" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.1.1 网络基础
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1312" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.1.2 计算机集群概念
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1313-ssh" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.1.3 SSH的密钥认证
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#132-mpi" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.2 MPI的运行方式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.3.2 MPI的运行方式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1321-quick-start-launching-mpi-applications" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.2.1 Quick start: Launching MPI applications
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1322-launching-with-ssh" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.2.2 Launching with SSH
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#133-benchmark" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.3 性能测试Benchmark
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-hpl" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 使用 HPL 测试虚拟机集群的性能
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.4 使用 HPL 测试虚拟机集群的性能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#141" class="md-nav__link">
    <span class="md-ellipsis">
      1.4.1 连接与互访
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#142-mpi" class="md-nav__link">
    <span class="md-ellipsis">
      1.4.2 测试MPI正常运行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#143-hpl" class="md-nav__link">
    <span class="md-ellipsis">
      1.4.3 运行HPL
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15" class="md-nav__link">
    <span class="md-ellipsis">
      1.5 技术杂谈
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.5 技术杂谈">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#151" class="md-nav__link">
    <span class="md-ellipsis">
      1.5.1 包管理器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#152-docker" class="md-nav__link">
    <span class="md-ellipsis">
      1.5.2 Docker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#153-nfs" class="md-nav__link">
    <span class="md-ellipsis">
      1.5.3 NFS
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab2" class="md-nav__link">
    <span class="md-ellipsis">
      Lab2:向量化计算
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab2:向量化计算">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 实验介绍
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 实验环境
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 实验基础知识
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.3 实验基础知识">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#231-numpy" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.1 Numpy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.3.1 Numpy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#numpy-array-vs-python-list" class="md-nav__link">
    <span class="md-ellipsis">
      Numpy Array vs Python List
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vectorsthe-1d-arrays" class="md-nav__link">
    <span class="md-ellipsis">
      Vectors,the 1D Arrays
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matricesthe-2d-arrays" class="md-nav__link">
    <span class="md-ellipsis">
      Matrices,the 2D Arrays
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3d-and-above" class="md-nav__link">
    <span class="md-ellipsis">
      3D and Above
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#232" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.2 双线性插值算法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#233-nhwc" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.3 NHWC 数据格式
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 实验步骤
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.4 实验步骤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#241" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.1 接口定义
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#242" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.2 基准代码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#243" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.3 完成向量化实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#244" class="md-nav__link">
    <span class="md-ellipsis">
      2.4.4 检测实现正确与加速效果
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25" class="md-nav__link">
    <span class="md-ellipsis">
      2.5 实验初始代码
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab1-bonus" class="md-nav__link">
    <span class="md-ellipsis">
      Lab1 bonus
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab1 bonus">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-docker" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Docker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1 Docker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311-docker" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.1 为什么使用Docker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#312-docker" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.2 安装Docker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1.2 安装Docker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#windowsmacos" class="md-nav__link">
    <span class="md-ellipsis">
      在Windows或macOS上安装
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      在Linux上安装
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registry-mirror" class="md-nav__link">
    <span class="md-ellipsis">
      配置Registry Mirror
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hello-worlddocker" class="md-nav__link">
    <span class="md-ellipsis">
      使用Hello World测试Docker安装
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#313-docker" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.3 使用Docker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1.3 使用Docker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ubuntushell" class="md-nav__link">
    <span class="md-ellipsis">
      在Ubuntu容器中使用shell
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pythonpython" class="md-nav__link">
    <span class="md-ellipsis">
      在Python容器中使用Python命令行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mkdocs" class="md-nav__link">
    <span class="md-ellipsis">
      在MkDocs容器运行文档
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-dockerlab1" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 尝试使用Docker复现Lab1
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 尝试使用Docker复现Lab1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-ubuntu-containerthe-one" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.1 在ubuntu-container容器中复现The one的环境
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.2 手动构建镜像
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab25-bonus-simd" class="md-nav__link">
    <span class="md-ellipsis">
      Lab2.5-Bonus 手写 SIMD 向量化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab2.5-Bonus 手写 SIMD 向量化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 实验基础知识
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 实验步骤
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.2 实验步骤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#421-multicpp" class="md-nav__link">
    <span class="md-ellipsis">
      4.2.1 实验初始代码 multi.cpp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#422-avx" class="md-nav__link">
    <span class="md-ellipsis">
      4.2.2 AVX指令集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#423" class="md-nav__link">
    <span class="md-ellipsis">
      4.2.3 优化思路
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-godbolt" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 godbolt
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab5" class="md-nav__link">
    <span class="md-ellipsis">
      Lab5 简单神经网络训练与加速
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lab5 简单神经网络训练与加速">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      实验介绍
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      实验环境
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      实验基础知识
    </span>
  </a>
  
    <nav class="md-nav" aria-label="实验基础知识">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Model Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attention" class="md-nav__link">
    <span class="md-ellipsis">
      Attention
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#embeddings-and-softmax" class="md-nav__link">
    <span class="md-ellipsis">
      Embeddings and Softmax
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#positional-encoding" class="md-nav__link">
    <span class="md-ellipsis">
      Positional Encoding
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-norm" class="md-nav__link">
    <span class="md-ellipsis">
      Add &amp; Norm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#position-wise-feed-forward-networks" class="md-nav__link">
    <span class="md-ellipsis">
      Position-wise Feed-Forward Networks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-head-attention" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Head Attention
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#encoder-stacks" class="md-nav__link">
    <span class="md-ellipsis">
      Encoder Stacks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decoder-stacks" class="md-nav__link">
    <span class="md-ellipsis">
      Decoder Stacks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#projection-layers" class="md-nav__link">
    <span class="md-ellipsis">
      Projection Layers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transformer-build-transformer" class="md-nav__link">
    <span class="md-ellipsis">
      Transformer &amp; Build Transformer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/dongqianyu99/dongqianyu99.github.io/edit/main/docs/HPC 101/Lab Notebook/notebook.md" title="编辑此页" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/dongqianyu99/dongqianyu99.github.io/raw/main/docs/HPC 101/Lab Notebook/notebook.md" title="查看本页的源代码" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="hpc101">HPC101超算短学期<a class="headerlink" href="#hpc101" title="Permanent link">&para;</a></h1>
<p>谈谈如何让自己看上去、闻上去都像一个CS人<br />
https://www.cc98.org/topic/5370849<br />
Stack Overflow<br />
https://stackoverflow.com<br />
电子书<br />
http://libgen.is/<br />
https://z-epub.com/<br />
MIT missing semester<br />
https://missing.csail.mit.edu/2020/<br />
CS自学指南
https://csdiy.wiki/<br />
Dev on Windows with WSL<br />
https://dowww.spencerwoo.com/<br />
ZJUSCT OpenDocs<br />
https://zjusct.pages.zjusct.io/ops/opendocs/</p>
<!-- ## 登录集群  
### 配置密钥登录    
step1：配置ZJU Git中的SSH密钥（在SSH一节中有讲）  
step2：登录集群时，使用 ssh 账户名+节点名@clusters.zju.edu.cn 登录。如果你的 SSH 密钥配置正确，你将登录到集群登录节点。  
***ssh h3230102778+hpc101@clusters.zju.edu.cn***  
连接正常会看到  
![ ](image-66.png) 
### 集群资源&常见问题  
参考https://zjusct.pages.zjusct.io/ops/opendocs/guide/   -->

<h2 id="lab0linux-crash-course">Lab0：Linux Crash Course<a class="headerlink" href="#lab0linux-crash-course" title="Permanent link">&para;</a></h2>
<p>参考的文档<br />
https://zjusct.pages.zjusct.io/summer_hpc101_2024/hpc-101-labs-2024/Lab0-LinuxCrashCourse/<br />
https://101.lug.ustc.edu.cn/#contact-us</p>
<blockquote>
<p>Obtain a Linux Virtual Machine
- [x] Install a hypervisor on your computer
- [x] Create a new virtual machine in the hypervisor
- [x] Install a Linux distribution in the virtual machine
Linux Basics
- [x] Command Line Interface (CLI)
- [x] Linux File System
- [x] Package Management
Remote Access
- [x] Network Basics
- [x] SSH
More on Linux
- [x] Users and Permissions
- [x] Environment Variables
Git
- [x] Register a ZJU Git account
- [x] Configure Public Key
- [x] Clone a Repository  </p>
</blockquote>
<hr />
<h3 id="01-linux">0.1 创建虚拟机&amp;安装配置Linux环境<a class="headerlink" href="#01-linux" title="Permanent link">&para;</a></h3>
<p>一脸懵逼，选择了在 VMware Workstation 中安装 Ubuntu，其中VMwar Workstation Pro是一个虚拟机管理软件（虚拟化软件），Ubuntu是我要给这个虚拟化软件中的虚拟机加装的系统。当然，还可以直接在电脑上加装Linux，用WSL+vscode就不用虚拟机了，据说体验很好，之后可能会用到。安装过程参考<br />
https://ibug.io/cn/2019/02/setup-ubuntu-in-vmware/  </p>
<blockquote>
<p>安装VMware Workstation有个该死的跳转到博通的网站，这里参考<br />
https://blog.csdn.net/Python_paipai/article/details/139409629?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=VMware%20Workstation%20Pro&amp;utm_medium=distribute.pc_search_result.none-task-blog-2<sub>all</sub>sobaiduweb~default-2-139409629.142<sup>v100</sup>pc_search_result_base8&amp;spm=1018.2226.3001.4187<br />
从这里进： support.broadcom.com<br />
原来lab文件里提供了一个yutube教学视频qwq</p>
</blockquote>
<p>Linux有很多的发型版：  </p>
<blockquote>
<p>Slackware：历史最悠久的发行版<br />
Debian：历史第二悠久的发行版<br />
Arch Linux：可高度自定义的发行版<br />
Ubuntu：基于 Debian，最广泛使用的发行版<br />
Deepin：基于 Debian 的国产操作系统</p>
</blockquote>
<p>lab文档里推荐的是用Debian，第一次尝试的时候也是用的Debian，但它给我一种很原始的感觉，界面也很丑，所以想选择ubuntu。后续可能需要不止一台虚拟机来形成集群，那时候会缩减虚拟机内存而不加桌面，但第一台虚拟机为了体验就安装桌面版的ubuntu。中科大的文档中有轻量化xubuntu的镜像 https://101.lug.ustc.edu.cn/Ch01/#get-vm-softwares</p>
<p>从THU的镜像站 https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/bionic/ 下载桌面版的ubuntu-18.04.6-desktop-amd64.iso，添加到VMware新建的虚拟机中，后面就按文档一步步做就好</p>
<p><img alt="alt text" src="../image.png" />
于是就成功做出了第一台虚拟机  </p>
<p>接下来尝试把zsh作为默认的shell，并加入oh-my-zsh，参考 https://note.tonycrane.cc/cs/tools/shell/ 和 https://www.haoyep.com/posts/zsh-config-oh-my-zsh/  </p>
<p><img alt="alt text" src="../image-1.png" /><br />
oh my zsh！  </p>
<p>之后可以设置powerlevel 10k主题和安装插件（暂时没安装插件）</p>
<hr />
<h3 id="02-shelllinux-basics">0.2 Shell&amp;Linux Basics<a class="headerlink" href="#02-shelllinux-basics" title="Permanent link">&para;</a></h3>
<hr />
<p>自学文档<br />
https://slides.tonycrane.cc/PracticalSkillsTutorial/2023-fall-ckc/lec1/#/2/8<br />
b站视频<br />
https://www.bilibili.com/video/BV1ry4y1A7qo/?vd_source=5742e02a7566918d65a441adce5bc163  </p>
<hr />
<h4 id="021-command-line-interfacecli">0.2.1 Command Line Interface(CLI)<a class="headerlink" href="#021-command-line-interfacecli" title="Permanent link">&para;</a></h4>
<p>lab文档要求看 https://ubuntu.com/tutorials/command-line-for-beginners#1-overview （The Linux command line for beginners - Ubuntu.）Section1-5</p>
<h5 id="0211the-linux-command-line-for-beginners-ubuntu">0.2.1.1The Linux command line for beginners - Ubuntu<a class="headerlink" href="#0211the-linux-command-line-for-beginners-ubuntu" title="Permanent link">&para;</a></h5>
<p>这里是直接看竺院辅学的视频来学的 https://www.bilibili.com/video/BV1ry4y1A7qo/?vd_source=5742e02a7566918d65a441adce5bc163  </p>
<blockquote>
<p>prompt 命令提示符，用来等待输入并给出一些信息 </p>
<p>最重要的是工作路径，也就是shell所处的位置，路径相关命令有：  </p>
<blockquote>
<p>pwd(print working directory)获取当前的位置（~代表的就是当前用户的“home”目录）<br />
cd path(change directory):切换路径  </p>
<blockquote>
<p>path可以是相对路径或绝对路径<br />
path中~代表home，.代表当前路径，..代表上一级路径<br />
<img alt="alt text" src="../image-3.png" />  </p>
</blockquote>
</blockquote>
<p><strong>文件/目录操作命令</strong></p>
<blockquote>
<p>ls：列出当前路径下的文件和目录（-a列出所有文件和目录，包括隐藏文件；-l列出详细信息）<br />
touch file：创建一个文件<br />
mkdir dir：创建一个目录<br />
cp src dst：复制文件或目录（-r递归复制目录）<br />
mv src dst：移动文件或目录(重命名)dst如果是文件夹，就有<br />
rm files..：删除文件（-r递归删除目录；-f强制删除）<br />
find path -name pattern：在path下查找文件名匹配pattern的文件  </p>
</blockquote>
<p><strong>文件内容查看命令</strong>  </p>
<blockquote>
<p>cat files ...：输出与拼接文件（-n：带符号输出）<br />
head files：输出file前10行（-n lines：输出前lines行）<br />
tail files：输出file后10行（-n lines：输出后lines行）<br />
more/less file：分页输出file内容  </p>
</blockquote>
</blockquote>
<p>这里留个坑，关于shell的语法之后再补</p>
<hr />
<h4 id="022-linux-file-system">0.2.2 Linux File System<a class="headerlink" href="#022-linux-file-system" title="Permanent link">&para;</a></h4>
<p>(待)  </p>
<hr />
<h4 id="023the-advanced-packaging-toolapt">0.2.3The Advanced Packaging Tool(APT)<a class="headerlink" href="#023the-advanced-packaging-toolapt" title="Permanent link">&para;</a></h4>
<p>(待)  </p>
<hr />
<h3 id="03-access-the-virtual-machine-using-ssh">0.3 Access the Virtual Machine using SSH<a class="headerlink" href="#03-access-the-virtual-machine-using-ssh" title="Permanent link">&para;</a></h3>
<hr />
<h4 id="031-basic-concepts">0.3.1 basic concepts<a class="headerlink" href="#031-basic-concepts" title="Permanent link">&para;</a></h4>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> IP address</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> MAC address</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Subnet mask</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Gateway</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Port</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Port forwarding  </li>
</ul>
<p>https://www.bilibili.com/video/BV1CQ4y1d728/?vd_source=5742e02a7566918d65a441adce5bc163  </p>
<p>https://www.bilibili.com/video/BV1DD4y127r4/?vd_source=5742e02a7566918d65a441adce5bc163  </p>
<hr />
<h4 id="032-network-in-virtual-machines">0.3.2 Network in Virtual Machines<a class="headerlink" href="#032-network-in-virtual-machines" title="Permanent link">&para;</a></h4>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Ping the virtual machine  </li>
</ul>
<p>step1:Check if the network mode of the virtual machine is set to <em>NAT</em>.  <br />
<img alt="alt text" src="../image-4.png" /><br />
step2:Use the <strong><em>ip addr</em></strong> command to find the IP address of the virtual machine.<br />
<img alt="alt text" src="../image-5.png" /><br />
From the screenshot, the virtual machine has two network interfaces: ens33 and lo. The latter is the loopback interface, and the former is the network interface used to connect to the network. We can see that the IP address of the virtual machine is 192.168.75.128.<br />
Open a terminal on your host machine and ping the virtual machine.<br />
<em>ping 192.168.75.128</em><br />
The ouput is like:<br />
<img alt="alt text" src="../image-6.png" />  </p>
<hr />
<h4 id="033-ssh">0.3.3 SSH<a class="headerlink" href="#033-ssh" title="Permanent link">&para;</a></h4>
<p>Secure Shell (SSH) is a cryptographic network protocol for operating network services securely over an unsecured network. The best-known example application is for remote login to computer systems by users.<br />
More about the Asymmetric Encryption:https://www.youtube.com/watch?v=AQDCe585Lnc<br />
<img alt="alt text" src="../ssh.png" />  </p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Connect to the virtual machine using SSH  </li>
</ul>
<p>step1:我选择在虚拟机上操作，一般Linux和macOS上已经预装了SSH client，如果要在windows上装，可以参考：https://learn.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstusetabs=gui#install-openssh-for-windows<br />
step2:You also need to install an SSH server on the virtual machine.<br />
<strong><em>sudo apt update</em></strong><br />
<strong><em>sudo apt install openssh-server</em></strong><br />
<img alt="alt text" src="../image-7.png" />
step3:After installing the SSH server, you can use the ssh command to connect to the virtual machine:<br />
<strong><em>ssh username@IP_ADDRESS</em></strong><br />
Replace username with your username on the virtual machine and IP_ADDRESS with the IP address of the virtual machine.<br />
<img alt="alt text" src="../image-8.png" /><br />
Now you can copy and paste commands to this terminal. You can also use the scp command to copy files between your computer and the virtual machine. You can also connect your VSCode to the virtual machine using the Remote-SSH extension, but don't rely on it too much.  </p>
<hr />
<h3 id="04-more-on-linux">0.4 More on Linux<a class="headerlink" href="#04-more-on-linux" title="Permanent link">&para;</a></h3>
<hr />
<h4 id="041-user-and-permissions">0.4.1 User and Permissions<a class="headerlink" href="#041-user-and-permissions" title="Permanent link">&para;</a></h4>
<p>lab文档给的自学视频是youtube上的 https://www.youtube.com/watch?v=19WOD84JFxA 和 https://www.youtube.com/watch?v=LnKoncbQBsM 两个全英文无字幕视频，为了赶时间我就用中科大文档里的 https://101.lug.ustc.edu.cn/Ch05/#users-and-groups 平替了（还得是中科大）  </p>
<h5 id="0411-users-and-groups">0.4.1.1 Users and Groups<a class="headerlink" href="#0411-users-and-groups" title="Permanent link">&para;</a></h5>
<p>我们可以通过查看 <strong><em>/etc/passwd</em></strong> 文件，来得到系统中用户的配置信息<br />
<img alt="alt text" src="../image-9.png" /><br />
这里除了很后面的lee用户（没截进去）之外，还有一个特殊的root用户 </p>
<blockquote>
<p><strong>根用户</strong><br />
之前加上的sudo可以让我们以根用户的身份安装软件（apt安装软件安装在系统目录下，必须要以root用户的身份去安装），/root用户在Linux系统中拥有最高的权限  </p>
<p><strong>系统用户</strong><br />
除了lee，root之外，还有很多剩下的用户，它们是由系统或相关程序创建，用于执行服务等系统任务。不要随意删除这些用户，以免系统运行出现问题  </p>
<p><strong>普通用户</strong><br />
普通用户可以登录系统，并对自己的家目录下的文件进行操作。所有普通用户的家目录都在/home/下，位于/home/username/的位置，其中username是用户名<br />
普通用户无法直接修改系统配置，也无法为系统环境安装或卸载软件  </p>
<p><strong>切换用户</strong><br />
sudo命令可以让你以另一个用户的身份执行指定的命令。当然，它最常见的用途，就是能让普通用户以root的身份执行命令：不加入其他参数，sudo 后面直接加命令；若要以其他用户的身份执行，只要加上“-u 用户名”就行了  </p>
</blockquote>
<p>关于su和sudo有一小段有趣的解释，具体可以看中科大文档  </p>
<blockquote>
<p><strong>用户组</strong><br />
用户组是用户的集合。通过用户组机制，可以为一批用户设置权限。可以使用 groups 命令，查看自己所属的用户组<br />
<img alt="alt text" src="../image-10.png" /><br />
可以看到，lee属于多个用户组。一般在用户创建时，都会创建与其名字相同的用户组  </p>
<p><strong>文件权限</strong><br />
在 Linux 中，每个文件和目录都有自己的权限。可以使用 ls -l 查看当前目录中文件的详细信息<br />
<img alt="alt text" src="../image-12.png" /><br />
第一列的字符串从左到右意义分别是：文件类型（一位）、文件所属用户的权限（三位）、文件所属用户组的权限（三位）、其他人的权限（三位）。对于每个权限，第一位 r 代表读取 (Read)，第二位 w 代表写入 (Write)，第三位 x 代表执行 (Execute)，- 代表没有对应的权限。
第三、四列为文件所属用户和用户组。</p>
<p><strong>文件系统层次结构</strong><br />
Linux 下文件系统的结构和 Windows 的很不一样。在 Windows 中，分区以盘符的形式来标识（如「C 盘」、「D 盘」），各个分区的分界线是很明确的。在系统所在的分区（一般为 C 盘）中，存储着程序文件 (Program Files)，系统运行需要的文件 (Windows)，用户文件 (Users) 等。这种组织形式源于 DOS 和早期的 Windows，并一直传承下来。<br />
而 UNIX 系列采用了一种不一样的思路组织文件：整个系统的文件都从 /（根目录）开始，像一棵树一样，类似于下图。<br />
<img alt="alt text" src="../image-11.png" /><br />
其他的分区以挂载 (mount) 的形式「挂」在了这棵树上，如图中的/mnt/windows_disk/<br />
部分关于文件系统层次结构的文档可以在中科大文档中查看  </p>
</blockquote>
<hr />
<h5 id="0412-environment-variables">0.4.1.2 Environment Variables<a class="headerlink" href="#0412-environment-variables" title="Permanent link">&para;</a></h5>
<p>参考文档：https://linuxize.com/post/how-to-set-and-list-environment-variables-in-linux/  </p>
<hr />
<h3 id="05-git">0.5 Git<a class="headerlink" href="#05-git" title="Permanent link">&para;</a></h3>
<hr />
<p>这里就是注册一个ZJU Git账号和添加一个SSH Key<br />
好巧不巧，之前正好弄过一个SSH Key，就刚好拿来用了，添加好之后测试一下连接成功<br />
<img alt="alt text" src="../image-13.png" />  </p>
<hr />
<h3 id="06-lab0-tasks">0.6 Lab0 Tasks<a class="headerlink" href="#06-lab0-tasks" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Task1.1<br />
hush result
<img alt="alt text" src="../image-39.png" />
Task2.1<br />
nano在中科大文档中有简单介绍：Nano 是在很多机器上自带的命令行文本编辑器，相比于 vim 和 emacs 来说，对新手更加友好，不需要提前记忆复杂的键位<br />
<strong><em>$ nano file.txt  # 使用 nano 编辑 file.txt 文件（如果没有则创建）</em></strong><br />
Nano 启动后，用户可以直接开始输入需要的内容，使用方向键移动光标。在终端最下方是 nano 的快捷键，^ 代表需要按下 Ctrl 键（例如，^X 就是需要同时按下 Ctrl + X）。在编辑完成后，按下 Ctrl + X，确认是否保存后即可。<br />
<img alt="alt text" src="../image-15.png" /></p>
<p>Task3.2<br />
<img alt="alt text" src="../image-8.png" />  </p>
<p>Task5.2<br />
<img alt="alt text" src="../image-13.png" />  </p>
</blockquote>
<h2 id="lab1">Lab1:简单集群搭建<a class="headerlink" href="#lab1" title="Permanent link">&para;</a></h2>
<p>这是第一次接触到计算机集群的概念：）<br />
本次实验，我们将使用四台虚拟机搭建一个简易的集群，并对该集群进行性能测试，最后提交测试结果和实验报告。  </p>
<blockquote>
<p>软件安装<br />
- [x] 下载OpenMPI、BLAS和HPL的源代码并编译安装<br />
集群搭建<br />
- [x] 克隆虚拟机
- [x] 配置虚拟机互联
- [x] 测试节点间通信
性能测试<br />
- [x] 在虚拟机集群上使用openMPI运行HPL性能测试，记录测试结果<br />
Bonus（选做）<br />
- [ ] 配置NFS并复现实验
- [ ] 使用Docker复现实验
- [ ] 使用Spack复现实验  </p>
</blockquote>
<hr />
<h3 id="11-linux-angband">1.1 从源码构建Linux应用-以Angband为例<a class="headerlink" href="#11-linux-angband" title="Permanent link">&para;</a></h3>
<p>在 Linux 生态中，源代码是最通用的软件分发形式。  </p>
<h4 id="111">1.1.1 软件包源码的组织方式<a class="headerlink" href="#111" title="Permanent link">&para;</a></h4>
<p>进入 Angband 的网站，点击 Source Code，下载最新的<em>源代码</em>压缩包并解压。
<strong><em>wget https://github.com/angband/angband/releases/download/4.2.5/Angband-4.2.5.tar.gz
tar xvf Angband-4.2.5.tar.gz
cd Angband-4.2.5
ls</em></strong>  </p>
<blockquote>
<p>开源软件包源码的目录结构
.
├── bin：存放软件包的可执行文件（binary）。
├── src：存放软件包的源代码文件（source）。
├── lib：存放软件包的库文件（libraries）。
├── docs：存放软件包的文档文件，可能包括用户手册、API文档等。
└── README.md：包含软件包的说明文档，通常包括软件包的简要介绍、安装指南和使用说明。  </p>
</blockquote>
<p>在README.md文件中，维护者描述了如何编译代码，在compile it yourself-&gt;Lnux-&gt;Native builds中可以找到构建Angband的命令：<br />
<strong><em>./configure --with-no-install
make</em></strong><br />
<img alt="alt text" src="../image-16.png" /><br />
运行后，遇到了错误：<br />
<img alt="alt text" src="../image-17.png" /><br />
这说明我们的虚拟机上没有安装C编译器。这里安装了gcc作为C编译器<br />
<strong><em>sudo apt update<br />
sudo apt install gcc</em></strong><br />
之后检查一下gcc的位置看有没有安装成功<br />
<img alt="alt text" src="../image-18.png" /><br />
再次运行，还是有问题<br />
<img alt="alt text" src="../image-19.png" /><br />
意思是我们还缺了一个用于自动化编译和构建程序的make工具，我们再安装一个build-seeential软件包，其中包含了全面的编译器和构建工具<br />
<strong><em>sudo apt update
sudo apt install build-essential</em></strong><br />
<img alt="alt text" src="../image-20.png" /><br />
这时候make就可以被正常找到了<br />
我们再尝试<br />
<strong><em>./configure --with-no-install 
make</em></strong><br />
<img alt="alt text" src="../image-21.png" /><br />
正确执行后，会在src目录下找到angband可执行文件。我们可以尝试运行：<br />
<img alt="alt text" src="../image-22.png" /><br />
P.S 这里其实还出现了找不到src/angband的问题，但重新下载一次居然就好了  </p>
<h4 id="112">1.1.2 令人头疼的依赖关系与数据库<a class="headerlink" href="#112" title="Permanent link">&para;</a></h4>
<p>工程开发是多文件编程：编译器将每个代码文件分别编译后，还需要将它们合在一起变成一个软件，<strong>合在一起的过程称为链接的过程</strong>。具体可以参看wk老师的智云 https://classroom.zju.edu.cn/livingroom？course_id=53613&amp;sub_id=1028201&amp;tenant_code=112<br />
链接分为静态链接和动态链接。静态链接是指在编译时将库文件的代码和程序代码合并在一起，生成一个完全独立的可执行文件。动态链接是指在程序运行时，加载库文件，从而节省存储空间，提高程序的复用性和灵活性。  </p>
<blockquote>
<p><strong>静态链接</strong>
如果你的程序与静态库链接，那么链接器会将静态库中的代码复制到你的程序中。这样，你的程序就不再依赖静态库了，可以在任何地方运行。但是，如果静态库中的代码发生了变化，你的程序并不会自动更新，你需要重新编译你的程序。<br />
在 Linux 系统上，静态库的文件名以 .a 结尾，比如 libm.a。在 Window 上，静态库的文件名以 .lib 结尾，比如 libm.lib。静态库可以使用 ar （archive program）工具创建。</p>
<p><strong>动态链接</strong><br />
当你的程序与动态库链接时，程序中创建了一个表。在程序运行前，操作系统将需要的外部函数的机器码加载到内存中，这就是动态链接过程。<br />
与静态链接相比，动态链接使程序文件更小，因为一个动态库可以被多个程序共享，节省磁盘空间。部分操作系统还允许动态库代码在内存中的共享，还能够节省内存。动态库升级时，也不需要重写编译你的程序。<br />
在 Linux 系统上，动态库的文件名以 .so 结尾，比如 libm.so。在 Window 上，动态库的文件名以 .dll 结尾，比如 libm.dll。  </p>
</blockquote>
<p>链接相关的问题可能出现在链接时（静态链接）、程序运行前和运行中（动态链接）。比如：未定义的应用、缺失.dll（缺少动态链接库）、缺失.so（Linux上的动态库）</p>
<hr />
<p>由于虚拟机之前没有安装过相关软件包，所以src/angband运行后没有出现游戏界面，而是直接退出了。同时，在./configure中也给出了warning<br />
<img alt="alt text" src="../image-23.png" /><br />
往上翻还会发现missing libraries<br />
<img alt="alt text" src="../image-24.png" /><br />
Angband 使用了 ncurses 库来实现游戏界面。但这个库不会被包含在 Angband 的源代码中，也没有默认包含在系统中，因此我们需要手动安装。 
通过网络搜索，我们得知 ncurses 库包含在 libncurses5-dev 软件包中，我们可以通过下面的命令安装它：<br />
<strong><em>sudo apt install libncurses5-dev</em></strong><br />
之后再次运行./configure就能识别到ncurses库了<br />
<img alt="alt text" src="../image-25.png" />
P.S 这里同样遇到了一些阻碍，刚下载完后运行./configure还是不能识别到ncurses库，关掉terminal重走一遍流程后又好了<br />
<img alt="alt text" src="../image-26.png" />  </p>
<p>至此我们解决了一个简单的依赖问题：Angband-&gt;ncurses。在HPC应用中，实际的依赖关系极其复杂，这时我们就将使用自动化工具和包管理器解决部分问题。  </p>
<h4 id="113">1.1.3 不怎么自动的自动化构建工具<a class="headerlink" href="#113" title="Permanent link">&para;</a></h4>
<p>./configure和make工具用于构建软件包，就是GNU Autotools构建系统中的一部分。关于自动化构建工具（Automated Build Tools）的简介可直接看lab文档，其主要功能包括  </p>
<blockquote>
<p>编译和链接
依赖管理
代码检查
单元测试
打包和部署  </p>
</blockquote>
<p>有趣的是Autotools往往能带来一堆问题，但又不得不用它提高效率<br />
<img alt="alt text" src="../why_autotools.png" />  </p>
<hr />
<p>lab文档中介绍了两种构建工具的使用方法  </p>
<h5 id="1131-gnu-autotools">1.1.3.1 GNU Autotools<a class="headerlink" href="#1131-gnu-autotools" title="Permanent link">&para;</a></h5>
<p>GNU Autotools的工作流程一般是：首先使用Autoconf生成configure脚本，然后用configure脚本生成Makefile文件，最后使用Makefile文件编译和链接源代码，生成可执行文件或库文件。写成命令就是：<br />
<strong><em>./configure
make
make install</em></strong><br />
流程中每个环节都可以定制，如图：<br />
<img alt="alt text" src="../gnu_autotools.png" /><br />
要如何修改这些文件，要阅读README和INSTALL等文件，有时也可以通过为这些命令添加参数来修改行为。  </p>
<h5 id="1132-cmake">1.1.3.2 CMake<a class="headerlink" href="#1132-cmake" title="Permanent link">&para;</a></h5>
<p>CMake 是一个更加现代化的开源的跨平台的构建工具。它使用一种类似于脚本的语言来描述构建过程，然后根据这个描述生成相应的构建文件。与 GNU Autotools 相比，它提供了更多的功能，与更多的现代软件如 IDE 实现了集成，因此在一些项目中取代了 Autotools。但编写 CMakeLists.txt 也比 Makefile 更为抽象，理解和使用难度也更大。它的首要优势是<em>跨平台</em>。<br />
<img alt="alt text" src="../CMakeGeneral_Diagram.jpg" /><br />
CMake 的另一大优势是<em>缓存</em>。CMake 会在第一次运行时生成一些缓存文件，这个文件记录了所有的配置信息，包括编译器、编译选项、依赖库等。这样，当你修改了源代码后，只需要重新运行 CMake，它就会根据缓存文件重新生成构建文件，而不需要重新进行检查、配置和生成。对于大型项目的增量开发和构建来说，这极大地节约了时间。<br />
CMake 的工作流程一般是：首先编写 CMakeLists.txt 文件，描述项目的目录结构、源代码文件、依赖库等信息，然后使用 CMake 工具生成构建文件，最后使用构建工具（如 make、ninja 等）编译和链接源代码，生成可执行文件或库文件。对应的命令如下：
<strong><em>cmake -B build
cmake --build build</em></strong></p>
<h3 id="12-openmpihpl">1.2 任务一：从源码构建OpenMPI和HPL<a class="headerlink" href="#12-openmpihpl" title="Permanent link">&para;</a></h3>
<p>对于过程中需要修改Makefile的步骤，需要了解基本的Makefile语法，参考https://www.bilibili.com/video/BV188411L7d2/  </p>
<h4 id="121-makefile">1.2.1 Makefile基本语法<a class="headerlink" href="#121-makefile" title="Permanent link">&para;</a></h4>
<p>有这样几个文件，要将它们综合起来工作，可以有以下几种办法：<br />
<img alt="alt text" src="../image-45.png" />  </p>
<blockquote>
<p>version 0  </p>
</blockquote>
<p>直接在terminal中编译<br />
<strong><em>g++ main.cpp factorial.cpp printfhello.cpp -o main</em></strong><br />
运行<br />
<strong><em>./main</em></strong><br />
上述行为也可以拆成三个步骤：
<strong><em>g++ main.cpp -c</em></strong>
<strong><em>g++ factorial.cpp -c</em></strong>
<strong><em>g++ printfhello.cpp -c</em></strong> 
生成三个.o文件<br />
<em>*</em>g++ <em>.o -o mian</em>**<br />
把三个文件链在一起生成一个.0文件<br />
这样做可以单独编译发生变化的文件，缩短编译时间  </p>
<blockquote>
<p>version 1  </p>
</blockquote>
<p><strong><em>hello:main.cpp printfhello.cpp factorial.cpp<br />
    g++ -o hello main.cpp printfhello.cpp factorial.cpp</em></strong><br />
目标是生成一个名叫hello的可执行程序，hello的生成是依赖于后面三个文件的；使用g++这个命令去实现这个目标<br />
这句话被写在Makefile文件中，当执行make (-f Makefile) 时，就会去找Makefile文件，然后执行  </p>
<blockquote>
<p>version 2  </p>
</blockquote>
<p><strong><em>CXX=g++
TARGET=hello
OBJ=main.o prinfhello.o factorial.o</em></strong>  </p>
<p><strong><em><span class="arithmatex">\((TARGET):\)</span>(OBJ)<br />
    $(CXX) -o $(TARGET) $(OBJ)</em></strong>  </p>
<p><strong><em>main.o:main.cpp<br />
    $(CXX) -c main.cpp</em></strong>  </p>
<p><strong><em>prinfhello.o:printfhello.cpp
    $(CXX) -c printfhello.cpp</em></strong>    </p>
<p><strong><em>fctorial.o:factorial.cpp
    $(CXX) -c<br />
    factorial.cpp</em></strong><br />
P.S 这里的格式有问题,具体直接看视频<br />
实际就是把version 1中的语言变得更正式  </p>
<blockquote>
<p>version 3  </p>
</blockquote>
<p>在version 2基础上加一个<strong><em>CXXFLAGS = -c -Wall</em></strong><br />
简化成：<br />
<strong><em>%.o:%.cpp<br />
    $(CXX) $(CXXFLAGS) $&lt; -o %@</em></strong><br />
实际就是更加抽象化了，具体还是看视频  </p>
<blockquote>
<p>version 4  </p>
</blockquote>
<p>再加一个<strong><em>SRC=%(wildcard * .cpp)</em></strong><br />
就不用再列出cpp文件了，直接把当前目录下所有cpp文件拉进来了</p>
<h4 id="122-tasks">1.2.2 Tasks<a class="headerlink" href="#122-tasks" title="Permanent link">&para;</a></h4>
<p>这几个项目的依赖关系：<br />
<img alt="alt text" src="../image-28.png" />  </p>
<hr />
<blockquote>
<p>构建并安装OpenMPI  </p>
</blockquote>
<p>step1：前往OpenMPI官网下载最新版本源码<br />
<strong><em>wget "https://download.open-mpi.org/release/open-mpi/v5.0/openmpi-5.0.3.tar.gz"
tar xvf openmpi-5.0.3.tar.gz
cd openmpi-5.0.3</em></strong> 
<img alt="alt text" src="../image-29.png" /><br />
step2：解压源码<br />
<strong><em>./configure #不带参数，将默认安装到/usr/local/下，此时不需要修改PATH和LD_LIBRARAY_PATH等</em></strong><br />
<img alt="alt text" src="../image-31.png" />
step3：构建并安装OpenMPI
<strong><em>make
sudo make install #安装到系统目录 /usr/local 需要root权限</em></strong><br />
这里出现了一个很尴尬的事情：报错说内存满了<br />
<img alt="alt text" src="../image-32.png" /><br />
检查一下报错的/tmp中的内存使用<br />
<strong><em>df -h /tmp</em></strong><br />
<img alt="alt text" src="../image-33.png" /><br />
确实是满了<br />
思考了一下，由于正好是Lab1，加上之前用ubuntu的时候就打算先试一试（The very beginning），所以就重新开一个VM   </p>
<hr />
<p>这一次我们从ZJU Mirrors上下载Debian ISO，然后正好补一下之前lab0中Task1的坑<br />
ZJU Mirror(极其简陋):
https://mirrors.zju.edu.cn/debian-cd/<br />
Your guide to Debian iso downloads:
https://github.com/slowpeek/debian-iso-guide<br />
这里我选择的是<br />
<img alt="alt text" src="../image-34.png" /><br />
给的硬件配置<br />
<img alt="alt text" src="../image-36.png" /><br />
选择的是英文。在lab文档中有一句明确的提示： 
<strong>Don't set a root password. Read the text on the screen carefully.</strong> </p>
<blockquote>
<p>If you leave this empty, the root account will be disabled and the system's initial user will be given the power to become root using the sudo command  </p>
</blockquote>
<p><strong>So, if you set a root password, you will need to add yourself to the sudo group later manually.</strong><br />
所以没有设置root passward<br />
按照lab文档做<br />
<img alt="alt text" src="../image-37.png" /><br />
<img alt="alt text" src="../image-38.png" />
虽然lab文档的意思好像只要SSH server and standard system utilities，但我根本没有这个选项，最后装出来的还是有桌面的虚拟机，时间紧迫，先凑合着用吧  </p>
<hr />
<p>重新下载一下build-essential，重复上面安装OpenMPI的流程<br />
<img alt="alt text" src="../image-40.png" />
等了大概几百年之后make完了<br />
<img alt="alt text" src="../image-43.png" /><br />
至此回到之前的步骤 
step4：<br />
<strong><em>sudo ldconfig # 更新动态链接库缓存</em></strong><br />
至于为什么要加这一步，可以参考https://lists.nongnu.org/archive/html/libtool/2014-05/msg00021.html<br />
step5：最后确认一下安装信息<br />
<strong><em>ompi_info --all # 查看安装信息</em></strong>
<img alt="alt text" src="../image-44.png" />
安装完成</p>
<blockquote>
<p>构建并安装BLAS  </p>
</blockquote>
<p><strong><em>wget "http://www.netlib.org/blas/blas-3.12.0.tgz"
tar xvf blas-3.12.0.tgz
cd BLAS-3.12.0
make</em></strong><br />
前三句话没有问题，但make的时候会报错：<br />
<img alt="alt text" src="../image-41.png" /><br />
提示缺少了gfortran，需要下载<br />
<strong><em>sudo apt install gfortran</em></strong><br />
之后就可以执行make了<br />
<img alt="alt text" src="../image-42.png" />  </p>
<blockquote>
<p>构建并安装HPL  </p>
</blockquote>
<p>step1
<strong><em>wget "https://netlib.org/benchmark/hpl/hpl-2.3.tar.gz"
tar xvf hpl-2.3.tar.gz
cd hpl-2.3</em></strong></p>
<p>step2
<strong><em>cp setup/Make.Linux_PII_FBLAS .</em></strong><br />
这一指令把Make Linux_PII_FBLAS文件复制到执行命令时所在的目录  </p>
<blockquote>
<p><strong>Make.Linux_PII_FBLAS文件</strong>是一个Makefile模板文件，主要用于在Linux系统下，针对特定硬件平台（如PII处理器）和线性代数库（如FBLAS，即Fortran版本的BLAS）配置HPL（High-Performance Linpack）的编译过程。这个文件包含了编译HPL所需的一系列配置指令和变量定义，如编译器选项、库文件路径、头文件路径等。  </p>
</blockquote>
<p>step3<br />
<strong>vim Make.Linux_PII_FBLAS # 修改 Makefile</strong><br />
没有vim就装一个<br />
Vim 是一种高度可配置的文本编辑器，用于有效地创建和更改任何类型的文本。<br />
<img alt="alt text" src="../image-46.png" /><br />
这里我们要对Makefile文件做一些修改，向下移动光标可以找到需要修改的部分<br />
<img alt="alt text" src="../image-47.png" /><br />
左边是修改后，右边是修改前<br />
这里用vim修改有特定的方式，具体如下：<br />
<img alt="alt text" src="../image-48.png" /><br />
<img alt="alt text" src="../image-49.png" /><br />
<strong><em>make arch=Linux_PII_FBLAS</em></strong><br />
在Makefile中指定arch=Linux_PII_FBLAS这样的目标架构<br />
这里报两个错：<br />
<img alt="alt text" src="../image-50.png" /><br />
经过了长时间的调试，始终没有解决这个该死的error，尝试别的途径。。。<br />
发现其他实验者用的都是CBLAS，应该CBLAS中有可以替代该死的libmpich.so的库，试试吧  </p>
<blockquote>
<p>构建并安装CBLAS  </p>
</blockquote>
<p><strong><em>wget http://www.netlib.org/blas/blast-forum/cblas.tgz<br />
tar -zxvf cblas.tgz</em></strong>  </p>
<p>太痛苦了  </p>
<hr />
<p>上面都是非常痛苦的尝试，最后我决定重装一台ubuntu <br />
<img alt="alt text" src="../image-51.png" /><br />
之后交叉参考了三篇文章<br />
https://www.cnblogs.com/Vocanda/p/17436434.html<br />
https://github.com/ForeverHYX/hpl101-su24/blob/master/Report/HPC_Lab1_Report.pdf<br />
https://rzm0572.github.io/Computer-Science/HPC/HPC101-Lab1-Report/</p>
<blockquote>
<p>BLAS&amp;CBLAS part  </p>
</blockquote>
<p><strong><em>wget "http://www.netlib.org/blas/blas-3.12.0.tgz"<br />
tar xvf blas-3.12.0.tgz<br />
cd BLAS-3.12.0 <br />
make</em></strong><br />
最后将刚下载到的库文件复制到系统库文件
<strong><em>cp blas_LINUX.a /usr/local/lib/libblas.a</em></strong><br />
(这里报了permission denied所以最后使用sudo的)<br />
<img alt="alt text" src="../image-52.png" /><br />
<img alt="alt text" src="../image-56.png" /><br />
接着安装CBLAS<br />
<strong><em>wget http://www.netlib.org/blas/blast-forum/cblas.tgz
tar -xvf cblas.tgz</em></strong><br />
接下来我们要编译CBLAS文件，得到cblas_LINUX.a<br />
打开Makefile.in，可以看到<br />
<img alt="alt text" src="../image-57.png" /><br />
我们需要指定BLAS库的路径，刚刚我们已经把blas_LINUX.a复制到了系统库文件，修改路径如下<br />
<img alt="alt text" src="../image-58.png" /><br />
接着去make<br />
<img alt="alt text" src="../image-59.png" /><br />
中间有几条warning，但没有error<br />
<img alt="alt text" src="../image-60.png" /><br />
成功在 /CBLAS/lib中生成了cblas_LINUX.a<br />
把它也复制到/usr/local/lib/libcblas.a<br />
<del><strong><em>sudo cp cblas_LINUX.a /usr/local/lib/libblas.a</em></strong></del><br />
sudo cp cblas_LINUX.a /usr/local/lib/libcblas.a
至此，BLAS也配置好了</p>
<blockquote>
<p>OpenMPI part  </p>
</blockquote>
<p>值得一提的是，OpenMPI居然是有官方文档的，而我居然全程没找到过。。。<br />
https://docs.open-mpi.org/en/main/index.html</p>
<p><strong><em>wget "https://download.open-mpi.org/release/open-mpi/v5.0/openmpi-5.0.3.tar.gz"
tar xvf openmpi-5.0.3.tar.gz
cd openmpi-5.0.3</em></strong><br />
<img alt="alt text" src="../image-53.png" /><br />
下载好后把它安装在特定路径<br />
<strong><em>./configure --prefix=/usr/local/openMPI</em></strong><br />
<strong><em>make
sudo make install</em></strong><br />
漫长的等待后安装完成，之后需要修改PATH和LD_LIBRARY_PATH(之后讲MPI的时候会提到)，我使用nano打开修改的<br />
<strong><em>nano ~/.bashrc</em></strong><br />
<img alt="alt text" src="../image-54.png" /><br />
在 .bashrc的最上面配置环境变量<br />
<img alt="alt text" src="../image-55.png" /><br />
最后运行一下使修改生效<br />
<strong><em>source ~/.bashrc</em></strong><br />
至此，OpenMPI配置完成  </p>
<blockquote>
<p>HPL part  </p>
</blockquote>
<p><strong><em>wget https://netlib.org/benchmark/hpl/hpl-2.3.tar.gz
tar -xvf hpl-2.3.tar.gz
cd hpl-2.3</em></strong><br />
为HPL构建提供一个合适的Makefile文件<br />
<strong><em>cp setup/Make.Linux_PII_CBLAS ./Make.Linux_PII</em></strong><br />
对这个Make.Linuc_PII文件进行修改<br />
修改如下：<br />
ARCH         = Linux_PII_CBLAS -&gt; Linux_PII  </p>
<p>TOPdir       = $(HOME)/hpl-2.3 -&gt; /home/lee/hpl-2.3  </p>
<p>MPdir        = /usr/local/mpi -&gt; /usr/local/openmpi  </p>
<p>MPinc        = -I$(MPdir)/include</p>
<p>MPlib        = $(MPdir)/lib/libmpich.a -&gt; $(MPdir)/lib/libmpi.so  </p>
<p>LAdir        = $(HOME)/netlib/ARCHIVES/Linux_PII -&gt; /home/lee/CBLAS  </p>
<p>LAinc        =</p>
<p>LAlib        = $(LAdir)/libcblas.a $(LAdir)/libatlas.a -&gt; /usr/local/lib/libcblas.a /usr/local/lib/libblas.a -lgfortran</p>
<p>CC           = /usr/bin/gcc -&gt; /usr/local/openMPI/bin/mpicc</p>
<p>LINKER       = $(CC)</p>
<p><img alt="alt text" src="../image-61.png" /></p>
<p>修改完成后，根据刚才修改的Makefile去make<br />
<strong><em>make arch=Linux_PII</em></strong><br />
这里报了error，发现一个巨大的错误，之前<br />
<img alt="alt text" src="../image-62.png" /><br />
应该生成libcblas的，结果把原来的libblas.a给覆盖掉了。。。<img alt="alt text" src="../image-63.png" /><br />
紧急返工，把原来的给重命名成libcblas.a，再复制一次libblas.a<br />
<img alt="alt text" src="../image-64.png" /><br />
希望这次可以！<br />
<img alt="alt text" src="../image-65.png" /><br />
找到了/hpl-2.3/bin/Linux_PII目录下的可执行文件xhpl，我承认这一刻我是有点激动的qwq<br />
至此，软件安装部分完成  </p>
<hr />
<h3 id="13">1.3 集群环境搭建与配置<a class="headerlink" href="#13" title="Permanent link">&para;</a></h3>
<h4 id="131">1.3.1 集群节点间的连接与互访<a class="headerlink" href="#131" title="Permanent link">&para;</a></h4>
<h5 id="1311">1.3.1.1 网络基础<a class="headerlink" href="#1311" title="Permanent link">&para;</a></h5>
<p>在Lab0中我们已经了解过了关于MAC地址、IP地址和ARP协议的知识，这里再借助gpt回顾一下  </p>
<blockquote>
<p><strong>IP地址</strong><br />
IP地址（Internet Protocol Address）是互联网协议地址，用于在互联网上唯一标识一个设备。它采用一种分层次的地址结构，由网络号和主机号两部分组成。IPv4是目前广泛使用的版本，它由32位二进制数组成，通常以点分十进制（如192.168.1.1）的形式表示。由于IPv4地址空间有限，已经逐渐被IPv6所取代，IPv6使用128位二进制数表示地址，极大地扩展了地址空间。  </p>
<p><strong>MAC地址</strong><br />
MAC地址（Media Access Control Address）是媒体访问控制地址，也称为物理地址或硬件地址。它用于在网络中唯一标识一个网络接口控制器（NIC），即网络适配器或网络接口卡（NIC）的硬件地址。MAC地址通常被固化在网卡的ROM中，是网络设备出厂时就分配好的，全球唯一。MAC地址的长度为48位（6字节），通常表示为12个十六进制数，如00-1A-2B-3C-4D-5E。  </p>
<p><strong>ARP协议</strong><br />
ARP（Address Resolution Protocol）地址解析协议是一种网络层协议，用于将网络层（IP层）地址解析为链路层（数据链路层）地址，即IP地址到MAC地址的映射。在网络通信中，数据链路层协议（如以太网）通过MAC地址来识别网络上的设备，而网络层协议（如IP）则通过IP地址来识别设备。因此，当一台设备想要向另一台设备发送数据时，它必须知道对方的MAC地址。ARP协议就是用来完成这一映射过程的。
ARP协议的工作流程大致如下：
1、请求过程：当一台设备想要发送数据给另一台设备时，它首先检查自己的ARP缓存表中是否有目标IP地址对应的MAC地址。如果没有，该设备会广播一个ARP请求，询问哪台设备拥有该IP地址。
2、响应过程：拥有该IP地址的设备会收到ARP请求，并发送一个ARP响应，其中包含自己的MAC地址。
3、更新缓存：请求设备收到ARP响应后，会将目标IP地址和对应的MAC地址存入自己的ARP缓存表中，并使用这个MAC地址发送数据。
通过这种方式，ARP协议实现了IP地址到MAC地址的动态映射，确保了数据在网络中的正确传输。  </p>
</blockquote>
<h5 id="1312">1.3.1.2 计算机集群概念<a class="headerlink" href="#1312" title="Permanent link">&para;</a></h5>
<p><strong>计算机集群(Cluster)</strong> 是连接在一起、协同工作的一组计算机，集群中的每个计算机都是一个节点。在集群中，由软件将不同的计算任务（task）分配（schedule）到相应的一个或一群节点（node）上。通常会有一个节点作为主节点（master/root node），其他节点作为从节点（slave node）。主节点负责调度任务（当然也可能负责执行部分任务），从节点负责执行任务。此外，也通常会有一个共享的文件系统，用于存储任务数据和结果。<br />
<img alt="alt text" src="../cluster.png" />    </p>
<h5 id="1313-ssh">1.3.1.3 SSH的密钥认证<a class="headerlink" href="#1313-ssh" title="Permanent link">&para;</a></h5>
<p>在Lab0中，我们已经学习了如何通过 SSH 使用密码访问虚拟机。在集群中，节点之间的互访往往也通过 SSH 完成，但要求无交互（non-interactive），这就需要使用 SSH 的密钥认证（key-based authentication）。  </p>
<blockquote>
<p>SSH密钥的认证原理  </p>
</blockquote>
<p>SSH 密钥认证基于密码学中的非对称加密算法。在 SSH 密钥认证中，用户有两个密钥：私钥（private key）和公钥（public key），它们一一配对。私钥只有用户自己知道，公钥可以公开。私钥能够加密数据，公钥能够解密数据。用户可以将公钥放在服务器上，当用户连接服务器时，服务器会用公钥加密一个随机数发送给用户，用户用私钥加密这个随机数，然后用这个随机数加密数据发送给服务器，服务器用公钥解密数据。如果用户能够成功加密，说明用户拥有私钥，连接成功。简单了解非对称加密算法可以看这个视频<br />
https://www.bilibili.com/video/BV1XP4y1A7Ui/?spm_id_from=333.337.search-card.all.click&amp;vd_source=5742e02a7566918d65a441adce5bc163<br />
<img alt="alt text" src="../ssh-1.png" /><br />
所谓配置 SSH 密钥认证，就是让服务器信任该公钥，允许持有该私钥的用户连接。在集群中，我们需要在主节点中生成密钥对，将主节点的公钥放在从节点上，这样主节点就能够通过 SSH 密钥认证连接到从节点。<br />
可以阅读How To Configure SSH Key-Based Authentication on a Linux Server - DigitalOcean https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server 了解如何配置 SSH 密钥认证。<br />
基本操作是<br />
<strong><em>ssh-keygen -t ed25519 # 生成密钥对，使用 ed25519 算法
ssh-copy-id user@hostname # 将公钥放在服务器上</em></strong><br />
其实课上连接zju clusters就是类似的操作<br />
<img alt="alt text" src="../image-68.png" /><br />
需要注意的是，认证基于用户。不是说主节点可以连接到从节点，而应当说主节点上的某个用户可以连接到从节点上的某个用户。如果在主节点上为 root 用户生成密钥对，却在从节点上将公钥放置进 test 用户的 .ssh/authorized_keys 文件中，那么显然无法以密钥认证的方式登录到从节点的 root 用户。  </p>
<hr />
<h4 id="132-mpi">1.3.2 MPI的运行方式<a class="headerlink" href="#132-mpi" title="Permanent link">&para;</a></h4>
<p>OpenMPI 是一个开源的 Message Passing Interface 实现。MPI 是一套标准化、可移植的消息传递标准，它被设计用于支持并行计算系统的架构，使得开发者能够方便地开发可移植的消息传递程序。<br />
<strong><em>mpirun</em></strong>是 OpenMPI 提供的 MPI 启动程序，负责在指定的节点上启动 MPI 程序，此后程序间的通信由 MPI 库负责。可以为 mpirun 指定参数，比如启动的进程数、启动的节点等。关于mpirun参考 https://docs.open-mpi.org/en/main/launching-apps/quickstart.html 和 https://docs.open-mpi.org/en/main/launching-apps/ssh.html ,这里只记录最关键部分  </p>
<h5 id="1321-quick-start-launching-mpi-applications">1.3.2.1 Quick start: Launching MPI applications<a class="headerlink" href="#1321-quick-start-launching-mpi-applications" title="Permanent link">&para;</a></h5>
<blockquote>
<p>Launching on a single host  </p>
</blockquote>
<p>In such simple “single program, multiple data (SPMD)” cases, use <strong><em>mpirun</em></strong> and specify how many MPI processes you want to launch via the -n option:<br />
在/openmpi-5.0.3/examples中执行<strong><em>mpirun -n 2 hello_c</em></strong><br />
实际上，可能是因为虚拟机设置的时候只设置了2核，这里只能有2个MPI processes，再增加会报错<br />
<img alt="alt text" src="../image-69.png" /><br />
只用两个是可以的<br />
<img alt="alt text" src="../image-70.png" />  </p>
<p>这一点其实在 https://github.com/ForeverHYX/hpl101-su24/blob/master/Report/HPC_Lab1_Report.pdf 的OpenMPI检验中体现了</p>
<blockquote>
<p>Launching in a non-scheduled environments (via <strong>ssh</strong>)  </p>
</blockquote>
<p>In general, Open MPI requires the following to launch and run MPI applications:
1、You must be able to login to remote nodes non-interactively (e.g., without entering a password or passphrase).通过SSH来实现<br />
2、Open MPI’s executables must be findable (e.g., in your PATH).<br />
3、Open MPI’s libraries must be findable (e.g., in your LD_LIBRARY_PATH).</p>
<p>mpirun accepts a --hostfile option (and its synonym, the --machinefile option) to specify a hostfile containing one hostname per line:
<strong><em>shell$ cat my-hostfile.txt
node1.example.com
node2.example.com
node3.example.com slots=2
node4.example.com slots=10</em></strong>  </p>
<p><strong><em>mpirun</em></strong>接受一个 <strong>--hostfile</strong> 选项。这个选项允许用户指定一个文件，该文件列出了运行MPI作业所需的各个主机（或节点）的名称和每个主机上可用的进程数（即slots或cores）。这对于在分布式计算环境中管理MPI作业特别有用，因为它允许用户精确控制作业在哪个主机上运行以及在这些主机上分配多少资源。</p>
<p><strong>--hostfile</strong> 选项后面跟随的是包含主机信息的文件的路径。这个文件通常包含每行一个条目的列表，每个条目指定了一个主机名和可选的slots数（如果不指定，则使用默认值）</p>
<p>这一点其实在 https://rzm0572.github.io/Computer-Science/HPC/HPC101-Lab1-Report/ 中体现了，用于检验OpenMPI能否正常工作  </p>
<p>The optional slots attribute tells Open MPI the maximum number of processes that can be allocated to that node. If slots is not provided, Open MPI — by default — uses the number of processor cores (not hyperthreads) on that node.  </p>
<p>所以在刚才的例子中，输出应该是：<br />
<strong><em>shell$ mpirun --hostfile my-hostfile.txt mpi-hello-world
Hello world, I am 0 of 44 (running on node1.example.com)
Hello world, I am 1 of 44 (running on node1.example.com)
...
Hello world, I am 15 of 44 (running on node1.example.com)
Hello world, I am 16 of 44 (running on node2.example.com)
Hello world, I am 17 of 44 (running on node2.example.com)
...
Hello world, I am 31 of 44 (running on node2.example.com)
Hello world, I am 32 of 44 (running on node3.example.com)
Hello world, I am 33 of 44 (running on node3.example.com)
Hello world, I am 34 of 44 (running on node4.example.com)
...
Hello world, I am 43 of 44 (running on node4.example.com)</em></strong><br />
各个node使用情况应该是：
node1: 16, because no slots was specified
node2: 16, because no slots was specified
node3: 2, because slots=2 was specified
node2: 10, because slots=10 was specified</p>
<blockquote>
<p>Launching in scheduled environments<br />
（略）  </p>
<p>Using the scheduler to “direct launch” (without mpirun(1))
（略）  </p>
</blockquote>
<h5 id="1322-launching-with-ssh">1.3.2.2 Launching with SSH<a class="headerlink" href="#1322-launching-with-ssh" title="Permanent link">&para;</a></h5>
<p>When launching Open MPI jobs in a non-scheduled environment, ssh is typically used to launch commands on remote nodes. <br />
其要求就是Launching in a non-scheduled environments (via ssh)中列出的要求  </p>
<p>There are three mechanisms for specifying the hosts that an MPI job will run on：<br />
1、The <strong>--hostfile</strong> option to mpirun.<br />
2、The <strong>--host</strong> option to mpirun.<br />
3、Running in a scheduled environment.  </p>
<blockquote>
<p>The specification of hosts using any of the above methods has nothing to do with the network interfaces that are used for MPI traffic. The list of hosts is only used for specifying which hosts on which to launch MPI processes.  </p>
</blockquote>
<p>If you have a shared $HOME filesystem between your nodes, you can setup a single SSH key that is used to login to all nodes.  </p>
<blockquote>
<p>Non-interactive ssh logins  </p>
</blockquote>
<p>SSH keys must be setup such that the following can be executed without being prompted for password or passphrase<br />
简单来说文档里让你自己去搜。。。  </p>
<blockquote>
<p>Finding Open MPI executables and libraries  </p>
</blockquote>
<p>Once Open MPI is able to use ssh to invoke executables on a remote node, it must be able to find its helper executables and shared libraries on that remote node.</p>
<p>If Open MPI is installed in a system-level folder (e.g., in /usr/bin), Open MPI will likely be able to find its executables and libraries on the remote node with no additional assistance.</p>
<p>If, however, Open MPI is installed into a path that is not searched by default, you will need to <strong>provide assistance so that Open MPI can find its executables and libraries</strong>.  </p>
<p>For simplicity, it is strongly recommended that you install Open MPI in the same location on all nodes in your job.   </p>
<p><strong>Use “prefix” behavior</strong><br />
When “prefix” behavior is enabled, Open MPI will automatically set the $PATH and $LD_LIBRARY_PATH on remote nodes before executing remote commands.(这里格式有问题)<br />
文档里介绍了三种enable perfix的办法  </p>
<p><strong>Set the PATH and LD_LIBRARY_PATH in your shell startup files</strong><br />
讲道理没咋看懂，详见文档 https://docs.open-mpi.org/en/main/launching-apps/ssh.html  </p>
<p>总结一下：使用 mpirun 在集群中运行 MPI 程序，可以指定节点、进程数和工作路径等。</p>
<hr />
<h4 id="133-benchmark">1.3.3 性能测试Benchmark<a class="headerlink" href="#133-benchmark" title="Permanent link">&para;</a></h4>
<p><strong>HPL（high performance Linpack）</strong> 是评测计算系统性能的程序，是早期 Linpack 评测程序的并行版本，支持大规模并行超级计算系统。其报告的每秒浮点运算次数（floating-point operations per second，简称 FLOPS）是世界超级计算机 Top500 列表排名的依据。<br />
<strong>BLAS</strong> 是 Basic Linear Algebra Subprograms 的缩写，是一组用于实现基本线性代数运算的函数库。HPL 使用 BLAS 库来实现矩阵运算，因此需要 BLAS 库的支持。  </p>
<p>文档里有关于HPL的数学原理，云里雾里的浏览了一下，过了  </p>
<p>总结起来就是：HPL 通过求解线性系统来评估计算机集群的浮点性能  </p>
<hr />
<h3 id="14-hpl">1.4 使用 HPL 测试虚拟机集群的性能<a class="headerlink" href="#14-hpl" title="Permanent link">&para;</a></h3>
<h4 id="141">1.4.1 连接与互访<a class="headerlink" href="#141" title="Permanent link">&para;</a></h4>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> 克隆虚拟机并将他们连接互访</li>
</ul>
<blockquote>
<p>用VMware Workstation克隆虚拟机，命名为node01，node02，node03，node04。  </p>
</blockquote>
<p><strong>选择完整克隆</strong><br />
<img alt="alt text" src="../image-71.png" />
<strong>注意，不只是在 Hypervisor 中修改名字，还需要在虚拟机中修改 /etc/hostname</strong><br />
我们可以用
<strong><em>sudo nano /etc/hostname</em></strong>来修改名称<br />
之后重启
<strong><em>reboot</em></strong>  </p>
<blockquote>
<p>查看各台虚拟机的ip地址：<br />
<strong><em>ip addr</em></strong><br />
node01：192.168.75.133<br />
node02：192.168.75.137<br />
node03：192.168.75.138<br />
node04：192.168.75.139  </p>
<p>获取之后在node01（The One）中修改 /etc/hosts 文件，添加其他节点的IP地址。  </p>
</blockquote>
<p><strong><em>sudo vim /etc/hosts</em></strong><br />
这里不是太清楚怎么修改hosts，文档讲的也不太清楚，先做一个尝试<br />
<img alt="alt text" src="../image-72.png" />  </p>
<blockquote>
<p>在 node01 中生成密钥对，将公钥放在其他节点上。  </p>
</blockquote>
<p><strong><em>ssh-keygen # 注意不需要为密钥设置密码，全程回车即可</em></strong><br />
<img alt="alt text" src="../image-73.png" />  </p>
<blockquote>
<p>将公钥放在其他节点上  </p>
</blockquote>
<p><strong><em>ssh-copy-id user@hostname # 这其实与之前登录ZJU m600时把公钥copy到authorized中是等价的操作</em></strong><br />
这里尝试的时候报了一个小错误<br />
<img alt="alt text" src="../image-74.png" /><br />
尴尬的是由于是重装的一台ubuntu，没有下载openssh-server<br />
注意要在每一台VM上装openssh-server<br />
<strong><em>sudo apt update
sudo apt install openssh-server</em></strong><br />
之后再尝试就可以了<br />
<img alt="alt text" src="../image-75.png" />  <br />
根据文档 https://www.cnblogs.com/Vocanda/p/17436434.html ，我还安装了openssh-client</p>
<blockquote>
<p>验证 SSH 密钥认证是否成功  </p>
</blockquote>
<p><strong><em>ssh user@hostname</em></strong><br />
<img alt="alt text" src="../image-76.png" /><br />
连接成功，注意看红框部分，说明我以lee的身份连接到了名为node02的远程主机，并进入了node02的shell环境<br />
同样的步骤对剩下两台执行<br />
P.S. exit命令可以退出连接；连接时必须得开机  <br />
<img alt="alt text" src="../image-77.png" />  </p>
<hr />
<h4 id="142-mpi">1.4.2 测试MPI正常运行<a class="headerlink" href="#142-mpi" title="Permanent link">&para;</a></h4>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> MPI通过测试可以正常运行<blockquote>
<p>在node01上写一个hostfile，指定节点和进程数  </p>
</blockquote>
</li>
</ul>
<p>直接新建就好，这里我建在了/home/Documents中<br />
<strong><em>vim /home/Documents/hostfile</em></strong><br />
当初的core设置的太少了，分配的slot如下<br />
<img alt="alt text" src="../image-78.png" /><br />
不知道为什么保存到了home里面，cp了一下  </p>
<blockquote>
<p>使用该 hostfile 执行 mpirun，在所有节点上运行 uptime 或 cat /etc/hostname  </p>
</blockquote>
<p><strong><em>mpirun --hostfile hostfile cat /etc/hostname</em></strong><br />
<img alt="alt text" src="../image-79.png" /><br />
P.S. 想到自己电脑上运行着一个集群，虽然菜鸡，也是有些兴奋的~  </p>
<h4 id="143-hpl">1.4.3 运行HPL<a class="headerlink" href="#143-hpl" title="Permanent link">&para;</a></h4>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> 成功运行HPL跑出结果
终于到了激动人心的部分  <blockquote>
<p>使用 mpirun 在所有节点上运行 xhpl，查看运行结果  </p>
</blockquote>
</li>
</ul>
<p><strong>切换工作目录到 HPL 所在目录，xhpl 需要在工作目录下找到 HPL.dat</strong><br />
<strong><em>cd /hpc-2.3/bin/Linux_PII</em></strong><br />
切换路径到之前找到xphl可执行文件的地方，运行<br />
<strong><em>mpirun --hostfile /home/lee/Documents/hostfile ./xhpl</em></strong><br />
<img alt="alt text" src="../image-80.png" /><br />
铛铛！金色传说！<br />
<img alt="alt text" src="../image-81.png" /><br />
<strong>至此算是结束了lab1的大部分工作</strong>  </p>
<hr />
<p>由于我的进度其实大大落后于别人，而技术杂谈这部分内容在lab文档也没有详细阐述，所以只打一个框架在这里，等待之后填坑</p>
<h3 id="15">1.5 技术杂谈<a class="headerlink" href="#15" title="Permanent link">&para;</a></h3>
<h4 id="151">1.5.1 包管理器<a class="headerlink" href="#151" title="Permanent link">&para;</a></h4>
<h4 id="152-docker">1.5.2 Docker<a class="headerlink" href="#152-docker" title="Permanent link">&para;</a></h4>
<h4 id="153-nfs">1.5.3 NFS<a class="headerlink" href="#153-nfs" title="Permanent link">&para;</a></h4>
<hr />
<p>P.S. 之前都没有用程序块（主要是markdown还不太熟），之后会用der</p>
<p>最后贴几个lab文档中提到的资料，还是要感激cs真的是一门很推崇开源的学科<br />
https://linux.cn/article-14033-1.html<br />
https://www.lrde.epita.fr/~adl/autotools.html<br />
https://elinux.org/images/4/43/Petazzoni.pdf<br />
https://kns.cnki.net/kcms2/article/abstract?v=qwZretP9BaHvUBwZiPjDpzt_KPtU2PXJSK0YVwCUYeCUQFlgxSAJKvStsXKUQgi7vp0dzvK1lhS5OYFXUgXXdKGZL9ljRGRsbRhmjx411BBN35dOaoxrEhTaj2fwikpGLUS9jtc7unQ=&amp;uniplatform=NZKPT&amp;language=CHS  </p>
<h2 id="lab2">Lab2:向量化计算<a class="headerlink" href="#lab2" title="Permanent link">&para;</a></h2>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> 完成双线性插值的向量化版本  </li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> 测试向量化实现的正确性和加速比  </li>
</ul>
<p>从此的lab文档格式更像是实验报告的格式  </p>
<h3 id="21">2.1 实验介绍<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<p><strong>NumPy</strong>是Python中科学计算的基础包。它是一个Python库，提供<strong>多维数组对象</strong>，各种派生对象（如掩码数组和矩阵），以及用于数组快速操作的各种 API，有包括数学、逻辑、形状操作、排序、选择、输入输出、离散傅立叶变换、基本线性代数，基本统计运算和随机模拟等等。<br />
Numpy代码一般采用<strong>向量化（矢量化）描述</strong>，这使得代码中<u>没有任何显式的循环，索引</u>等，这样的代码有以下好处：  </p>
<blockquote>
<p>1、向量化代码更简洁，更易于阅读
2、更少的代码行通常意味着更少的错误
3、代码更接近于标准的数学符号  </p>
</blockquote>
<p>另外，向量化的代码能够<u>规避掉 Python 中缓慢的迭代循环</u>，被底层的实现更好的调度，如接入 BLAS 矩阵运算库，从而实现更高的性能。<br />
双线性插值是计算机视觉图像处理中的常用算法，他在计算机图形学中也可以用于材质贴图的重采样。<br />
本次实验我们将借助 NumPy 实现一个<u>支持批量处理的向量化的双线性插值</u>，来让大家熟悉 NumPy 的向量化编程模式。      </p>
<h3 id="22">2.2 实验环境<a class="headerlink" href="#22" title="Permanent link">&para;</a></h3>
<p>直接在vscode上配置一个python环境就好了  </p>
<blockquote>
<p>import Numpy  </p>
</blockquote>
<p>Terminal-&gt;New Terminal<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>pip<span class="w"> </span>install<span class="w"> </span>numpy
</code></pre></div></td></tr></table></div></p>
<h3 id="23">2.3 实验基础知识<a class="headerlink" href="#23" title="Permanent link">&para;</a></h3>
<h4 id="231-numpy">2.3.1 Numpy<a class="headerlink" href="#231-numpy" title="Permanent link">&para;</a></h4>
<p>lab文档里并没有关于Numpy本身的介绍，但我觉得这部分基础还是相当重要的，所以简单补一下，也会更偏应用层面<br />
大致框架可以直接看HPC101的ppt <code>Numpy 101</code>
学习内容完全基于<a href="https://betterprogramming.pub/numpy-illustrated-the-visual-guide-to-numpy-3b1d4976de1d">NumPy Illustrated: The Visual Guide to NumPy</a></p>
<p>The beauty of it is that most operations look just the same, no matter how many dimensions an array has. But 1D and 2D cases are a bit special.   </p>
<blockquote>
<p>1.the 1D Arrays
2.the 2D Arrays<br />
3.the 3D and above  </p>
</blockquote>
<h5 id="numpy-array-vs-python-list">Numpy Array vs Python List<a class="headerlink" href="#numpy-array-vs-python-list" title="Permanent link">&para;</a></h5>
<p><img alt="alt text" src="../1_ND8LvMjQOX19G-Yg0ANPxw.webp" /><br />
<img alt="alt text" src="../1_D-I8hK4WXC8wtpR5tvR0fw.webp" /><br />
在课上提到，<code>python list</code>的存储方式是每个位置存储指向对应元素的指针，所以可以支撑存储不同类型的元素；而<code>numpy array</code>是直接存元素的，所以基本都是相同的元素，也因此<code>NumPy</code>对向量化后的元素处理更快，"more compact,espacially when there's more than one dimension"  </p>
<h5 id="vectorsthe-1d-arrays">Vectors,the 1D Arrays<a class="headerlink" href="#vectorsthe-1d-arrays" title="Permanent link">&para;</a></h5>
<blockquote>
<p>Vector initialization</p>
</blockquote>
<p>One way to create a NumPy array is to convert a Python list. The type will be auto-deduced from the list element types:<br />
<img alt="alt text" src="../1_oQRt7v_zDO7DNRLRUlCm5w.webp" /><br />
由于<code>NumPy</code>不方便直接在后面增加元素，所以一般会preallocate the necessary sapce with <code>np.zeros</code> or <code>np.empty</code>:
<img alt="alt text" src="../1_-_CdjlwqtzCj98i2oCr5Tw.webp" />
It is often necessary to create an empty array which matches the existing one by shape and elements type:<br />
<img alt="alt text" src="../1_WXny4Z0frysfsVllO84Jyw.webp" />  </p>
<p><img alt="alt text" src="../1_cyN_FxUVbkdDyrULhfTIGw.webp" />  </p>
<p><img alt="alt text" src="../1_NNCWBPDCPfLtNYDc_ul5SA.webp" />
创建递增数列对<code>floats</code>也可以使用，但<code>arrange</code>在处理<code>floats</code>时可能出现问题（这涉及到二进制存储小数和四舍五入）：<br />
<img alt="alt text" src="../1_ps2PYTthKUdNbzynKjW4oQ.webp" />  </p>
<p>随机数生成<br />
<img alt="alt text" src="../1_6RkkCzD3TTSCjzf6CV7nVw.webp" />
Vector indexing<br />
<img alt="alt text" src="../1_4xpufyWZWcIbabsOHVlc4g.webp" /><br />
关于切片<code>copy</code>和插入等操作与<code>python list</code>有些不同，具体原理看文档<br />
<img alt="alt text" src="../1_Dv9HzG2dSf3QuhjfpSIhqA.webp" />
Also, such assignments must not change the size of the array, so tricks like<br />
<img alt="alt text" src="../1_w1ZD8Qi4iGyuzeLcfdYK9w.webp" /><br />
won’t work in <code>NumPy</code> — use <code>np.insert</code>,<code>np.append</code>, etc. instead (described in the “2D” section below).  </p>
<p>boolean indexing,ternary comparisons,<code>np.where</code>,<code>np.clip</code>,<code>np.minimun</code>,<code>np.maximun</code> 见文档  </p>
<blockquote>
<p>Vector operations  </p>
</blockquote>
<p>Arithmetic is one of the places where NumPy speed shines most. Vector operators are shifted to the c++ level and allow us to avoid the costs of slow Python loops.<br />
<img alt="alt text" src="../1_RNfQubSwH_6-GnWHVjn9CQ.webp" /><br />
The same way ints are promoted to floats when adding or subtracting, scalars are promoted (aka <strong>broadcasted</strong>) to arrays:
<img alt="alt text" src="../1_VyadDu7CyuF5-7rKVoFSrw.webp" /><br />
<img alt="alt text" src="../1_Pc4t0jilbHSM0sMwtVNGIA.webp" /><br />
<img alt="alt text" src="../1_rDUgKZO4bj9_SSRY6ddnfg.webp" /><br />
<img alt="alt text" src="../1_wyHVvsoUdsHA0RedM6kdvQ.webp" /><br />
<img alt="alt text" src="../1_GkjXtrFriVBXTQove8vEPw.webp" /><br />
<img alt="alt text" src="../1_TAB7WXfvTM7FxD1bJ7augQ.webp" /><br />
<img alt="alt text" src="../1_mmS5_eCb8onu7MYjjdYpFw.webp" />  </p>
<blockquote>
<p>Searching for an element in a vector  </p>
</blockquote>
<p>A faster way to do it is via accelerating next((i[0] for i, v in <code>np.ndenumerate(a) if v==x), -1)</code> with <code>Numba</code> (otherwise it’s way slower in the worst case than where).  看不太懂，过吧  </p>
<blockquote>
<p>Comparing floats  </p>
</blockquote>
<p><img alt="alt text" src="../1_LZWByfm3vyHXhNreHGy3hQ.webp" /><br />
There is no silver bullet!  </p>
<h5 id="matricesthe-2d-arrays">Matrices,the 2D Arrays<a class="headerlink" href="#matricesthe-2d-arrays" title="Permanent link">&para;</a></h5>
<blockquote>
<p>Matrix initialization  </p>
</blockquote>
<p><img alt="alt text" src="../1_aLMuXA81pDXaw0J0QdKvRQ.webp" /><br />
<img alt="alt text" src="../1_zOgsZhCTMnbJWC5u_I3fiQ.webp" /><br />
<img alt="alt text" src="../1_brbsl7QFZGWfmvgFHMwt9Q.webp" />   </p>
<blockquote>
<p>The axis argument  </p>
</blockquote>
<p>The value of the <code>axis</code> argument is, as a matter of fact, the number of the index in question: The first index is <code>axis=0</code>, the second one is <code>axis=1</code>, and so on. So in 2D <code>axis=0</code> is column-wise and <code>axis=1</code> means row-wise.
<img alt="alt text" src="../1_jmXqsVUNaBaUsBAkHgqb3A.webp" /><br />
The 2D case is somewhat counter-intuitive: you need to specify the dimension to <strong>be eliminated</strong>, instead of the remaining one you would normally think about. In higher dimensional cases this is more natural, though: it’d be a burden to enumerate all the remaining dimensions if you only need to sum over a single one.  </p>
<blockquote>
<p>Matrix arithmetic  </p>
</blockquote>
<p>In addition to ordinary operators (like +,-,<em>,/,// and *</em>) which work element-wise, there’s a <code>@</code> operator that calculates a matrix product:<br />
<img alt="alt text" src="../1_z0vpti4m5rnRdG7tjFBAAA.webp" /><br />
<img alt="alt text" src="../1_qbi-kCjxBE9Wd6Y0cKHfaQ.webp" /><br />
<img alt="alt text" src="../1_AxPMBAD67SbeXV4wEdcamQ.webp" />  </p>
<blockquote>
<p>Row vectors and column vectors  </p>
</blockquote>
<p>转置这里好像有些特殊机制，但没太看懂<br />
<img alt="alt text" src="../1_PYk9Ukt2OpnWXrlYqjXEBw.webp" /><br />
<code>reshape</code>命令个人认为意义不大，总之1D arrays,2D row vectors,2D column vectors之间是可以互相转换的<br />
<img alt="alt text" src="../1_nVqN9Ha2tBO4isoGqCIsMQ.webp" />  </p>
<blockquote>
<p>Matrix manipulations  </p>
</blockquote>
<p><img alt="alt text" src="../1_SJbmp5_qJixVztVMJQn9sw.webp" /><br />
对于1D arrays似乎有所不同，这与其存储方式有关
<img alt="alt text" src="../1_ZUFxtl3Z2cdDZhcLUNpE0Q.webp" /><br />
The inverse of stacking is splitting:<br />
<img alt="alt text" src="../1_ADtgaXz1wxze7c6K6kK9CQ.webp" /><br />
<img alt="alt text" src="../1_VhinWlrXT9nOlr6qUI8RHw.webp" /><br />
Matrix replication can be done in two ways: <code>tile</code> acts like copy-pasting and <code>repeat</code> like collated printing:
<img alt="alt text" src="../1_kCClP8kiegtYZNyEdsCPbw.webp" /><br />
<code>delete</code><br />
<img alt="alt text" src="../1_OSCZ2ADLw-YN-S6reXOiMQ.webp" /><br />
<code>insert</code>
<img alt="alt text" src="../1_IEVGMjetDiL27pSOAO7FuA.webp" /><br />
<code>append</code>(is also unable to automatically transpose 1D arrays)
<img alt="alt text" src="../1_ji2JnZUnVcG6IHFSl0FWFg.webp" /><br />
<code>pad</code>其实很像在卷积中的一些外延操作<br />
<img alt="alt text" src="../1_nymIetfKC2vkbmNrxoSeGg.webp" />  </p>
<blockquote>
<p>Mehgrids
(略)  </p>
<p>Matrix statistics  </p>
</blockquote>
<p><img alt="alt text" src="../1_rTNRworY2lLrtnEW92tQbQ.webp" /><br />
<img alt="alt text" src="../1_bbkABjr18h_q5cPQmgkehg.webp" /><br />
<img alt="alt text" src="../1_y95ZnO1wB9U-MFAYf4r4qw.webp" /></p>
<blockquote>
<p>Matrix sorting  </p>
</blockquote>
<p><img alt="alt text" src="../1_Ilp0Mn0vS5ly0NhxUs3bhw.webp" /><br />
<img alt="alt text" src="../1_way2tJEnsXOjtfo1PkTv8w.webp" /><br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span>
<span class="normal"><a href="#__codelineno-1-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;stable&#39;</span><span class="p">)]</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;stable&#39;</span><span class="p">)]</span>
</code></pre></div></td></tr></table></div>
<img alt="alt text" src="../1_r98wxRa5nD4uK9KMcV7pEA.webp" />  </p>
<h5 id="3d-and-above">3D and Above<a class="headerlink" href="#3d-and-above" title="Permanent link">&para;</a></h5>
<p>When you create a 3D array by reshaping a 1D vector or converting a nested Python list, the meaning of the indices is (z,y,x). The first index is the number of the plane, then the coordinates go in that plane:
<img alt="alt text" src="../1_BAr1RXkpGJD5lcwbTePGLA.webp" /><br />
But this index order is not universal. When working with RGB images, the (y,x,z) order is usually used<br />
<img alt="alt text" src="../1_NNm3gGO8sEinq6JYlI84dg.webp" /><br />
<img alt="alt text" src="../1_c_XjRbJHN26dMw1dcRS6qQ.webp" /><br />
If your data is laid out differently, it is more convenient to stack images using the <code>concatenate</code> command, feeding it the explicit index number in an axis argument:
<img alt="alt text" src="../1_bUfuXiTZOas6ZSD_lOSbXA.webp" /><br />
3D矩阵的转换之类的看也不想看，但愿这辈子都用不到，过吧  </p>
<p><a href="https://www.labri.fr/perso/nrougier/from-python-to-numpy/">“稍微硬核一点的numpy教程”</a>
如果还要知道的更细致，就直接看<a href="https://numpy.org/doc/stable/">numpy</a>文档  </p>
<hr />
<h4 id="232">2.3.2 双线性插值算法<a class="headerlink" href="#232" title="Permanent link">&para;</a></h4>
<p>关于双线性插值算法，lab文档里介绍的还是比较清楚的  </p>
<p>双线性插值的算法其实非常简单，概括来说就是先在 x 轴上进行一次插值，再在 y 轴上进行一次插值。<br />
<img alt="alt text" src="../bilinear2.png" />  </p>
<p>以在灰度图上进行插值为例，我们已知外围的四个点 (14,20),(15,20),(14,21),(15,21) 灰度值分别为 91, 210, 162 和 95，然后希望通过插值得到 (14.5,20.2) 处的灰度值。</p>
<p>接下来我们先在 x 方向上通过线性插值计算出 (14.5,20),(14.5,21) 两个点的灰度值 150.5, 128.5，然后再使用这两个值在 y 方向上再次进行线性插值，得到 (14.5,20.2) 坐标处的灰度值 146.1。</p>
<p>注意这里是一个单通道的例子，对于实际的情况，我们往往有很多个通道，如彩色图片拥有 RGB 三个通道，一些图片可能还有 α 透明度通道，或是深度通道。<strong>对于多通道的情况，我们需要对每个通道进行分别插值</strong>。  </p>
<p>lab文档参照wikipedia给出了形式化的定义  </p>
<p>假如我们想得到未知函数 f 在点 P=(x,y) 的值，假设我们已知函数 f 在 Q11=(x1,y1), Q12=(x1,y2), Q21=(x2,y1) 及 Q22=(x2,y2) 四个点的值。<br />
<img alt="alt text" src="../bilinear.png" /><br />
首先在 x 方向进行线性插值，得到</p>
<math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
  <mrow data-mjx-texclass="ORD">
    <mstyle displaystyle="true" scriptlevel="0">
      <mrow data-mjx-texclass="ORD">
        <mtable displaystyle="true" columnalign="right left" columnspacing="0em" rowspacing="3pt">
          <mtr>
            <mtd>
              <mi>f</mi>
              <mo stretchy="false">(</mo>
              <mi>x</mi>
              <mo>,</mo>
              <msub>
                <mi>y</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>1</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
            </mtd>
            <mtd>
              <mi></mi>
              <mo>&#x2248;</mo>
              <mrow data-mjx-texclass="ORD">
                <mfrac>
                  <mrow>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <mi>x</mi>
                  </mrow>
                  <mrow>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                  </mrow>
                </mfrac>
              </mrow>
              <mi>f</mi>
              <mo stretchy="false">(</mo>
              <msub>
                <mi>Q</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>11</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
              <mo>+</mo>
              <mrow data-mjx-texclass="ORD">
                <mfrac>
                  <mrow>
                    <mi>x</mi>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                  </mrow>
                  <mrow>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                  </mrow>
                </mfrac>
              </mrow>
              <mi>f</mi>
              <mo stretchy="false">(</mo>
              <msub>
                <mi>Q</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>21</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
              <mo>,</mo>
            </mtd>
          </mtr>
          <mtr>
            <mtd></mtd>
          </mtr>
          <mtr>
            <mtd>
              <mi>f</mi>
              <mo stretchy="false">(</mo>
              <mi>x</mi>
              <mo>,</mo>
              <msub>
                <mi>y</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>2</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
            </mtd>
            <mtd>
              <mi></mi>
              <mo>&#x2248;</mo>
              <mrow data-mjx-texclass="ORD">
                <mfrac>
                  <mrow>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <mi>x</mi>
                  </mrow>
                  <mrow>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                  </mrow>
                </mfrac>
              </mrow>
              <mi>f</mi>
              <mo stretchy="false">(</mo>
              <msub>
                <mi>Q</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>12</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
              <mo>+</mo>
              <mrow data-mjx-texclass="ORD">
                <mfrac>
                  <mrow>
                    <mi>x</mi>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                  </mrow>
                  <mrow>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                  </mrow>
                </mfrac>
              </mrow>
              <mi>f</mi>
              <mo stretchy="false">(</mo>
              <msub>
                <mi>Q</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>22</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
              <mo>.</mo>
            </mtd>
          </mtr>
        </mtable>
      </mrow>
    </mstyle>
  </mrow>
</math>

<p>然后在 y 方向进行线性插值，得到  </p>
<math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
  <mrow data-mjx-texclass="ORD">
    <mstyle displaystyle="true" scriptlevel="0">
      <mrow data-mjx-texclass="ORD">
        <mtable displaystyle="true" columnalign="right left right left" columnspacing="0em 2em 0em" rowspacing="3pt">
          <mtr>
            <mtd>
              <mi>f</mi>
              <mo stretchy="false">(</mo>
              <mi>x</mi>
              <mo>,</mo>
              <mi>y</mi>
              <mo stretchy="false">)</mo>
            </mtd>
            <mtd>
              <mi></mi>
              <mo>&#x2248;</mo>
            </mtd>
            <mtd></mtd>
            <mtd>
              <mrow data-mjx-texclass="ORD">
                <mfrac>
                  <mrow>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <mi>y</mi>
                  </mrow>
                  <mrow>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                  </mrow>
                </mfrac>
              </mrow>
              <mi>f</mi>
              <mo stretchy="false">(</mo>
              <mi>x</mi>
              <mo>,</mo>
              <msub>
                <mi>y</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>1</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
              <mo>+</mo>
              <mrow data-mjx-texclass="ORD">
                <mfrac>
                  <mrow>
                    <mi>y</mi>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                  </mrow>
                  <mrow>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                  </mrow>
                </mfrac>
              </mrow>
              <mi>f</mi>
              <mo stretchy="false">(</mo>
              <mi>x</mi>
              <mo>,</mo>
              <msub>
                <mi>y</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>2</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
            </mtd>
          </mtr>
          <mtr>
            <mtd></mtd>
          </mtr>
          <mtr>
            <mtd></mtd>
            <mtd>
              <mi></mi>
              <mo>=</mo>
            </mtd>
            <mtd></mtd>
            <mtd>
              <mrow data-mjx-texclass="ORD">
                <mfrac>
                  <mrow>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <mi>y</mi>
                  </mrow>
                  <mrow>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                  </mrow>
                </mfrac>
              </mrow>
              <mrow data-mjx-texclass="INNER">
                <mo data-mjx-texclass="OPEN">(</mo>
                <mrow data-mjx-texclass="ORD">
                  <mfrac>
                    <mrow>
                      <msub>
                        <mi>x</mi>
                        <mrow data-mjx-texclass="ORD">
                          <mn>2</mn>
                        </mrow>
                      </msub>
                      <mo>&#x2212;</mo>
                      <mi>x</mi>
                    </mrow>
                    <mrow>
                      <msub>
                        <mi>x</mi>
                        <mrow data-mjx-texclass="ORD">
                          <mn>2</mn>
                        </mrow>
                      </msub>
                      <mo>&#x2212;</mo>
                      <msub>
                        <mi>x</mi>
                        <mrow data-mjx-texclass="ORD">
                          <mn>1</mn>
                        </mrow>
                      </msub>
                    </mrow>
                  </mfrac>
                </mrow>
                <mi>f</mi>
                <mo stretchy="false">(</mo>
                <msub>
                  <mi>Q</mi>
                  <mrow data-mjx-texclass="ORD">
                    <mn>11</mn>
                  </mrow>
                </msub>
                <mo stretchy="false">)</mo>
                <mo>+</mo>
                <mrow data-mjx-texclass="ORD">
                  <mfrac>
                    <mrow>
                      <mi>x</mi>
                      <mo>&#x2212;</mo>
                      <msub>
                        <mi>x</mi>
                        <mrow data-mjx-texclass="ORD">
                          <mn>1</mn>
                        </mrow>
                      </msub>
                    </mrow>
                    <mrow>
                      <msub>
                        <mi>x</mi>
                        <mrow data-mjx-texclass="ORD">
                          <mn>2</mn>
                        </mrow>
                      </msub>
                      <mo>&#x2212;</mo>
                      <msub>
                        <mi>x</mi>
                        <mrow data-mjx-texclass="ORD">
                          <mn>1</mn>
                        </mrow>
                      </msub>
                    </mrow>
                  </mfrac>
                </mrow>
                <mi>f</mi>
                <mo stretchy="false">(</mo>
                <msub>
                  <mi>Q</mi>
                  <mrow data-mjx-texclass="ORD">
                    <mn>21</mn>
                  </mrow>
                </msub>
                <mo stretchy="false">)</mo>
                <mo data-mjx-texclass="CLOSE">)</mo>
              </mrow>
            </mtd>
          </mtr>
          <mtr>
            <mtd></mtd>
          </mtr>
          <mtr>
            <mtd></mtd>
            <mtd></mtd>
            <mtd></mtd>
            <mtd>
              <mi></mi>
              <mo>+</mo>
              <mrow data-mjx-texclass="ORD">
                <mfrac>
                  <mrow>
                    <mi>y</mi>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                  </mrow>
                  <mrow>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                  </mrow>
                </mfrac>
              </mrow>
              <mrow data-mjx-texclass="INNER">
                <mo data-mjx-texclass="OPEN">(</mo>
                <mrow data-mjx-texclass="ORD">
                  <mfrac>
                    <mrow>
                      <msub>
                        <mi>x</mi>
                        <mrow data-mjx-texclass="ORD">
                          <mn>2</mn>
                        </mrow>
                      </msub>
                      <mo>&#x2212;</mo>
                      <mi>x</mi>
                    </mrow>
                    <mrow>
                      <msub>
                        <mi>x</mi>
                        <mrow data-mjx-texclass="ORD">
                          <mn>2</mn>
                        </mrow>
                      </msub>
                      <mo>&#x2212;</mo>
                      <msub>
                        <mi>x</mi>
                        <mrow data-mjx-texclass="ORD">
                          <mn>1</mn>
                        </mrow>
                      </msub>
                    </mrow>
                  </mfrac>
                </mrow>
                <mi>f</mi>
                <mo stretchy="false">(</mo>
                <msub>
                  <mi>Q</mi>
                  <mrow data-mjx-texclass="ORD">
                    <mn>12</mn>
                  </mrow>
                </msub>
                <mo stretchy="false">)</mo>
                <mo>+</mo>
                <mrow data-mjx-texclass="ORD">
                  <mfrac>
                    <mrow>
                      <mi>x</mi>
                      <mo>&#x2212;</mo>
                      <msub>
                        <mi>x</mi>
                        <mrow data-mjx-texclass="ORD">
                          <mn>1</mn>
                        </mrow>
                      </msub>
                    </mrow>
                    <mrow>
                      <msub>
                        <mi>x</mi>
                        <mrow data-mjx-texclass="ORD">
                          <mn>2</mn>
                        </mrow>
                      </msub>
                      <mo>&#x2212;</mo>
                      <msub>
                        <mi>x</mi>
                        <mrow data-mjx-texclass="ORD">
                          <mn>1</mn>
                        </mrow>
                      </msub>
                    </mrow>
                  </mfrac>
                </mrow>
                <mi>f</mi>
                <mo stretchy="false">(</mo>
                <msub>
                  <mi>Q</mi>
                  <mrow data-mjx-texclass="ORD">
                    <mn>22</mn>
                  </mrow>
                </msub>
                <mo stretchy="false">)</mo>
                <mo data-mjx-texclass="CLOSE">)</mo>
              </mrow>
            </mtd>
          </mtr>
          <mtr>
            <mtd></mtd>
          </mtr>
          <mtr>
            <mtd></mtd>
            <mtd>
              <mi></mi>
              <mo>=</mo>
            </mtd>
            <mtd></mtd>
            <mtd>
              <mrow data-mjx-texclass="ORD">
                <mfrac>
                  <mn>1</mn>
                  <mrow>
                    <mo stretchy="false">(</mo>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                    <mo stretchy="false">)</mo>
                    <mo stretchy="false">(</mo>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                    <mo stretchy="false">)</mo>
                  </mrow>
                </mfrac>
              </mrow>
              <mrow data-mjx-texclass="ORD">
                <mrow data-mjx-texclass="ORD">
                  <mo minsize="1.2em" maxsize="1.2em">(</mo>
                </mrow>
              </mrow>
              <mi>f</mi>
              <mo stretchy="false">(</mo>
              <msub>
                <mi>Q</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>11</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
              <mo stretchy="false">(</mo>
              <msub>
                <mi>x</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>2</mn>
                </mrow>
              </msub>
              <mo>&#x2212;</mo>
              <mi>x</mi>
              <mo stretchy="false">)</mo>
              <mo stretchy="false">(</mo>
              <msub>
                <mi>y</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>2</mn>
                </mrow>
              </msub>
              <mo>&#x2212;</mo>
              <mi>y</mi>
              <mo stretchy="false">)</mo>
              <mo>+</mo>
              <mi>f</mi>
              <mo stretchy="false">(</mo>
              <msub>
                <mi>Q</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>21</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
              <mo stretchy="false">(</mo>
              <mi>x</mi>
              <mo>&#x2212;</mo>
              <msub>
                <mi>x</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>1</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
              <mo stretchy="false">(</mo>
              <msub>
                <mi>y</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>2</mn>
                </mrow>
              </msub>
              <mo>&#x2212;</mo>
              <mi>y</mi>
              <mo stretchy="false">)</mo>
            </mtd>
          </mtr>
          <mtr>
            <mtd></mtd>
          </mtr>
          <mtr>
            <mtd></mtd>
            <mtd></mtd>
            <mtd></mtd>
            <mtd>
              <mi></mi>
              <mo>+</mo>
              <mi>f</mi>
              <mo stretchy="false">(</mo>
              <msub>
                <mi>Q</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>12</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
              <mo stretchy="false">(</mo>
              <msub>
                <mi>x</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>2</mn>
                </mrow>
              </msub>
              <mo>&#x2212;</mo>
              <mi>x</mi>
              <mo stretchy="false">)</mo>
              <mo stretchy="false">(</mo>
              <mi>y</mi>
              <mo>&#x2212;</mo>
              <msub>
                <mi>y</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>1</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
              <mo>+</mo>
              <mi>f</mi>
              <mo stretchy="false">(</mo>
              <msub>
                <mi>Q</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>22</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
              <mo stretchy="false">(</mo>
              <mi>x</mi>
              <mo>&#x2212;</mo>
              <msub>
                <mi>x</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>1</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
              <mo stretchy="false">(</mo>
              <mi>y</mi>
              <mo>&#x2212;</mo>
              <msub>
                <mi>y</mi>
                <mrow data-mjx-texclass="ORD">
                  <mn>1</mn>
                </mrow>
              </msub>
              <mo stretchy="false">)</mo>
              <mrow data-mjx-texclass="ORD">
                <mrow data-mjx-texclass="ORD">
                  <mo minsize="1.2em" maxsize="1.2em">)</mo>
                </mrow>
              </mrow>
            </mtd>
          </mtr>
          <mtr>
            <mtd></mtd>
          </mtr>
          <mtr>
            <mtd></mtd>
            <mtd>
              <mi></mi>
              <mo>=</mo>
            </mtd>
            <mtd></mtd>
            <mtd>
              <mrow data-mjx-texclass="ORD">
                <mfrac>
                  <mn>1</mn>
                  <mrow>
                    <mo stretchy="false">(</mo>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>x</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                    <mo stretchy="false">)</mo>
                    <mo stretchy="false">(</mo>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>2</mn>
                      </mrow>
                    </msub>
                    <mo>&#x2212;</mo>
                    <msub>
                      <mi>y</mi>
                      <mrow data-mjx-texclass="ORD">
                        <mn>1</mn>
                      </mrow>
                    </msub>
                    <mo stretchy="false">)</mo>
                  </mrow>
                </mfrac>
              </mrow>
              <mrow data-mjx-texclass="ORD">
                <mrow data-mjx-texclass="INNER">
                  <mo data-mjx-texclass="OPEN">[</mo>
                  <mtable columnalign="center" columnspacing="1em" rowspacing="4pt">
                    <mtr>
                      <mtd>
                        <msub>
                          <mi>x</mi>
                          <mrow data-mjx-texclass="ORD">
                            <mn>2</mn>
                          </mrow>
                        </msub>
                        <mo>&#x2212;</mo>
                        <mi>x</mi>
                      </mtd>
                      <mtd>
                        <mi>x</mi>
                        <mo>&#x2212;</mo>
                        <msub>
                          <mi>x</mi>
                          <mrow data-mjx-texclass="ORD">
                            <mn>1</mn>
                          </mrow>
                        </msub>
                      </mtd>
                    </mtr>
                  </mtable>
                  <mo data-mjx-texclass="CLOSE">]</mo>
                </mrow>
              </mrow>
              <mrow data-mjx-texclass="ORD">
                <mrow data-mjx-texclass="INNER">
                  <mo data-mjx-texclass="OPEN">[</mo>
                  <mtable columnalign="center" columnspacing="1em" rowspacing="4pt">
                    <mtr>
                      <mtd>
                        <mi>f</mi>
                        <mo stretchy="false">(</mo>
                        <msub>
                          <mi>Q</mi>
                          <mrow data-mjx-texclass="ORD">
                            <mn>11</mn>
                          </mrow>
                        </msub>
                        <mo stretchy="false">)</mo>
                      </mtd>
                      <mtd>
                        <mi>f</mi>
                        <mo stretchy="false">(</mo>
                        <msub>
                          <mi>Q</mi>
                          <mrow data-mjx-texclass="ORD">
                            <mn>12</mn>
                          </mrow>
                        </msub>
                        <mo stretchy="false">)</mo>
                      </mtd>
                    </mtr>
                    <mtr>
                      <mtd></mtd>
                    </mtr>
                    <mtr>
                      <mtd>
                        <mi>f</mi>
                        <mo stretchy="false">(</mo>
                        <msub>
                          <mi>Q</mi>
                          <mrow data-mjx-texclass="ORD">
                            <mn>21</mn>
                          </mrow>
                        </msub>
                        <mo stretchy="false">)</mo>
                      </mtd>
                      <mtd>
                        <mi>f</mi>
                        <mo stretchy="false">(</mo>
                        <msub>
                          <mi>Q</mi>
                          <mrow data-mjx-texclass="ORD">
                            <mn>22</mn>
                          </mrow>
                        </msub>
                        <mo stretchy="false">)</mo>
                      </mtd>
                    </mtr>
                  </mtable>
                  <mo data-mjx-texclass="CLOSE">]</mo>
                </mrow>
              </mrow>
              <mrow data-mjx-texclass="ORD">
                <mrow data-mjx-texclass="INNER">
                  <mo data-mjx-texclass="OPEN">[</mo>
                  <mtable columnalign="center" columnspacing="1em" rowspacing="4pt">
                    <mtr>
                      <mtd>
                        <msub>
                          <mi>y</mi>
                          <mrow data-mjx-texclass="ORD">
                            <mn>2</mn>
                          </mrow>
                        </msub>
                        <mo>&#x2212;</mo>
                        <mi>y</mi>
                      </mtd>
                    </mtr>
                    <mtr>
                      <mtd></mtd>
                    </mtr>
                    <mtr>
                      <mtd>
                        <mi>y</mi>
                        <mo>&#x2212;</mo>
                        <msub>
                          <mi>y</mi>
                          <mrow data-mjx-texclass="ORD">
                            <mn>1</mn>
                          </mrow>
                        </msub>
                      </mtd>
                    </mtr>
                  </mtable>
                  <mo data-mjx-texclass="CLOSE">]</mo>
                </mrow>
              </mrow>
              <mo>.</mo>
            </mtd>
          </mtr>
        </mtable>
      </mrow>
    </mstyle>
  </mrow>
</math>
<p>注意此处如果先在 y 方向插值、再在 x 方向插值，其结果与按照上述顺序双线性插值的结果是一样的。  </p>
<h4 id="233-nhwc">2.3.3 NHWC 数据格式<a class="headerlink" href="#233-nhwc" title="Permanent link">&para;</a></h4>
<p>一个完全没见过的东西，先问下gpt  </p>
<blockquote>
<p><strong>NHWC（样本数-高度-宽度-通道）</strong> 数据格式是卷积神经网络（CNN）中广泛使用的一种数据组织方式，尤其在处理图像、点云或特征图等多维数据时尤为重要。以下是对NHWC数据格式的详细解析：<br />
一、基本概念
在NHWC格式中，数据按照以下顺序进行排列：
    <strong>N：Batch Size（批次大小）</strong>，表示一次处理的数据样本数量。
    <strong>H：Height（高度）</strong>，表示图像或特征图的高度。
    <strong>W：Width（宽度）</strong>，表示图像或特征图的宽度。
    <strong>C：Channel（通道数）</strong>，对于彩色图像来说，通常是RGB三个通道。
二、存储方式
在NHWC格式中，数据在内存中的存储方式遵循以下规则：
    首先是所有样本的第一个通道的所有元素（即所有样本的第一个像素点的第一个通道值），然后是第一个通道的第二行元素，依此类推，直到第一个通道的所有元素都被存储。
    接着是第二个通道的所有元素，按照与第一个通道相同的顺序存储。
    依此类推，直到所有通道的所有元素都被存储。
这种存储方式使得相同空间位置（即相同像素点）的所有通道值在内存中连续存储，这有助于优化对空间数据的访问。<br />
然而，需要注意的是，在GPU上进行计算时，NCHW（样本数-通道-高度-宽度）格式可能更加高效，因为它能够更好地利用GPU的并行计算能力和内存访问模式。  </p>
</blockquote>
<p>lab文档的介绍：<br />
真实情况下我们处理的数据都是<strong>以 batch 为单位</strong>的，按批进行处理的。以双线性插值为例，我们往往会一次性送入<u> N 张大小为 H×W 的图片，每个像素上有 C 个通道</u>，然后一次性返回这 N 张图片处理好的结果。此时我们一次性传入的数据，就是直接<strong>按顺序堆叠在一起的 NHWC 格式的数组</strong>，它将 batch 作为了第一个维度，而后三个维度分别是单张图片的高度、宽度、通道数。你可以将这一数据格式理解为 c 语言中的高维数组 <code>image[N][H][W][C]</code>，而因为 c 的数组和 NumPy 的 ndarray 一样都是<strong>在内存里连续排放</strong>的，所以对于 <code>image[x1][x2][x3][x4]</code>，其实就是 <code>image[x1 * H * W * C + x2 * W * C + x3 * C + x4]</code> 处的内存。</p>
<p>另一个常见的数据格式是 NCHW，也就是单张图片内通道在前，不过这里我们没有选用。</p>
<p>数据格式更多是对数据的存放顺序进行约定，你可以通过 np.transpose 将不同维度进行调换。  </p>
<h3 id="24">2.4 实验步骤<a class="headerlink" href="#24" title="Permanent link">&para;</a></h3>
<h4 id="241">2.4.1 接口定义<a class="headerlink" href="#241" title="Permanent link">&para;</a></h4>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span>
<span class="normal"><a href="#__codelineno-2-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">def</span> <span class="nf">bilinear_interp</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w"> </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="sd"> - a is a ND array with shape [N, H1, W1, C]</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="sd"> - b is a ND array with shape [N, H2, W2, 2]</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="sd"> - return a ND array with shape [N, H2, W2, C]</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="sd"> &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
其含义是，对于 batch 内的每一张 H1×W1 的图 a，b 中给出了新的 H2×W2 的图中每个像素所想要采样的 a 图中对应点的坐标，并将采样结果返回。</p>
<p>为了简化任务，我们假定传入的采样点不会出现在 (H1−1,W1−1)，即图像的右下角。  </p>
<h4 id="242">2.4.2 基准代码<a class="headerlink" href="#242" title="Permanent link">&para;</a></h4>
<p>使用 for 循环迭代计算的双线性插值版本：<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span>
<span class="normal"><a href="#__codelineno-3-24">24</a></span>
<span class="normal"><a href="#__codelineno-3-25">25</a></span>
<span class="normal"><a href="#__codelineno-3-26">26</a></span>
<span class="normal"><a href="#__codelineno-3-27">27</a></span>
<span class="normal"><a href="#__codelineno-3-28">28</a></span>
<span class="normal"><a href="#__codelineno-3-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">int64</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="k">def</span> <span class="nf">bilinear_interp_baseline</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="sd">    This is the baseline implementation of bilinear interpolation without vectorization.</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="sd">    - a is a ND array with shape [N, H1, W1, C], dtype = int64</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="sd">    - b is a ND array with shape [N, H2, W2, 2], dtype = float64</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="sd">    - return a ND array with shape [N, H2, W2, C], dtype = int64</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>    <span class="c1"># Get axis size from ndarray shape</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>    <span class="n">N</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># 也就是知道a的shape，得到输入的batch size，height，width，channel这些信息，作为三重循环的参数</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>    <span class="n">N1</span><span class="p">,</span> <span class="n">H2</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>    <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="n">N1</span>  <span class="c1"># assert是一种“断言”，在程序运行时会实时检查，一旦N!=N1，就会报错</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>    <span class="c1"># Do iteration</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">H2</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">C</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int64</span><span class="p">)</span>  <span class="c1"># 创建一个空的ndarray来存放结果</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">H2</span><span class="p">):</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">W2</span><span class="p">):</span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a>                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># b的shape是[N,H2,W2,2]，它存储的是想要从原图中取的位置坐标，其中b[ , , ,0]是x坐标，b[ , , ,1]是y坐标</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a>                <span class="n">x_idx</span><span class="p">,</span> <span class="n">y_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>  <span class="c1"># floor是向下取整，也就是去寻找距离(x,y)相邻的整点</span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a>                <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x_idx</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_idx</span>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a>                <span class="c1"># For simplicity, we assume all x are in [0, H1 - 1), all y are in [0, W1 - 1)</span>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a>                <span class="n">res</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">x_idx</span><span class="p">,</span> <span class="n">y_idx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_y</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">x_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">_x</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_y</span><span class="p">)</span> <span class="o">+</span> \
<a id="__codelineno-3-27" name="__codelineno-3-27"></a>                               <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">x_idx</span><span class="p">,</span> <span class="n">y_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">_y</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">x_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">_x</span> <span class="o">*</span> <span class="n">_y</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a>                <span class="c1"># 这个计算完全就在套公式</span>
<a id="__codelineno-3-29" name="__codelineno-3-29"></a>    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div></p>
<h4 id="243">2.4.3 完成向量化实现<a class="headerlink" href="#243" title="Permanent link">&para;</a></h4>
<p>在给出的代码的 bilinear_interp/vectorized.py 中，完成 bilinear_interp_vectorized 函数。  </p>
<p>整道题并不难，就是将原来的三重for循环转成向量化后多维一起计算从而节约时间  </p>
<p>第一次尝试没有考虑到维数不匹配的问题，出现报错<br />
<img alt="alt text" src="../image-82.png" /><br />
这里补充numpy的广播规则，来自gpt：  </p>
<blockquote>
<p>1、如果所有输入数组的维度数不同，形状较小的数组会在前面补1（直到维度数相同）。
2、如果两个数组在某个维度上的大小不同，且其中一个的大小为1，则该维度上大小为1的数组将被扩展（或“广播”）以匹配另一个数组的大小。
3、如果两个数组在任何维度上的大小都不相同且都不为1，则会出现形状不匹配的错误。</p>
</blockquote>
<p>在这里，原代码为：
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span>
<span class="normal"><a href="#__codelineno-4-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1"># 接着计算差值  </span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="n">_x</span><span class="p">,</span><span class="n">_y</span><span class="o">=</span><span class="n">b</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x_idx</span><span class="p">,</span><span class="n">b</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y_idx</span>  
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="c1"># 直接套公式  </span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="n">res</span><span class="o">=</span><span class="n">a</span><span class="p">[:,</span><span class="n">x_idx</span><span class="p">,</span><span class="n">y_idx</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">_x</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">_y</span><span class="p">)</span><span class="o">+</span><span class="n">a</span><span class="p">[:,</span><span class="n">x_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">y_idx</span><span class="p">]</span><span class="o">*</span><span class="n">_x</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">_y</span><span class="p">)</span><span class="o">+</span><span class="n">a</span><span class="p">[:,</span> <span class="n">x_idx</span><span class="p">,</span> <span class="n">y_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">_y</span> <span class="o">+</span> <span class="n">a</span><span class="p">[:,</span> <span class="n">x_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">_x</span> <span class="o">*</span> <span class="n">_y</span>
</code></pre></div></td></tr></table></div>
其中，a的shape是(N,H1,W1,C)，但_x的shape是(N,H1,W1)，缺少了通道数这个维度，所以需要为它加上这一维度<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">_x</span><span class="o">=</span><span class="n">_x</span><span class="p">[:,:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">_y</span><span class="o">=</span><span class="n">_y</span><span class="p">[:,:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> 
</code></pre></div></td></tr></table></div></p>
<blockquote>
<p><code>np.nuewaxis</code>用于在数组的指定位置增加一个新的轴（axis），效果等同于在切片操作中指定一个 None 或空切片（:），但它提供了更明确的语义。
当你对一个数组使用<code>np.newaxis</code>时，你实际上是在告诉 NumPy 在数组的指定位置插入一个新的维度，该维度的大小为1。这不会改变数组中的任何数据，只是改变了它的形状（shape）  </p>
</blockquote>
<p>但遗憾的是这样做虽然能让程序运行，但答案出现了错误：<br />
<img alt="alt text" src="../image-83.png" /><br />
这个问题属实对我造成了极大的困扰<br />
实际上，对于<code>a[N,H,W]</code>，传入的时候它存了每个点C个通道的值，现在向量化之后，我们要对这些点一起做操作；我们以<code>x_idx</code>和<code>y_idx</code>作为索引把所有点作为整体，这两个索引具有[N,H,W]的三维结构，但是<code>N</code>不具备三维结构，所以我们需要将<code>N</code>拓展为三维的<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="n">new_n</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1"># np.arange()生成给定范围的数组</span>
</code></pre></div></td></tr></table></div>
最后得到的<code>bilinear_interp_vectorized</code>函数如下：<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">def</span> <span class="nf">bilinear_interp_vectorized</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="sd">    This is the vectorized implementation of bilinear interpolation.</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="sd">    - a is a ND array with shape [N, H1, W1, C], dtype = int64</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="sd">    - b is a ND array with shape [N, H2, W2, 2], dtype = float64</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="sd">    - return a ND array with shape [N, H2, W2, C], dtype = int64</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>    <span class="c1"># get axis size from ndarray shape</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>    <span class="n">N</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>    <span class="n">N1</span><span class="p">,</span> <span class="n">H2</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>    <span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="n">N1</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>    <span class="c1"># TODO: Implement vectorized bilinear interpolation  </span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a>    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">H2</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="n">C</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int64</span><span class="p">)</span>  
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a>    <span class="c1"># 首先找到相邻且左偏的点坐标，分为x和y</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a>    <span class="n">x_idx</span><span class="p">,</span><span class="n">y_idx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">b</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">int64</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">b</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">int64</span><span class="p">)</span> 
<a id="__codelineno-7-18" name="__codelineno-7-18"></a>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a>    <span class="c1"># 接着计算差值  </span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a>    <span class="n">_x</span><span class="p">,</span><span class="n">_y</span><span class="o">=</span><span class="n">b</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x_idx</span><span class="p">,</span><span class="n">b</span><span class="p">[:,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y_idx</span>  
<a id="__codelineno-7-21" name="__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a>    <span class="c1">#在_x,_y上添加空的C轴，以匹配a</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a>    <span class="n">_x</span><span class="o">=</span><span class="n">_x</span><span class="p">[:,:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a>    <span class="n">_y</span><span class="o">=</span><span class="n">_y</span><span class="p">[:,:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  
<a id="__codelineno-7-25" name="__codelineno-7-25"></a>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a>    <span class="n">new_n</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a>    <span class="c1"># 直接套公式  </span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a>    <span class="c1"># res=(a[:,x_idx,y_idx]*(1-_x)*(1-_y)+a[:,x_idx+1,y_idx]*_x*(1-_y)+a[:, x_idx, y_idx + 1] * (1 - _x) * _y + a[:, x_idx + 1, y_idx + 1] * _x * _y).astype(int64)</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a>    <span class="n">res</span><span class="o">=</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">new_n</span><span class="p">,</span><span class="n">x_idx</span><span class="p">,</span><span class="n">y_idx</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">_x</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">_y</span><span class="p">)</span><span class="o">+</span><span class="n">a</span><span class="p">[</span><span class="n">new_n</span><span class="p">,</span><span class="n">x_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">y_idx</span><span class="p">]</span><span class="o">*</span><span class="n">_x</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">_y</span><span class="p">)</span><span class="o">+</span><span class="n">a</span><span class="p">[</span><span class="n">new_n</span><span class="p">,</span> <span class="n">x_idx</span><span class="p">,</span> <span class="n">y_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">_y</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">new_n</span><span class="p">,</span> <span class="n">x_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">_x</span> <span class="o">*</span> <span class="n">_y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">int64</span><span class="p">)</span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a>
<a id="__codelineno-7-33" name="__codelineno-7-33"></a>    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div></p>
<h4 id="244">2.4.4 检测实现正确与加速效果<a class="headerlink" href="#244" title="Permanent link">&para;</a></h4>
<p>运行 <code>main.py</code>，查看输出，一切顺利将看到以下结果：<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span>
<span class="normal"><a href="#__codelineno-8-2">2</a></span>
<span class="normal"><a href="#__codelineno-8-3">3</a></span>
<span class="normal"><a href="#__codelineno-8-4">4</a></span>
<span class="normal"><a href="#__codelineno-8-5">5</a></span>
<span class="normal"><a href="#__codelineno-8-6">6</a></span>
<span class="normal"><a href="#__codelineno-8-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a>Generating<span class="w"> </span>Data...
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>Executing<span class="w"> </span>Baseline<span class="w"> </span>Implementation...
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>Finished<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">139</span>.50709176063538s
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>Executing<span class="w"> </span>Vectorized<span class="w"> </span>Implementation...
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>Finished<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">4</span>.717759132385254s
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="o">[</span>PASSED<span class="o">]</span><span class="w"> </span>Results<span class="w"> </span>are<span class="w"> </span>identical.
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>Speed<span class="w"> </span>Up<span class="w"> </span><span class="m">29</span>.570626190511327x
</code></pre></div></td></tr></table></div>
否则将会触发异常：<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a>Traceback<span class="w"> </span><span class="o">(</span>most<span class="w"> </span>recent<span class="w"> </span>call<span class="w"> </span>last<span class="o">)</span>:
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">  </span>File<span class="w"> </span><span class="s2">&quot;Introduction-Labs-2021/lab2_vectors/main.py&quot;</span>,<span class="w"> </span>line<span class="w"> </span><span class="m">28</span>,<span class="w"> </span><span class="k">in</span><span class="w"> </span>&lt;module&gt;
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">    </span>raise<span class="w"> </span>Exception<span class="o">(</span><span class="s1">&#39;Results are different!&#39;</span><span class="o">)</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>Exception:<span class="w"> </span>Results<span class="w"> </span>are<span class="w"> </span>different!
</code></pre></div></td></tr></table></div>
其中，耗时与加速比与你的实现和设备有关（主要是实现）。请在报告中将你的运行结果贴出。</p>
<p><img alt="alt text" src="../image-84.png" /></p>
<h3 id="25">2.5 实验初始代码<a class="headerlink" href="#25" title="Permanent link">&para;</a></h3>
<p><a href="https://git.zju.edu.cn/zjusct/summer_hpc101_2024/hpc-101-labs-2024/-/tree/main/docs/Lab2-Vectors/starter_code">starter_code</a>  </p>
<hr />
<p>接下来让我们回到lab1，回到Linux，去学习Docker并完成lab1的bonus(尝试)  </p>
<h2 id="lab1-bonus">Lab1 bonus<a class="headerlink" href="#lab1-bonus" title="Permanent link">&para;</a></h2>
<p>在Lab文档中Docker的部分是确实的，仅给出了bonus的任务要求</p>
<p>使用Docker复现实验：
- [ ] 寻找合适的 Docker<br />
- [ ] 创建多个 Docker 实例，使用 MPI 在 Docker 组成的集群中运行 HPL。  </p>
<p>所以我们将完全遵循<a href="https://101.lug.ustc.edu.cn/Ch08/">中科大Linux 101（八、Docker）</a> 的学习路径，学习Docker  </p>
<h3 id="31-docker">3.1 Docker<a class="headerlink" href="#31-docker" title="Permanent link">&para;</a></h3>
<h4 id="311-docker">3.1.1 为什么使用Docker<a class="headerlink" href="#311-docker" title="Permanent link">&para;</a></h4>
<p>「容器」，是近年来非常热门的一个概念。它通过<strong>操作系统内核提供的隔离技术</strong>，<strong>实现轻量级的虚拟化环境</strong>。目前，它在软件的开发、部署等方面有着非常广泛的应用。
而 Docker，是 Linux 容器技术中的代表性软件，它为用户提供了方便的接口来创建、使用 Linux 容器。</p>
<p><u>Docker能够利用Linux内核的容器特性，隔离出一个轻便的环境来运行程序，由此可以快速配置不同的环境</u>（比如说，通过Docker，你可以在Ubuntu上使用CentOS的环境），部署应用  </p>
<h4 id="312-docker">3.1.2 安装Docker<a class="headerlink" href="#312-docker" title="Permanent link">&para;</a></h4>
<h5 id="windowsmacos">在Windows或macOS上安装<a class="headerlink" href="#windowsmacos" title="Permanent link">&para;</a></h5>
<p>Docker使用了Linux内核的容器特性，所以依赖于Linux，要在这两个系统运行，必须通过虚拟虚拟Linux内核的方式，可以使用一套Docker Desktop的软件，具体内容见文档  </p>
<h5 id="linux">在Linux上安装<a class="headerlink" href="#linux" title="Permanent link">&para;</a></h5>
<p>首先给出Docker install的<a href="https://docs.docker.com/engine/install/debian/">官方文档</a> </p>
<blockquote>
<p>注意，在Debian/Ubuntu上，<strong>不要运行 <code>sudo apt install docker</code></strong> 此时安装的是一个系统托盘程序，和这里的Docker没有关系  </p>
</blockquote>
<p><code>docker.op</code> 是由Debian/Ubuntu维护的Docker版本，比官方最新版稍微老一点<br />
<code>docker-ce</code> 是由Docker官方维护的。它依赖的程序库都被打包在这个包中  </p>
<p>Docker官方提供的Docker社区版建议安装脚本<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://get.docker.com<span class="w"> </span>-o<span class="w"> </span>get-docker.sh
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>sudo<span class="w"> </span>sh<span class="w"> </span>get-docker.sh
</code></pre></div></td></tr></table></div></p>
<blockquote>
<p>这里有个小插曲，想下载curl发现虚拟机连不上网，最后发现是因为使用了梯子没把梯子关掉直接关机了，这里可以采用以下方法：<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span>
<span class="normal"><a href="#__codelineno-11-2">2</a></span>
<span class="normal"><a href="#__codelineno-11-3">3</a></span>
<span class="normal"><a href="#__codelineno-11-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1">#重启虚拟机网络服务器：ctrl+alt+t打开虚拟机命令终端，依次输入以下指令：</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>sudo<span class="w"> </span>service<span class="w"> </span>network-manager<span class="w"> </span>stop
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>sudo<span class="w"> </span>rm<span class="w"> </span>/var/lib/NetworkManager/NetworkManager.state
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>sudo<span class="w"> </span>service<span class="w"> </span>network-manager<span class="w"> </span>start
</code></pre></div></td></tr></table></div>
尝试了一下，用不了，得用镜像网站，所以最后找了篇<a href="https://blog.csdn.net/Tester_muller/article/details/131440306?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172068150016800213054395%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=172068150016800213054395&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-131440306-null-null.142^v100^pc_search_result_base8&amp;utm_term=ubuntu%E5%AE%89%E8%A3%85docker&amp;spm=1018.2226.3001.4187">CSDN文章</a> 跟着下的<br />
<img alt="alt text" src="../image-85.png" /></p>
</blockquote>
<h5 id="registry-mirror">配置Registry Mirror<a class="headerlink" href="#registry-mirror" title="Permanent link">&para;</a></h5>
<p>Docker 默认从 Docker Hub 上拖取所需要的镜像。但由于网络原因，拖取的过程可能会比较慢。一些服务在中国提供了 Docker Hub 的镜像（反代缓存）。以下内容以网易云与百度云为例。  </p>
<p>为了使用这些Docker Hub镜像，在Ubuntu上可以编辑 <code>/etc/docker/daemon.json</code> 文件（如果文件不存在，请新建一个），写入以下内容<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span>
<span class="normal"><a href="#__codelineno-12-4">4</a></span>
<span class="normal"><a href="#__codelineno-12-5">5</a></span>
<span class="normal"><a href="#__codelineno-12-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="o">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">  </span><span class="s2">&quot;registry-mirrors&quot;</span>:<span class="w"> </span><span class="o">[</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="s2">&quot;https://hub-mirror.c.163.com&quot;</span>,
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="s2">&quot;https://mirror.baidubce.com&quot;</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">  </span><span class="o">]</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="o">}</span>
</code></pre></div></td></tr></table></div>
使用 <code>sudo systemctl restart docker</code> 重启Docker服务，再次运行 <code>docker info</code> 命令，可以看到<br />
<img alt="alt text" src="../image-86.png" /><br />
说明Docker Registry Mirror已经配置好了  </p>
<h5 id="hello-worlddocker">使用Hello World测试Docker安装<a class="headerlink" href="#hello-worlddocker" title="Permanent link">&para;</a></h5>
<p>尝试运行 <code>docker run --rm hello-world</code> 拉取hello-world镜像，但是没用成功  </p>
<p><img alt="alt text" src="../image-87.png" />  </p>
<p>文档里给出的<a href="https://docker.mirrors.ustc.edu.cn/">科大镜像站Docker Hub registry mirror</a> 需要校园网，所以在98（<a href="https://www.cc98.org/topic/5938562">原贴</a>）上找了<a href="https://git.zju.edu.cn/-o-/dh">浙大的镜像站</a>  </p>
<p>进入之后启用服务<br />
登录命令<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a>docker<span class="w"> </span>login<span class="w"> </span>dockerhub.zjusct.io<span class="w"> </span>-u<span class="w"> </span><span class="m">3230102778</span><span class="w"> </span>-p<span class="w"> </span>ntjaz3okt2vti2f28a0r3qdl188fyuzl<span class="w">  </span>
</code></pre></div></td></tr></table></div>
使用镜像域名，设置 <code>/etc/docker/daemon.json</code> 为：<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="o">{</span><span class="w"> </span><span class="s2">&quot;registry-mirrors&quot;</span>:<span class="w"> </span><span class="o">[</span><span class="s2">&quot;https://3230102778-ntjaz3okt2vti2f28a0r3qdl188fyuzl.dockerhub.zjusct.io&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">}</span>
</code></pre></div></td></tr></table></div>
值得一提的是，浙大镜像站给出的拉取镜像示例是<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a>docker<span class="w"> </span>pull<span class="w"> </span>ubuntu:24.04<span class="w"> </span>改为<span class="w"> </span>docker<span class="w"> </span>pull<span class="w"> </span>dockerhub.zjusct.io/library/ubuntu:24.04<span class="w">   </span>
</code></pre></div></td></tr></table></div>
但其实两种都可以拉取<br />
<img alt="alt text" src="../image-88.png" /><br />
不过这不重要  </p>
<p>尝试运行 <code>docker run --rm hello-world</code> 命令<br />
<img alt="alt text" src="../image-89.png" /><br />
说明Docker已经一切就绪  </p>
<h4 id="313-docker">3.1.3 使用Docker<a class="headerlink" href="#313-docker" title="Permanent link">&para;</a></h4>
<h5 id="ubuntushell">在Ubuntu容器中使用shell<a class="headerlink" href="#ubuntushell" title="Permanent link">&para;</a></h5>
<p>首先看一段命令<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>--name<span class="w"> </span>ubuntu-container<span class="w"> </span>unbuntu:20.04
</code></pre></div></td></tr></table></div>
其中<br />
<code>--rm</code> 代表容器停止运行（退出）后会被删除<br />
<code>--name</code> 参数代表给容器起名字，如果没有这个参数，那么docker会给容器随机起一个给是类似于gracious_brahmagupta的名字<br />
<code>-it</code> 是为了获得可交互式的Shell所必须的。<code>-i</code>会将容器的init（主进程，这里是 <code>/bin/bash</code> ）的标准输入与docker这个程序的标准输入相连接；而 <code>-t</code> 会告诉主进程输入为终端（TTY）设备  </p>
<p>在执行这行命令后，会得到一个Ubuntu20.04的容器环境，退出Shell后容器会被销毁  </p>
<p>如果没有加上 <code>--rm</code> ，退出后可以使用 <code>docker ps -a</code> 查看系统中的所有容器  </p>
<blockquote>
<p>P.S 事实证明还是要挂镜像来下载，比如下载ubuntu容器环境 <code>docker run -it --rm --name ubuntu-container dockerhub.zjusct.io/library/ubuntu:24.04</code> </p>
</blockquote>
<p><img alt="alt text" src="../image-90.png" />  </p>
<p><code>exit</code> 可以直接退出容器  </p>
<p>使用
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a>docker<span class="w"> </span>start<span class="w"> </span>-ai<span class="w"> </span>ubuntu-container<span class="w">  </span>
</code></pre></div></td></tr></table></div>
启动容器。其中， <code>-a</code> 代表连接输出以及信号。最后的 <code>ubuntu-container</code> 指代我们刚刚创建的那个容器。也可以输入容器的ID来启动（不需要输入完整ID，只需要前几位即可）：<br />
<img alt="alt text" src="../image-91.png" /><br />
与 <code>docker start</code> 相对应，<code>docker stop</code> 可以关闭一个容器， <code>docker rm</code> 可以删除一个容器<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a>docker<span class="w"> </span>stop<span class="w"> </span>ubuntu-container<span class="w">  </span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a>docker<span class="w"> </span>stop<span class="w"> </span>ubuntu-container<span class="w">  </span>
</code></pre></div></td></tr></table></div></p>
<h5 id="pythonpython">在Python容器中使用Python命令行<a class="headerlink" href="#pythonpython" title="Permanent link">&para;</a></h5>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--name<span class="w"> </span>python3<span class="w"> </span>python<span class="w">  </span>
</code></pre></div></td></tr></table></div>
执行后会获得一个Python3环境</p>
<h5 id="mkdocs">在MkDocs容器运行文档<a class="headerlink" href="#mkdocs" title="Permanent link">&para;</a></h5>
<p>（略）  </p>
<h3 id="32-dockerlab1">3.2 尝试使用Docker复现Lab1<a class="headerlink" href="#32-dockerlab1" title="Permanent link">&para;</a></h3>
<p>其实我完全还不清楚要怎么用Docker来复现集群的搭建，但我觉得Docker和虚拟机应该是十分类似的，我的基本想法是：在一个ubuntu容器中搭建一个类似之前The one一样的主节点，把它创建成镜像。用这个镜像再创建三个容器（类似于克隆虚拟机），让他们互相ping通，形成集群  </p>
<h4 id="321-ubuntu-containerthe-one">3.2.1 在ubuntu-container容器中复现The one的环境<a class="headerlink" href="#321-ubuntu-containerthe-one" title="Permanent link">&para;</a></h4>
<p>基本和Lab1中对The one的配置一样，不过一进去的时候所在的位置是root，为了完全与之前的流程一致，我cd到了home目录下的ubuntu路径下去执行操作。  </p>
<p>ubuntu—container创建的时候只有root用户，这是十分危险的，所以还是先创建一个用户为好  </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a>useradd<span class="w"> </span>-m<span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>lee<span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p>之后 <code>su lee</code> 切换用户  </p>
<p>神奇的是，这个容器居然没有sudo命令，我用lee的身份去cp文件，居然permission denied。只能exit到root用户去装了一个sudo，后面又设定了一下lee用户的密码  </p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a>passwd<span class="w"> </span>lee
</code></pre></div></td></tr></table></div>
还需要把lee添加到sudoers file中
这一步需要root用户权限，打开 <code>/etc/sudoers</code> ，添加
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a>lee<span class="w"> </span><span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span><span class="w"> </span>ALL
</code></pre></div></td></tr></table></div>
之后就可以正常使用了  </p>
<p><img alt="alt text" src="../image-92.png" /></p>
<p>在配置CBLAS进行make的时候，本来的warning变成了error，需要在Makefile.in中对编译选项进行修改<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="nv">FC</span><span class="o">=</span>gfortran<span class="w"> </span>--&gt;<span class="w"> </span><span class="nv">FC</span><span class="o">=</span>gfortran<span class="w"> </span>-fallow-argument-mismatch
</code></pre></div></td></tr></table></div>
忽略这个报错，之后就可以正常make  </p>
<p>之后的构建与之前完全一致，但在测试OpenMPI的时候出现了问题  </p>
<p><img alt="alt text" src="../image-93.png" /></p>
<p>由于时间问题，该报错仍然没有解决</p>
<h4 id="322">3.2.2 手动构建镜像<a class="headerlink" href="#322" title="Permanent link">&para;</a></h4>
<p>由于使用Dockerfile自动构建镜像（较为推荐的路径）需要一定的学习，这里就先尝试手动构建  </p>
<p>先从之前的镜像退出来，查看当前容器的情况<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a>docker<span class="w"> </span>ps<span class="w"> </span>-a
</code></pre></div></td></tr></table></div></p>
<p><img alt="alt text" src="../image-94.png" />  </p>
<p>手动构建<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a>docker<span class="w"> </span>commit<span class="w"> </span>83bdd6e6831e
</code></pre></div></td></tr></table></div>
<img alt="alt text" src="../image-95.png" />  </p>
<p>这样就可以在 <code>images</code> 中看到这个镜像  </p>
<p><img alt="alt text" src="../image-96.png" />  </p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a>docker<span class="w"> </span>save<span class="w"> </span>2325aae77464<span class="w"> </span>&gt;<span class="w"> </span>node.tar
</code></pre></div></td></tr></table></div>
node.tar就是我们的镜像（但我真不知道怎么加载它） </p>
<p>我们可以用<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--name<span class="w"> </span>node01<span class="w"> </span>2325aae77464<span class="w"> </span>
</code></pre></div></td></tr></table></div>
来生成一个使用该镜像的容器  </p>
<p><img alt="alt text" src="../image-97.png" />  </p>
<p>但是在容器之间的网络问题上完全没有相关知识，所以bonus到这里也确实进行不下去了，先这样吧</p>
<hr />
<h2 id="lab25-bonus-simd">Lab2.5-Bonus 手写 SIMD 向量化<a class="headerlink" href="#lab25-bonus-simd" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 实验基础知识<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<p>现代处理器一般都支持向量化指令，x86 架构下 Intel 和 AMD 两家的处理器都提供了诸如 <u>SSE，AVX 等 SIMD 指令集</u>，一条指令可以同时操作多个数据进行运算，大大提高了现代处理器的数据吞吐量。  </p>
<p>现代编译器的高等级优化下会自动向量化，对于结构清晰，循环边界清晰的程序，编译器的自动向量化已经可以达到很优秀的程度了。然而，编译器的优化始终是保守的，很多情况下编译器无法完成使用 SIMD 指令进行向量化的工作  </p>
<p>显然直接手写汇编指令过于困难，在 C 语言环境下，Intel 提供了一整套关于 SIMD 指令的函数封装接口和指令相关行为的<a href="https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html">参照手册</a>  </p>
<p>调用这些函数API(Application Programming Interface，应用程序编程接口)需要include相应头文件，如  </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">1</a></span>
<span class="normal"><a href="#__codelineno-28-2">2</a></span>
<span class="normal"><a href="#__codelineno-28-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;smmintrin.h&gt;</span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;emmintrin.h&gt;</span>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;immintrin.h&gt;</span>
</code></pre></div></td></tr></table></div>
<p>这个级别的优化开始需要考虑具体<u>处理器的体系结构基础细节</u>，如某个<em>架构下某条指令的实现延时和吞吐量</em>是多少，<em>处理器提供了多少向量寄存器</em>，<em>访存的对齐</em>等等。  </p>
<p>这种时候编译器具体产生的汇编代码能比 C 语言代码提供更多的信息，你能了解到自己使用了多少寄存器，编译器是否生成了预期外的代码等等。  </p>
<h3 id="42">4.2 实验步骤<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<p>题目的格式好像有点问题，看不完整  </p>
<p>baseline如下, 简单来说就是进行MAXN次D<sub>4*4</sub>=A<sub>4*12</sub><span class="arithmatex">\(\times\)</span>B<sub>12∗4</sub>的矩阵乘法. 其中MAXN个矩阵的内容不同, 计算的时候要注意位移  </p>
<p>在编译时添加以下选项可以允许编译器生成使用 AVX2 和 FMA 指令集的代码，如果你使用了其它不在编译器默认范围内的指令集，类似的编译选项是必要的。  </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a>-mavx2<span class="w"> </span>-mfma
</code></pre></div></td></tr></table></div>
<h4 id="421-multicpp">4.2.1 实验初始代码 <code>multi.cpp</code><a class="headerlink" href="#421-multicpp" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span>
<span class="normal"><a href="#__codelineno-30-14">14</a></span>
<span class="normal"><a href="#__codelineno-30-15">15</a></span>
<span class="normal"><a href="#__codelineno-30-16">16</a></span>
<span class="normal"><a href="#__codelineno-30-17">17</a></span>
<span class="normal"><a href="#__codelineno-30-18">18</a></span>
<span class="normal"><a href="#__codelineno-30-19">19</a></span>
<span class="normal"><a href="#__codelineno-30-20">20</a></span>
<span class="normal"><a href="#__codelineno-30-21">21</a></span>
<span class="normal"><a href="#__codelineno-30-22">22</a></span>
<span class="normal"><a href="#__codelineno-30-23">23</a></span>
<span class="normal"><a href="#__codelineno-30-24">24</a></span>
<span class="normal"><a href="#__codelineno-30-25">25</a></span>
<span class="normal"><a href="#__codelineno-30-26">26</a></span>
<span class="normal"><a href="#__codelineno-30-27">27</a></span>
<span class="normal"><a href="#__codelineno-30-28">28</a></span>
<span class="normal"><a href="#__codelineno-30-29">29</a></span>
<span class="normal"><a href="#__codelineno-30-30">30</a></span>
<span class="normal"><a href="#__codelineno-30-31">31</a></span>
<span class="normal"><a href="#__codelineno-30-32">32</a></span>
<span class="normal"><a href="#__codelineno-30-33">33</a></span>
<span class="normal"><a href="#__codelineno-30-34">34</a></span>
<span class="normal"><a href="#__codelineno-30-35">35</a></span>
<span class="normal"><a href="#__codelineno-30-36">36</a></span>
<span class="normal"><a href="#__codelineno-30-37">37</a></span>
<span class="normal"><a href="#__codelineno-30-38">38</a></span>
<span class="normal"><a href="#__codelineno-30-39">39</a></span>
<span class="normal"><a href="#__codelineno-30-40">40</a></span>
<span class="normal"><a href="#__codelineno-30-41">41</a></span>
<span class="normal"><a href="#__codelineno-30-42">42</a></span>
<span class="normal"><a href="#__codelineno-30-43">43</a></span>
<span class="normal"><a href="#__codelineno-30-44">44</a></span>
<span class="normal"><a href="#__codelineno-30-45">45</a></span>
<span class="normal"><a href="#__codelineno-30-46">46</a></span>
<span class="normal"><a href="#__codelineno-30-47">47</a></span>
<span class="normal"><a href="#__codelineno-30-48">48</a></span>
<span class="normal"><a href="#__codelineno-30-49">49</a></span>
<span class="normal"><a href="#__codelineno-30-50">50</a></span>
<span class="normal"><a href="#__codelineno-30-51">51</a></span>
<span class="normal"><a href="#__codelineno-30-52">52</a></span>
<span class="normal"><a href="#__codelineno-30-53">53</a></span>
<span class="normal"><a href="#__codelineno-30-54">54</a></span>
<span class="normal"><a href="#__codelineno-30-55">55</a></span>
<span class="normal"><a href="#__codelineno-30-56">56</a></span>
<span class="normal"><a href="#__codelineno-30-57">57</a></span>
<span class="normal"><a href="#__codelineno-30-58">58</a></span>
<span class="normal"><a href="#__codelineno-30-59">59</a></span>
<span class="normal"><a href="#__codelineno-30-60">60</a></span>
<span class="normal"><a href="#__codelineno-30-61">61</a></span>
<span class="normal"><a href="#__codelineno-30-62">62</a></span>
<span class="normal"><a href="#__codelineno-30-63">63</a></span>
<span class="normal"><a href="#__codelineno-30-64">64</a></span>
<span class="normal"><a href="#__codelineno-30-65">65</a></span>
<span class="normal"><a href="#__codelineno-30-66">66</a></span>
<span class="normal"><a href="#__codelineno-30-67">67</a></span>
<span class="normal"><a href="#__codelineno-30-68">68</a></span>
<span class="normal"><a href="#__codelineno-30-69">69</a></span>
<span class="normal"><a href="#__codelineno-30-70">70</a></span>
<span class="normal"><a href="#__codelineno-30-71">71</a></span>
<span class="normal"><a href="#__codelineno-30-72">72</a></span>
<span class="normal"><a href="#__codelineno-30-73">73</a></span>
<span class="normal"><a href="#__codelineno-30-74">74</a></span>
<span class="normal"><a href="#__codelineno-30-75">75</a></span>
<span class="normal"><a href="#__codelineno-30-76">76</a></span>
<span class="normal"><a href="#__codelineno-30-77">77</a></span>
<span class="normal"><a href="#__codelineno-30-78">78</a></span>
<span class="normal"><a href="#__codelineno-30-79">79</a></span>
<span class="normal"><a href="#__codelineno-30-80">80</a></span>
<span class="normal"><a href="#__codelineno-30-81">81</a></span>
<span class="normal"><a href="#__codelineno-30-82">82</a></span>
<span class="normal"><a href="#__codelineno-30-83">83</a></span>
<span class="normal"><a href="#__codelineno-30-84">84</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
<a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>
<a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<a id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;smmintrin.h&gt;</span>
<a id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;emmintrin.h&gt;</span>
<a id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;immintrin.h&gt;</span>
<a id="__codelineno-30-9" name="__codelineno-30-9"></a>
<a id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="cp">#define MAXN 10000000</span>
<a id="__codelineno-30-11" name="__codelineno-30-11"></a>
<a id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="p">;</span>
<a id="__codelineno-30-13" name="__codelineno-30-13"></a><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
<a id="__codelineno-30-14" name="__codelineno-30-14"></a><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">;</span>
<a id="__codelineno-30-15" name="__codelineno-30-15"></a><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">d</span><span class="p">;</span>
<a id="__codelineno-30-16" name="__codelineno-30-16"></a>
<a id="__codelineno-30-17" name="__codelineno-30-17"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<a id="__codelineno-30-18" name="__codelineno-30-18"></a><span class="p">{</span>
<a id="__codelineno-30-19" name="__codelineno-30-19"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Initializing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-30-20" name="__codelineno-30-20"></a><span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4*12</span>
<a id="__codelineno-30-21" name="__codelineno-30-21"></a><span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="p">);</span><span class="w"> </span><span class="c1">// 12*4</span>
<a id="__codelineno-30-22" name="__codelineno-30-22"></a><span class="w">    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4*4</span>
<a id="__codelineno-30-23" name="__codelineno-30-23"></a><span class="w">    </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4*4</span>
<a id="__codelineno-30-24" name="__codelineno-30-24"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<a id="__codelineno-30-25" name="__codelineno-30-25"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<a id="__codelineno-30-26" name="__codelineno-30-26"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w">  </span><span class="c1">//initialize</span>
<a id="__codelineno-30-27" name="__codelineno-30-27"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-30-28" name="__codelineno-30-28"></a><span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-30-29" name="__codelineno-30-29"></a><span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-30-30" name="__codelineno-30-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-31" name="__codelineno-30-31"></a>
<a id="__codelineno-30-32" name="__codelineno-30-32"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Raw computing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-30-33" name="__codelineno-30-33"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<a id="__codelineno-30-34" name="__codelineno-30-34"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAXN</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-30-35" name="__codelineno-30-35"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-30-36" name="__codelineno-30-36"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-30-37" name="__codelineno-30-37"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-30-38" name="__codelineno-30-38"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-30-39" name="__codelineno-30-39"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-30-40" name="__codelineno-30-40"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-30-41" name="__codelineno-30-41"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-30-42" name="__codelineno-30-42"></a><span class="w">                    </span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
<a id="__codelineno-30-43" name="__codelineno-30-43"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-30-44" name="__codelineno-30-44"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-30-45" name="__codelineno-30-45"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-30-46" name="__codelineno-30-46"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-47" name="__codelineno-30-47"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<a id="__codelineno-30-48" name="__codelineno-30-48"></a>
<a id="__codelineno-30-49" name="__codelineno-30-49"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">time1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<a id="__codelineno-30-50" name="__codelineno-30-50"></a>
<a id="__codelineno-30-51" name="__codelineno-30-51"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;New computing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-30-52" name="__codelineno-30-52"></a><span class="w">    </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<a id="__codelineno-30-53" name="__codelineno-30-53"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAXN</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-30-54" name="__codelineno-30-54"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-30-55" name="__codelineno-30-55"></a><span class="w">        </span><span class="cm">/* 可以修改的代码区域 */</span>
<a id="__codelineno-30-56" name="__codelineno-30-56"></a><span class="w">        </span><span class="c1">// -----------------------------------</span>
<a id="__codelineno-30-57" name="__codelineno-30-57"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-30-58" name="__codelineno-30-58"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-30-59" name="__codelineno-30-59"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-30-60" name="__codelineno-30-60"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-30-61" name="__codelineno-30-61"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-30-62" name="__codelineno-30-62"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-30-63" name="__codelineno-30-63"></a><span class="w">                    </span><span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
<a id="__codelineno-30-64" name="__codelineno-30-64"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-30-65" name="__codelineno-30-65"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-30-66" name="__codelineno-30-66"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-30-67" name="__codelineno-30-67"></a><span class="w">        </span><span class="c1">// -----------------------------------</span>
<a id="__codelineno-30-68" name="__codelineno-30-68"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-69" name="__codelineno-30-69"></a>
<a id="__codelineno-30-70" name="__codelineno-30-70"></a><span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<a id="__codelineno-30-71" name="__codelineno-30-71"></a>
<a id="__codelineno-30-72" name="__codelineno-30-72"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">time2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<a id="__codelineno-30-73" name="__codelineno-30-73"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;raw time=%lfs</span><span class="se">\n</span><span class="s">new time=%lfs</span><span class="se">\n</span><span class="s">speed up:%lfx</span><span class="se">\n</span><span class="s">Checking</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">time1</span><span class="p">,</span><span class="w"> </span><span class="n">time2</span><span class="p">,</span><span class="w"> </span><span class="n">time1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">time2</span><span class="p">);</span>
<a id="__codelineno-30-74" name="__codelineno-30-74"></a>
<a id="__codelineno-30-75" name="__codelineno-30-75"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-30-76" name="__codelineno-30-76"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-30-77" name="__codelineno-30-77"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0001</span><span class="p">)</span>
<a id="__codelineno-30-78" name="__codelineno-30-78"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-30-79" name="__codelineno-30-79"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Check Failed at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<a id="__codelineno-30-80" name="__codelineno-30-80"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-30-81" name="__codelineno-30-81"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-30-82" name="__codelineno-30-82"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-83" name="__codelineno-30-83"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Check Passed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-30-84" name="__codelineno-30-84"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>看完baseline发现是老熟人了，这其实就是SEGMM，只不过在PAC比赛里支持的是ARM指令集，而在这里要用AVX指令集，而且这里的矩阵规模是确定的，行数和列数都是4的倍数，结果矩阵就是一个4<span class="arithmatex">\(\times\)</span>4的矩阵，不需要处理boundary case。只需要学习一下AVX指令集，做一个替换就好。  </p>
<h4 id="422-avx">4.2.2 AVX指令集<a class="headerlink" href="#422-avx" title="Permanent link">&para;</a></h4>
<p>最权威的当然是<a href="https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html">官方文档</a>，简单查找也可以看<a href="https://blog.csdn.net/nbu_dahe/article/details/122157205?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172163326016800186536619%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=172163326016800186536619&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-122157205-null-null.142^v100^pc_search_result_base8&amp;utm_term=avx%E6%8C%87%E4%BB%A4%E9%9B%86&amp;spm=1018.2226.3001.4187">CSDN</a>  </p>
<p>这里只列举代码中使用到的:  </p>
<p><code>_mm256_setzero_pd</code><br />
<img alt="alt text" src="../image-98.png" />  </p>
<p><code>_mm256_loadu_pd</code><br />
<img alt="alt text" src="../image-99.png" />  </p>
<p><code>_mm256_set1_pd</code><br />
<img alt="alt text" src="../image-100.png" />  </p>
<p><code>_mm256_fmadd_pd</code><br />
<img alt="alt text" src="../image-101.png" />  </p>
<p><code>_mm256_storeu_pd</code><br />
<img alt="alt text" src="../image-102.png" />  </p>
<h4 id="423">4.2.3 优化思路<a class="headerlink" href="#423" title="Permanent link">&para;</a></h4>
<p>效率角度来说用AVX-512同时进行8个double数的运算效率应该会更高，但考虑到a，b矩阵分别固定为4<span class="arithmatex">\(\times\)</span>12和12<span class="arithmatex">\(\times\)</span>4的规模，行数和列数都是4的倍数，我选择了_m256d的数据类型，同时进行4个double数的向量运算。  </p>
<p>由于结果矩阵本身就是4<span class="arithmatex">\(\times\)</span>4的规模，也就意味着a矩阵的block就是4<span class="arithmatex">\(\times\)</span>12，b矩阵的block就是12<span class="arithmatex">\(\times\)</span>4，都只需要扫描读取一次，因此没有packing的必要。  </p>
<p><strong>优化后的代码multi_pro.cpp</strong><br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1">  1</a></span>
<span class="normal"><a href="#__codelineno-31-2">  2</a></span>
<span class="normal"><a href="#__codelineno-31-3">  3</a></span>
<span class="normal"><a href="#__codelineno-31-4">  4</a></span>
<span class="normal"><a href="#__codelineno-31-5">  5</a></span>
<span class="normal"><a href="#__codelineno-31-6">  6</a></span>
<span class="normal"><a href="#__codelineno-31-7">  7</a></span>
<span class="normal"><a href="#__codelineno-31-8">  8</a></span>
<span class="normal"><a href="#__codelineno-31-9">  9</a></span>
<span class="normal"><a href="#__codelineno-31-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-31-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-31-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-31-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-31-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-31-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-31-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-31-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-31-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-31-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-31-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-31-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-31-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-31-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-31-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-31-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-31-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-31-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-31-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-31-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-31-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-31-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-31-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-31-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-31-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-31-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-31-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-31-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-31-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-31-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-31-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-31-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-31-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-31-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-31-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-31-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-31-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-31-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-31-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-31-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-31-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-31-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-31-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-31-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-31-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-31-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-31-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-31-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-31-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-31-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-31-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-31-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-31-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-31-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-31-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-31-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-31-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-31-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-31-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-31-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-31-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-31-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-31-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-31-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-31-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-31-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-31-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-31-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-31-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-31-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-31-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-31-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-31-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-31-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-31-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-31-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-31-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-31-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-31-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-31-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-31-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-31-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-31-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-31-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-31-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-31-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-31-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-31-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-31-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-31-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-31-100">100</a></span>
<span class="normal"><a href="#__codelineno-31-101">101</a></span>
<span class="normal"><a href="#__codelineno-31-102">102</a></span>
<span class="normal"><a href="#__codelineno-31-103">103</a></span>
<span class="normal"><a href="#__codelineno-31-104">104</a></span>
<span class="normal"><a href="#__codelineno-31-105">105</a></span>
<span class="normal"><a href="#__codelineno-31-106">106</a></span>
<span class="normal"><a href="#__codelineno-31-107">107</a></span>
<span class="normal"><a href="#__codelineno-31-108">108</a></span>
<span class="normal"><a href="#__codelineno-31-109">109</a></span>
<span class="normal"><a href="#__codelineno-31-110">110</a></span>
<span class="normal"><a href="#__codelineno-31-111">111</a></span>
<span class="normal"><a href="#__codelineno-31-112">112</a></span>
<span class="normal"><a href="#__codelineno-31-113">113</a></span>
<span class="normal"><a href="#__codelineno-31-114">114</a></span>
<span class="normal"><a href="#__codelineno-31-115">115</a></span>
<span class="normal"><a href="#__codelineno-31-116">116</a></span>
<span class="normal"><a href="#__codelineno-31-117">117</a></span>
<span class="normal"><a href="#__codelineno-31-118">118</a></span>
<span class="normal"><a href="#__codelineno-31-119">119</a></span>
<span class="normal"><a href="#__codelineno-31-120">120</a></span>
<span class="normal"><a href="#__codelineno-31-121">121</a></span>
<span class="normal"><a href="#__codelineno-31-122">122</a></span>
<span class="normal"><a href="#__codelineno-31-123">123</a></span>
<span class="normal"><a href="#__codelineno-31-124">124</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<a id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
<a id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<a id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>
<a id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<a id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;smmintrin.h&gt;</span>
<a id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;emmintrin.h&gt;</span>
<a id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;immintrin.h&gt;</span>
<a id="__codelineno-31-9" name="__codelineno-31-9"></a>
<a id="__codelineno-31-10" name="__codelineno-31-10"></a><span class="cp">#define MAXN 10000000</span>
<a id="__codelineno-31-11" name="__codelineno-31-11"></a>
<a id="__codelineno-31-12" name="__codelineno-31-12"></a><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="p">;</span>
<a id="__codelineno-31-13" name="__codelineno-31-13"></a><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
<a id="__codelineno-31-14" name="__codelineno-31-14"></a><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="p">;</span>
<a id="__codelineno-31-15" name="__codelineno-31-15"></a><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">d</span><span class="p">;</span>
<a id="__codelineno-31-16" name="__codelineno-31-16"></a>
<a id="__codelineno-31-17" name="__codelineno-31-17"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<a id="__codelineno-31-18" name="__codelineno-31-18"></a><span class="p">{</span>
<a id="__codelineno-31-19" name="__codelineno-31-19"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Initializing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-31-20" name="__codelineno-31-20"></a><span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4*12</span>
<a id="__codelineno-31-21" name="__codelineno-31-21"></a><span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="p">);</span><span class="w"> </span><span class="c1">// 12*4</span>
<a id="__codelineno-31-22" name="__codelineno-31-22"></a><span class="w">    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4*4</span>
<a id="__codelineno-31-23" name="__codelineno-31-23"></a><span class="w">    </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4*4</span>
<a id="__codelineno-31-24" name="__codelineno-31-24"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<a id="__codelineno-31-25" name="__codelineno-31-25"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<a id="__codelineno-31-26" name="__codelineno-31-26"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w">  </span><span class="c1">//initialize</span>
<a id="__codelineno-31-27" name="__codelineno-31-27"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-31-28" name="__codelineno-31-28"></a><span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-31-29" name="__codelineno-31-29"></a><span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-31-30" name="__codelineno-31-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-31-31" name="__codelineno-31-31"></a>
<a id="__codelineno-31-32" name="__codelineno-31-32"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Raw computing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-31-33" name="__codelineno-31-33"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span><span class="w">  </span><span class="c1">//timing</span>
<a id="__codelineno-31-34" name="__codelineno-31-34"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAXN</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="o">++</span><span class="p">)</span><span class="w">  </span><span class="c1">//MAXN times</span>
<a id="__codelineno-31-35" name="__codelineno-31-35"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-31-36" name="__codelineno-31-36"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-31-37" name="__codelineno-31-37"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-31-38" name="__codelineno-31-38"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-31-39" name="__codelineno-31-39"></a><span class="w">            </span><span class="p">{</span>
<a id="__codelineno-31-40" name="__codelineno-31-40"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-31-41" name="__codelineno-31-41"></a><span class="w">                </span><span class="p">{</span>
<a id="__codelineno-31-42" name="__codelineno-31-42"></a><span class="w">                    </span><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
<a id="__codelineno-31-43" name="__codelineno-31-43"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-31-44" name="__codelineno-31-44"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-31-45" name="__codelineno-31-45"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-31-46" name="__codelineno-31-46"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-31-47" name="__codelineno-31-47"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<a id="__codelineno-31-48" name="__codelineno-31-48"></a>
<a id="__codelineno-31-49" name="__codelineno-31-49"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">time1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<a id="__codelineno-31-50" name="__codelineno-31-50"></a>
<a id="__codelineno-31-51" name="__codelineno-31-51"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;New computing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-31-52" name="__codelineno-31-52"></a><span class="w">    </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<a id="__codelineno-31-53" name="__codelineno-31-53"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAXN</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-31-54" name="__codelineno-31-54"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-31-55" name="__codelineno-31-55"></a><span class="w">        </span><span class="cm">/* 可以修改的代码区域 */</span>
<a id="__codelineno-31-56" name="__codelineno-31-56"></a><span class="w">        </span><span class="c1">// -----------------------------------</span>
<a id="__codelineno-31-57" name="__codelineno-31-57"></a><span class="w">        </span><span class="c1">// for (int k = 0; k &lt; 4; k++)</span>
<a id="__codelineno-31-58" name="__codelineno-31-58"></a><span class="w">        </span><span class="c1">// {</span>
<a id="__codelineno-31-59" name="__codelineno-31-59"></a><span class="w">        </span><span class="c1">//     for (int i = 0; i &lt; 4; i++)</span>
<a id="__codelineno-31-60" name="__codelineno-31-60"></a><span class="w">        </span><span class="c1">//     {</span>
<a id="__codelineno-31-61" name="__codelineno-31-61"></a><span class="w">        </span><span class="c1">//         for (int j = 0; j &lt; 12; j++)</span>
<a id="__codelineno-31-62" name="__codelineno-31-62"></a><span class="w">        </span><span class="c1">//         {</span>
<a id="__codelineno-31-63" name="__codelineno-31-63"></a><span class="w">        </span><span class="c1">//             *(d + n * 16 + i * 4 + k) += *(a + n * 48 + i * 12 + j) * *(b + n * 48 + j * 4 + k);</span>
<a id="__codelineno-31-64" name="__codelineno-31-64"></a><span class="w">        </span><span class="c1">//         }</span>
<a id="__codelineno-31-65" name="__codelineno-31-65"></a><span class="w">        </span><span class="c1">//     }</span>
<a id="__codelineno-31-66" name="__codelineno-31-66"></a><span class="w">        </span><span class="c1">// }</span>
<a id="__codelineno-31-67" name="__codelineno-31-67"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">a_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">b_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="p">;</span>
<a id="__codelineno-31-68" name="__codelineno-31-68"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">d_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<a id="__codelineno-31-69" name="__codelineno-31-69"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">;</span>
<a id="__codelineno-31-70" name="__codelineno-31-70"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">a_ptr_0</span><span class="p">,</span><span class="o">*</span><span class="n">a_ptr_1</span><span class="p">,</span><span class="o">*</span><span class="n">a_ptr_2</span><span class="p">,</span><span class="o">*</span><span class="n">a_ptr_3</span><span class="p">;</span>
<a id="__codelineno-31-71" name="__codelineno-31-71"></a><span class="w">        </span><span class="n">a_ptr_0</span><span class="o">=&amp;</span><span class="n">a_ptr</span><span class="p">[</span><span class="mi">0</span><span class="o">*</span><span class="mi">12</span><span class="o">+</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-31-72" name="__codelineno-31-72"></a><span class="w">        </span><span class="n">a_ptr_1</span><span class="o">=&amp;</span><span class="n">a_ptr</span><span class="p">[</span><span class="mi">1</span><span class="o">*</span><span class="mi">12</span><span class="o">+</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-31-73" name="__codelineno-31-73"></a><span class="w">        </span><span class="n">a_ptr_2</span><span class="o">=&amp;</span><span class="n">a_ptr</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="mi">12</span><span class="o">+</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-31-74" name="__codelineno-31-74"></a><span class="w">        </span><span class="n">a_ptr_3</span><span class="o">=&amp;</span><span class="n">a_ptr</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">12</span><span class="o">+</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-31-75" name="__codelineno-31-75"></a>
<a id="__codelineno-31-76" name="__codelineno-31-76"></a><span class="w">        </span><span class="n">__m256d</span><span class="w"> </span><span class="n">c_sum_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_setzero_pd</span><span class="p">();</span><span class="w">  </span>
<a id="__codelineno-31-77" name="__codelineno-31-77"></a><span class="w">        </span><span class="n">__m256d</span><span class="w"> </span><span class="n">c_sum_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_setzero_pd</span><span class="p">();</span><span class="w">  </span>
<a id="__codelineno-31-78" name="__codelineno-31-78"></a><span class="w">        </span><span class="n">__m256d</span><span class="w"> </span><span class="n">c_sum_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_setzero_pd</span><span class="p">();</span><span class="w">  </span>
<a id="__codelineno-31-79" name="__codelineno-31-79"></a><span class="w">        </span><span class="n">__m256d</span><span class="w"> </span><span class="n">c_sum_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_setzero_pd</span><span class="p">();</span><span class="w"> </span>
<a id="__codelineno-31-80" name="__codelineno-31-80"></a>
<a id="__codelineno-31-81" name="__codelineno-31-81"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">a_reg_0</span><span class="p">,</span><span class="n">a_reg_1</span><span class="p">,</span><span class="n">a_reg_2</span><span class="p">,</span><span class="n">a_reg_3</span><span class="p">;</span>
<a id="__codelineno-31-82" name="__codelineno-31-82"></a>
<a id="__codelineno-31-83" name="__codelineno-31-83"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">){</span>
<a id="__codelineno-31-84" name="__codelineno-31-84"></a><span class="w">            </span><span class="n">a_reg_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">a_ptr_0</span><span class="o">++</span><span class="p">);</span>
<a id="__codelineno-31-85" name="__codelineno-31-85"></a><span class="w">            </span><span class="n">a_reg_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">a_ptr_1</span><span class="o">++</span><span class="p">);</span>
<a id="__codelineno-31-86" name="__codelineno-31-86"></a><span class="w">            </span><span class="n">a_reg_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">a_ptr_2</span><span class="o">++</span><span class="p">);</span>
<a id="__codelineno-31-87" name="__codelineno-31-87"></a><span class="w">            </span><span class="n">a_reg_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">a_ptr_3</span><span class="o">++</span><span class="p">);</span>
<a id="__codelineno-31-88" name="__codelineno-31-88"></a>
<a id="__codelineno-31-89" name="__codelineno-31-89"></a><span class="w">            </span><span class="n">__m256d</span><span class="w"> </span><span class="n">b_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_loadu_pd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b_ptr</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-31-90" name="__codelineno-31-90"></a>
<a id="__codelineno-31-91" name="__codelineno-31-91"></a><span class="w">            </span><span class="n">__m256d</span><span class="w"> </span><span class="n">a_vec_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="n">a_reg_0</span><span class="p">);</span>
<a id="__codelineno-31-92" name="__codelineno-31-92"></a><span class="w">            </span><span class="n">c_sum_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_fmadd_pd</span><span class="p">(</span><span class="n">a_vec_0</span><span class="p">,</span><span class="w"> </span><span class="n">b_reg</span><span class="p">,</span><span class="n">c_sum_0</span><span class="p">);</span>
<a id="__codelineno-31-93" name="__codelineno-31-93"></a><span class="w">            </span><span class="n">__m256d</span><span class="w"> </span><span class="n">a_vec_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="n">a_reg_1</span><span class="p">);</span>
<a id="__codelineno-31-94" name="__codelineno-31-94"></a><span class="w">            </span><span class="n">c_sum_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_fmadd_pd</span><span class="p">(</span><span class="n">a_vec_1</span><span class="p">,</span><span class="w"> </span><span class="n">b_reg</span><span class="p">,</span><span class="n">c_sum_1</span><span class="p">);</span>
<a id="__codelineno-31-95" name="__codelineno-31-95"></a><span class="w">            </span><span class="n">__m256d</span><span class="w"> </span><span class="n">a_vec_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="n">a_reg_2</span><span class="p">);</span>
<a id="__codelineno-31-96" name="__codelineno-31-96"></a><span class="w">            </span><span class="n">c_sum_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_fmadd_pd</span><span class="p">(</span><span class="n">a_vec_2</span><span class="p">,</span><span class="w"> </span><span class="n">b_reg</span><span class="p">,</span><span class="n">c_sum_2</span><span class="p">);</span>
<a id="__codelineno-31-97" name="__codelineno-31-97"></a><span class="w">            </span><span class="n">__m256d</span><span class="w"> </span><span class="n">a_vec_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_set1_pd</span><span class="p">(</span><span class="n">a_reg_3</span><span class="p">);</span>
<a id="__codelineno-31-98" name="__codelineno-31-98"></a><span class="w">            </span><span class="n">c_sum_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_fmadd_pd</span><span class="p">(</span><span class="n">a_vec_3</span><span class="p">,</span><span class="w"> </span><span class="n">b_reg</span><span class="p">,</span><span class="n">c_sum_3</span><span class="p">);</span>
<a id="__codelineno-31-99" name="__codelineno-31-99"></a>
<a id="__codelineno-31-100" name="__codelineno-31-100"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-31-101" name="__codelineno-31-101"></a>
<a id="__codelineno-31-102" name="__codelineno-31-102"></a><span class="w">        </span><span class="n">_mm256_storeu_pd</span><span class="p">(</span><span class="n">d_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">c_sum_0</span><span class="p">);</span>
<a id="__codelineno-31-103" name="__codelineno-31-103"></a><span class="w">        </span><span class="n">_mm256_storeu_pd</span><span class="p">(</span><span class="n">d_ptr</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">c_sum_1</span><span class="p">);</span>
<a id="__codelineno-31-104" name="__codelineno-31-104"></a><span class="w">        </span><span class="n">_mm256_storeu_pd</span><span class="p">(</span><span class="n">d_ptr</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">c_sum_2</span><span class="p">);</span>
<a id="__codelineno-31-105" name="__codelineno-31-105"></a><span class="w">        </span><span class="n">_mm256_storeu_pd</span><span class="p">(</span><span class="n">d_ptr</span><span class="o">+</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="n">c_sum_3</span><span class="p">);</span>
<a id="__codelineno-31-106" name="__codelineno-31-106"></a>
<a id="__codelineno-31-107" name="__codelineno-31-107"></a><span class="w">        </span><span class="c1">// -----------------------------------</span>
<a id="__codelineno-31-108" name="__codelineno-31-108"></a>
<a id="__codelineno-31-109" name="__codelineno-31-109"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-31-110" name="__codelineno-31-110"></a><span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<a id="__codelineno-31-111" name="__codelineno-31-111"></a>
<a id="__codelineno-31-112" name="__codelineno-31-112"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">time2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<a id="__codelineno-31-113" name="__codelineno-31-113"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;raw time=%lfs</span><span class="se">\n</span><span class="s">new time=%lfs</span><span class="se">\n</span><span class="s">speed up:%lfx</span><span class="se">\n</span><span class="s">Checking</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">time1</span><span class="p">,</span><span class="w"> </span><span class="n">time2</span><span class="p">,</span><span class="w"> </span><span class="n">time1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">time2</span><span class="p">);</span>
<a id="__codelineno-31-114" name="__codelineno-31-114"></a>
<a id="__codelineno-31-115" name="__codelineno-31-115"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAXN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-31-116" name="__codelineno-31-116"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-31-117" name="__codelineno-31-117"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0001</span><span class="p">)</span>
<a id="__codelineno-31-118" name="__codelineno-31-118"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-31-119" name="__codelineno-31-119"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Check Failed at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<a id="__codelineno-31-120" name="__codelineno-31-120"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-31-121" name="__codelineno-31-121"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-31-122" name="__codelineno-31-122"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-31-123" name="__codelineno-31-123"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Check Passed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-31-124" name="__codelineno-31-124"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
<p>这是一个非常常规的SIMD，在不使用编译器优化选项的情况下，首次编译运行的结果如下  </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span>
<span class="normal"><a href="#__codelineno-32-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a>g++<span class="w"> </span>multi_pro.cpp<span class="w"> </span>-mavx2<span class="w"> </span>-mfma<span class="w"> </span>-o<span class="w"> </span>multi_pro<span class="w">  </span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a>./multi_pro.exe<span class="w">  </span>
</code></pre></div></td></tr></table></div>
<p><img alt="alt text" src="../image-103.png" />  </p>
<p>多次运行后加速比基本稳定在2x上下  </p>
<p><img alt="alt text" src="../image-104.png" /><br />
<img alt="alt text" src="../image-105.png" /><br />
<img alt="alt text" src="../image-106.png" />  </p>
<h3 id="43-godbolt">4.3 godbolt<a class="headerlink" href="#43-godbolt" title="Permanent link">&para;</a></h3>
<p>godbolt 是一款基于 web 的研究不同编译器编译产生汇编代码的工具，借助它我们可以从汇编代码中获得更多信息。 </p>
<p>这个在线工具其实就是把代码转换成汇编语言（然鹅我对汇编是完全不会的）。快速学习汇编，找了一篇<a href="https://blog.csdn.net/hanmo22357/article/details/127883179?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172165810716800211583778%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=172165810716800211583778&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-127883179-null-null.142^v100^pc_search_result_base8&amp;utm_term=%E6%B1%87%E7%BC%96&amp;spm=1018.2226.3001.4187">CSND</a>  </p>
<p>使用编译：<code>x86-64 gcc 14.1</code>   编译选项：<code>-mavx2 -mfma</code>  </p>
<p><code>for</code> 循环实现的汇编代码</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span>
<span class="normal"><a href="#__codelineno-33-13">13</a></span>
<span class="normal"><a href="#__codelineno-33-14">14</a></span>
<span class="normal"><a href="#__codelineno-33-15">15</a></span>
<span class="normal"><a href="#__codelineno-33-16">16</a></span>
<span class="normal"><a href="#__codelineno-33-17">17</a></span>
<span class="normal"><a href="#__codelineno-33-18">18</a></span>
<span class="normal"><a href="#__codelineno-33-19">19</a></span>
<span class="normal"><a href="#__codelineno-33-20">20</a></span>
<span class="normal"><a href="#__codelineno-33-21">21</a></span>
<span class="normal"><a href="#__codelineno-33-22">22</a></span>
<span class="normal"><a href="#__codelineno-33-23">23</a></span>
<span class="normal"><a href="#__codelineno-33-24">24</a></span>
<span class="normal"><a href="#__codelineno-33-25">25</a></span>
<span class="normal"><a href="#__codelineno-33-26">26</a></span>
<span class="normal"><a href="#__codelineno-33-27">27</a></span>
<span class="normal"><a href="#__codelineno-33-28">28</a></span>
<span class="normal"><a href="#__codelineno-33-29">29</a></span>
<span class="normal"><a href="#__codelineno-33-30">30</a></span>
<span class="normal"><a href="#__codelineno-33-31">31</a></span>
<span class="normal"><a href="#__codelineno-33-32">32</a></span>
<span class="normal"><a href="#__codelineno-33-33">33</a></span>
<span class="normal"><a href="#__codelineno-33-34">34</a></span>
<span class="normal"><a href="#__codelineno-33-35">35</a></span>
<span class="normal"><a href="#__codelineno-33-36">36</a></span>
<span class="normal"><a href="#__codelineno-33-37">37</a></span>
<span class="normal"><a href="#__codelineno-33-38">38</a></span>
<span class="normal"><a href="#__codelineno-33-39">39</a></span>
<span class="normal"><a href="#__codelineno-33-40">40</a></span>
<span class="normal"><a href="#__codelineno-33-41">41</a></span>
<span class="normal"><a href="#__codelineno-33-42">42</a></span>
<span class="normal"><a href="#__codelineno-33-43">43</a></span>
<span class="normal"><a href="#__codelineno-33-44">44</a></span>
<span class="normal"><a href="#__codelineno-33-45">45</a></span>
<span class="normal"><a href="#__codelineno-33-46">46</a></span>
<span class="normal"><a href="#__codelineno-33-47">47</a></span>
<span class="normal"><a href="#__codelineno-33-48">48</a></span>
<span class="normal"><a href="#__codelineno-33-49">49</a></span>
<span class="normal"><a href="#__codelineno-33-50">50</a></span>
<span class="normal"><a href="#__codelineno-33-51">51</a></span>
<span class="normal"><a href="#__codelineno-33-52">52</a></span>
<span class="normal"><a href="#__codelineno-33-53">53</a></span>
<span class="normal"><a href="#__codelineno-33-54">54</a></span>
<span class="normal"><a href="#__codelineno-33-55">55</a></span>
<span class="normal"><a href="#__codelineno-33-56">56</a></span>
<span class="normal"><a href="#__codelineno-33-57">57</a></span>
<span class="normal"><a href="#__codelineno-33-58">58</a></span>
<span class="normal"><a href="#__codelineno-33-59">59</a></span>
<span class="normal"><a href="#__codelineno-33-60">60</a></span>
<span class="normal"><a href="#__codelineno-33-61">61</a></span>
<span class="normal"><a href="#__codelineno-33-62">62</a></span>
<span class="normal"><a href="#__codelineno-33-63">63</a></span>
<span class="normal"><a href="#__codelineno-33-64">64</a></span>
<span class="normal"><a href="#__codelineno-33-65">65</a></span>
<span class="normal"><a href="#__codelineno-33-66">66</a></span>
<span class="normal"><a href="#__codelineno-33-67">67</a></span>
<span class="normal"><a href="#__codelineno-33-68">68</a></span>
<span class="normal"><a href="#__codelineno-33-69">69</a></span>
<span class="normal"><a href="#__codelineno-33-70">70</a></span>
<span class="normal"><a href="#__codelineno-33-71">71</a></span>
<span class="normal"><a href="#__codelineno-33-72">72</a></span>
<span class="normal"><a href="#__codelineno-33-73">73</a></span>
<span class="normal"><a href="#__codelineno-33-74">74</a></span>
<span class="normal"><a href="#__codelineno-33-75">75</a></span>
<span class="normal"><a href="#__codelineno-33-76">76</a></span>
<span class="normal"><a href="#__codelineno-33-77">77</a></span>
<span class="normal"><a href="#__codelineno-33-78">78</a></span>
<span class="normal"><a href="#__codelineno-33-79">79</a></span>
<span class="normal"><a href="#__codelineno-33-80">80</a></span>
<span class="normal"><a href="#__codelineno-33-81">81</a></span>
<span class="normal"><a href="#__codelineno-33-82">82</a></span>
<span class="normal"><a href="#__codelineno-33-83">83</a></span>
<span class="normal"><a href="#__codelineno-33-84">84</a></span>
<span class="normal"><a href="#__codelineno-33-85">85</a></span>
<span class="normal"><a href="#__codelineno-33-86">86</a></span>
<span class="normal"><a href="#__codelineno-33-87">87</a></span>
<span class="normal"><a href="#__codelineno-33-88">88</a></span>
<span class="normal"><a href="#__codelineno-33-89">89</a></span>
<span class="normal"><a href="#__codelineno-33-90">90</a></span>
<span class="normal"><a href="#__codelineno-33-91">91</a></span>
<span class="normal"><a href="#__codelineno-33-92">92</a></span>
<span class="normal"><a href="#__codelineno-33-93">93</a></span>
<span class="normal"><a href="#__codelineno-33-94">94</a></span>
<span class="normal"><a href="#__codelineno-33-95">95</a></span>
<span class="normal"><a href="#__codelineno-33-96">96</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a>        mov     DWORD PTR [rbp-24], 0  //将立即数（immediate value）0移动到（mov）一个由rbp（基指针寄存器）减去28个字节所指向的内存位置。这里的DWORD PTR表示操作的是双字（Double Word）大小的数据，即32位（4字节）的整数。因此，这行代码的作用是将栈上的一个局部变量的值设置为0，这个局部变量相对于rbp的偏移量是-28
<a id="__codelineno-33-2" name="__codelineno-33-2"></a>        jmp     .L11  //无条件跳转（jmp）到标签.L12所标记的代码位置(.L12判断这个变量的值是不是小于等于9999999)
<a id="__codelineno-33-3" name="__codelineno-33-3"></a>.L18:
<a id="__codelineno-33-4" name="__codelineno-33-4"></a>        mov     DWORD PTR [rbp-28], 0  //一个Double需要4个字节，所以内存位置差4
<a id="__codelineno-33-5" name="__codelineno-33-5"></a>        jmp     .L12
<a id="__codelineno-33-6" name="__codelineno-33-6"></a>.L17:
<a id="__codelineno-33-7" name="__codelineno-33-7"></a>        mov     DWORD PTR [rbp-32], 0
<a id="__codelineno-33-8" name="__codelineno-33-8"></a>        jmp     .L13
<a id="__codelineno-33-9" name="__codelineno-33-9"></a>.L16:
<a id="__codelineno-33-10" name="__codelineno-33-10"></a>        mov     DWORD PTR [rbp-36], 0
<a id="__codelineno-33-11" name="__codelineno-33-11"></a>        jmp     .L14
<a id="__codelineno-33-12" name="__codelineno-33-12"></a>.L15:
<a id="__codelineno-33-13" name="__codelineno-33-13"></a>        mov     rax, QWORD PTR c[rip]  //从rip（指令指针寄存器）相对偏移处加载一个64位（QWORD）指针到rax，这个指针指向一个数组c的基地址
<a id="__codelineno-33-14" name="__codelineno-33-14"></a>        mov     edx, DWORD PTR [rbp-24]  //从栈上（相对于rbp的偏移）读取三个32位（DWORD）整数，分别存储在rbp-24、rbp-32、rbp-28
<a id="__codelineno-33-15" name="__codelineno-33-15"></a>        //这些整数进行位移（左移，相当于乘以2的幂）和累加操作，以计算出一个索引
<a id="__codelineno-33-16" name="__codelineno-33-16"></a>        sal     edx, 4  //位移
<a id="__codelineno-33-17" name="__codelineno-33-17"></a>        movsx   rcx, edx  //带符号扩展
<a id="__codelineno-33-18" name="__codelineno-33-18"></a>        mov     edx, DWORD PTR [rbp-32]
<a id="__codelineno-33-19" name="__codelineno-33-19"></a>        sal     edx, 2
<a id="__codelineno-33-20" name="__codelineno-33-20"></a>        movsx   rdx, edx
<a id="__codelineno-33-21" name="__codelineno-33-21"></a>        add     rcx, rdx  //累加
<a id="__codelineno-33-22" name="__codelineno-33-22"></a>        mov     edx, DWORD PTR [rbp-28]
<a id="__codelineno-33-23" name="__codelineno-33-23"></a>        movsx   rdx, edx
<a id="__codelineno-33-24" name="__codelineno-33-24"></a>        add     rdx, rcx
<a id="__codelineno-33-25" name="__codelineno-33-25"></a>        sal     rdx, 3
<a id="__codelineno-33-26" name="__codelineno-33-26"></a>        add     rax, rdx
<a id="__codelineno-33-27" name="__codelineno-33-27"></a>        vmovsd  xmm1, QWORD PTR [rax]  //使用这个索引加上rax中的基地址，计算出最终的内存地址，并从该地址加载一个双精度浮点数（64位，QWORD）到xmm1
<a id="__codelineno-33-28" name="__codelineno-33-28"></a>        mov     rcx, QWORD PTR a[rip]
<a id="__codelineno-33-29" name="__codelineno-33-29"></a>        mov     edx, DWORD PTR [rbp-24]
<a id="__codelineno-33-30" name="__codelineno-33-30"></a>        mov     eax, edx
<a id="__codelineno-33-31" name="__codelineno-33-31"></a>        add     eax, eax
<a id="__codelineno-33-32" name="__codelineno-33-32"></a>        add     eax, edx
<a id="__codelineno-33-33" name="__codelineno-33-33"></a>        sal     eax, 4
<a id="__codelineno-33-34" name="__codelineno-33-34"></a>        movsx   rsi, eax
<a id="__codelineno-33-35" name="__codelineno-33-35"></a>        mov     edx, DWORD PTR [rbp-32]
<a id="__codelineno-33-36" name="__codelineno-33-36"></a>        mov     eax, edx
<a id="__codelineno-33-37" name="__codelineno-33-37"></a>        add     eax, eax
<a id="__codelineno-33-38" name="__codelineno-33-38"></a>        add     eax, edx
<a id="__codelineno-33-39" name="__codelineno-33-39"></a>        sal     eax, 2
<a id="__codelineno-33-40" name="__codelineno-33-40"></a>        cdqe  //将32位寄存器（如eax）的值符号扩展到64位寄存器（如rax）
<a id="__codelineno-33-41" name="__codelineno-33-41"></a>        lea     rdx, [rsi+rax]  //计算rsi和rax两个寄存器值的和，并将结果存储在rdx寄存器中
<a id="__codelineno-33-42" name="__codelineno-33-42"></a>        mov     eax, DWORD PTR [rbp-36]
<a id="__codelineno-33-43" name="__codelineno-33-43"></a>        cdqe
<a id="__codelineno-33-44" name="__codelineno-33-44"></a>        add     rax, rdx
<a id="__codelineno-33-45" name="__codelineno-33-45"></a>        sal     rax, 3
<a id="__codelineno-33-46" name="__codelineno-33-46"></a>        add     rax, rcx
<a id="__codelineno-33-47" name="__codelineno-33-47"></a>        vmovsd  xmm2, QWORD PTR [rax]
<a id="__codelineno-33-48" name="__codelineno-33-48"></a>        mov     rcx, QWORD PTR b[rip]
<a id="__codelineno-33-49" name="__codelineno-33-49"></a>        mov     edx, DWORD PTR [rbp-24]
<a id="__codelineno-33-50" name="__codelineno-33-50"></a>        mov     eax, edx
<a id="__codelineno-33-51" name="__codelineno-33-51"></a>        add     eax, eax
<a id="__codelineno-33-52" name="__codelineno-33-52"></a>        add     eax, edx
<a id="__codelineno-33-53" name="__codelineno-33-53"></a>        sal     eax, 4
<a id="__codelineno-33-54" name="__codelineno-33-54"></a>        movsx   rdx, eax
<a id="__codelineno-33-55" name="__codelineno-33-55"></a>        mov     eax, DWORD PTR [rbp-36]
<a id="__codelineno-33-56" name="__codelineno-33-56"></a>        sal     eax, 2
<a id="__codelineno-33-57" name="__codelineno-33-57"></a>        cdqe
<a id="__codelineno-33-58" name="__codelineno-33-58"></a>        add     rdx, rax
<a id="__codelineno-33-59" name="__codelineno-33-59"></a>        mov     eax, DWORD PTR [rbp-28]
<a id="__codelineno-33-60" name="__codelineno-33-60"></a>        cdqe
<a id="__codelineno-33-61" name="__codelineno-33-61"></a>        add     rax, rdx
<a id="__codelineno-33-62" name="__codelineno-33-62"></a>        sal     rax, 3
<a id="__codelineno-33-63" name="__codelineno-33-63"></a>        add     rax, rcx
<a id="__codelineno-33-64" name="__codelineno-33-64"></a>        vmovsd  xmm0, QWORD PTR [rax]
<a id="__codelineno-33-65" name="__codelineno-33-65"></a>        vmulsd  xmm0, xmm2, xmm0  //执行一个双精度浮点数的乘法操作。它将xmm2寄存器和xmm0寄存器中的双精度浮点数相乘，并将结果存储回xmm0寄存器中
<a id="__codelineno-33-66" name="__codelineno-33-66"></a>        mov     rax, QWORD PTR c[rip]
<a id="__codelineno-33-67" name="__codelineno-33-67"></a>        mov     edx, DWORD PTR [rbp-24]
<a id="__codelineno-33-68" name="__codelineno-33-68"></a>        sal     edx, 4
<a id="__codelineno-33-69" name="__codelineno-33-69"></a>        movsx   rcx, edx
<a id="__codelineno-33-70" name="__codelineno-33-70"></a>        mov     edx, DWORD PTR [rbp-32]
<a id="__codelineno-33-71" name="__codelineno-33-71"></a>        sal     edx, 2
<a id="__codelineno-33-72" name="__codelineno-33-72"></a>        movsx   rdx, edx
<a id="__codelineno-33-73" name="__codelineno-33-73"></a>        add     rcx, rdx
<a id="__codelineno-33-74" name="__codelineno-33-74"></a>        mov     edx, DWORD PTR [rbp-28]
<a id="__codelineno-33-75" name="__codelineno-33-75"></a>        movsx   rdx, edx
<a id="__codelineno-33-76" name="__codelineno-33-76"></a>        add     rdx, rcx
<a id="__codelineno-33-77" name="__codelineno-33-77"></a>        sal     rdx, 3
<a id="__codelineno-33-78" name="__codelineno-33-78"></a>        add     rax, rdx
<a id="__codelineno-33-79" name="__codelineno-33-79"></a>        vaddsd  xmm0, xmm1, xmm0
<a id="__codelineno-33-80" name="__codelineno-33-80"></a>        vmovsd  QWORD PTR [rax], xmm0
<a id="__codelineno-33-81" name="__codelineno-33-81"></a>        add     DWORD PTR [rbp-36], 1  //循环变量累加
<a id="__codelineno-33-82" name="__codelineno-33-82"></a>.L14:
<a id="__codelineno-33-83" name="__codelineno-33-83"></a>        cmp     DWORD PTR [rbp-36], 11  //判断循环是否结束
<a id="__codelineno-33-84" name="__codelineno-33-84"></a>        jle     .L15
<a id="__codelineno-33-85" name="__codelineno-33-85"></a>        add     DWORD PTR [rbp-32], 1
<a id="__codelineno-33-86" name="__codelineno-33-86"></a>.L13:
<a id="__codelineno-33-87" name="__codelineno-33-87"></a>        cmp     DWORD PTR [rbp-32], 3
<a id="__codelineno-33-88" name="__codelineno-33-88"></a>        jle     .L16
<a id="__codelineno-33-89" name="__codelineno-33-89"></a>        add     DWORD PTR [rbp-28], 1
<a id="__codelineno-33-90" name="__codelineno-33-90"></a>.L12:
<a id="__codelineno-33-91" name="__codelineno-33-91"></a>        cmp     DWORD PTR [rbp-28], 3
<a id="__codelineno-33-92" name="__codelineno-33-92"></a>        jle     .L17
<a id="__codelineno-33-93" name="__codelineno-33-93"></a>        add     DWORD PTR [rbp-24], 1
<a id="__codelineno-33-94" name="__codelineno-33-94"></a>.L11:
<a id="__codelineno-33-95" name="__codelineno-33-95"></a>        cmp     DWORD PTR [rbp-24], 9999999
<a id="__codelineno-33-96" name="__codelineno-33-96"></a>        jle     .L18
</code></pre></div></td></tr></table></div>
<p>AVX指令集实现的汇编代码  </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1">  1</a></span>
<span class="normal"><a href="#__codelineno-34-2">  2</a></span>
<span class="normal"><a href="#__codelineno-34-3">  3</a></span>
<span class="normal"><a href="#__codelineno-34-4">  4</a></span>
<span class="normal"><a href="#__codelineno-34-5">  5</a></span>
<span class="normal"><a href="#__codelineno-34-6">  6</a></span>
<span class="normal"><a href="#__codelineno-34-7">  7</a></span>
<span class="normal"><a href="#__codelineno-34-8">  8</a></span>
<span class="normal"><a href="#__codelineno-34-9">  9</a></span>
<span class="normal"><a href="#__codelineno-34-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-34-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-34-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-34-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-34-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-34-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-34-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-34-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-34-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-34-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-34-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-34-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-34-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-34-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-34-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-34-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-34-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-34-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-34-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-34-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-34-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-34-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-34-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-34-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-34-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-34-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-34-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-34-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-34-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-34-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-34-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-34-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-34-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-34-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-34-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-34-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-34-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-34-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-34-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-34-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-34-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-34-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-34-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-34-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-34-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-34-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-34-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-34-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-34-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-34-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-34-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-34-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-34-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-34-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-34-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-34-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-34-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-34-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-34-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-34-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-34-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-34-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-34-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-34-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-34-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-34-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-34-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-34-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-34-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-34-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-34-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-34-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-34-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-34-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-34-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-34-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-34-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-34-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-34-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-34-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-34-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-34-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-34-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-34-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-34-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-34-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-34-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-34-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-34-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-34-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-34-100">100</a></span>
<span class="normal"><a href="#__codelineno-34-101">101</a></span>
<span class="normal"><a href="#__codelineno-34-102">102</a></span>
<span class="normal"><a href="#__codelineno-34-103">103</a></span>
<span class="normal"><a href="#__codelineno-34-104">104</a></span>
<span class="normal"><a href="#__codelineno-34-105">105</a></span>
<span class="normal"><a href="#__codelineno-34-106">106</a></span>
<span class="normal"><a href="#__codelineno-34-107">107</a></span>
<span class="normal"><a href="#__codelineno-34-108">108</a></span>
<span class="normal"><a href="#__codelineno-34-109">109</a></span>
<span class="normal"><a href="#__codelineno-34-110">110</a></span>
<span class="normal"><a href="#__codelineno-34-111">111</a></span>
<span class="normal"><a href="#__codelineno-34-112">112</a></span>
<span class="normal"><a href="#__codelineno-34-113">113</a></span>
<span class="normal"><a href="#__codelineno-34-114">114</a></span>
<span class="normal"><a href="#__codelineno-34-115">115</a></span>
<span class="normal"><a href="#__codelineno-34-116">116</a></span>
<span class="normal"><a href="#__codelineno-34-117">117</a></span>
<span class="normal"><a href="#__codelineno-34-118">118</a></span>
<span class="normal"><a href="#__codelineno-34-119">119</a></span>
<span class="normal"><a href="#__codelineno-34-120">120</a></span>
<span class="normal"><a href="#__codelineno-34-121">121</a></span>
<span class="normal"><a href="#__codelineno-34-122">122</a></span>
<span class="normal"><a href="#__codelineno-34-123">123</a></span>
<span class="normal"><a href="#__codelineno-34-124">124</a></span>
<span class="normal"><a href="#__codelineno-34-125">125</a></span>
<span class="normal"><a href="#__codelineno-34-126">126</a></span>
<span class="normal"><a href="#__codelineno-34-127">127</a></span>
<span class="normal"><a href="#__codelineno-34-128">128</a></span>
<span class="normal"><a href="#__codelineno-34-129">129</a></span>
<span class="normal"><a href="#__codelineno-34-130">130</a></span>
<span class="normal"><a href="#__codelineno-34-131">131</a></span>
<span class="normal"><a href="#__codelineno-34-132">132</a></span>
<span class="normal"><a href="#__codelineno-34-133">133</a></span>
<span class="normal"><a href="#__codelineno-34-134">134</a></span>
<span class="normal"><a href="#__codelineno-34-135">135</a></span>
<span class="normal"><a href="#__codelineno-34-136">136</a></span>
<span class="normal"><a href="#__codelineno-34-137">137</a></span>
<span class="normal"><a href="#__codelineno-34-138">138</a></span>
<span class="normal"><a href="#__codelineno-34-139">139</a></span>
<span class="normal"><a href="#__codelineno-34-140">140</a></span>
<span class="normal"><a href="#__codelineno-34-141">141</a></span>
<span class="normal"><a href="#__codelineno-34-142">142</a></span>
<span class="normal"><a href="#__codelineno-34-143">143</a></span>
<span class="normal"><a href="#__codelineno-34-144">144</a></span>
<span class="normal"><a href="#__codelineno-34-145">145</a></span>
<span class="normal"><a href="#__codelineno-34-146">146</a></span>
<span class="normal"><a href="#__codelineno-34-147">147</a></span>
<span class="normal"><a href="#__codelineno-34-148">148</a></span>
<span class="normal"><a href="#__codelineno-34-149">149</a></span>
<span class="normal"><a href="#__codelineno-34-150">150</a></span>
<span class="normal"><a href="#__codelineno-34-151">151</a></span>
<span class="normal"><a href="#__codelineno-34-152">152</a></span>
<span class="normal"><a href="#__codelineno-34-153">153</a></span>
<span class="normal"><a href="#__codelineno-34-154">154</a></span>
<span class="normal"><a href="#__codelineno-34-155">155</a></span>
<span class="normal"><a href="#__codelineno-34-156">156</a></span>
<span class="normal"><a href="#__codelineno-34-157">157</a></span>
<span class="normal"><a href="#__codelineno-34-158">158</a></span>
<span class="normal"><a href="#__codelineno-34-159">159</a></span>
<span class="normal"><a href="#__codelineno-34-160">160</a></span>
<span class="normal"><a href="#__codelineno-34-161">161</a></span>
<span class="normal"><a href="#__codelineno-34-162">162</a></span>
<span class="normal"><a href="#__codelineno-34-163">163</a></span>
<span class="normal"><a href="#__codelineno-34-164">164</a></span>
<span class="normal"><a href="#__codelineno-34-165">165</a></span>
<span class="normal"><a href="#__codelineno-34-166">166</a></span>
<span class="normal"><a href="#__codelineno-34-167">167</a></span>
<span class="normal"><a href="#__codelineno-34-168">168</a></span>
<span class="normal"><a href="#__codelineno-34-169">169</a></span>
<span class="normal"><a href="#__codelineno-34-170">170</a></span>
<span class="normal"><a href="#__codelineno-34-171">171</a></span>
<span class="normal"><a href="#__codelineno-34-172">172</a></span>
<span class="normal"><a href="#__codelineno-34-173">173</a></span>
<span class="normal"><a href="#__codelineno-34-174">174</a></span>
<span class="normal"><a href="#__codelineno-34-175">175</a></span>
<span class="normal"><a href="#__codelineno-34-176">176</a></span>
<span class="normal"><a href="#__codelineno-34-177">177</a></span>
<span class="normal"><a href="#__codelineno-34-178">178</a></span>
<span class="normal"><a href="#__codelineno-34-179">179</a></span>
<span class="normal"><a href="#__codelineno-34-180">180</a></span>
<span class="normal"><a href="#__codelineno-34-181">181</a></span>
<span class="normal"><a href="#__codelineno-34-182">182</a></span>
<span class="normal"><a href="#__codelineno-34-183">183</a></span>
<span class="normal"><a href="#__codelineno-34-184">184</a></span>
<span class="normal"><a href="#__codelineno-34-185">185</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a>        mov     DWORD PTR [rbp-40], 0
<a id="__codelineno-34-2" name="__codelineno-34-2"></a>        jmp     .L19
<a id="__codelineno-34-3" name="__codelineno-34-3"></a>.L35:
<a id="__codelineno-34-4" name="__codelineno-34-4"></a>        mov     rcx, QWORD PTR a[rip]
<a id="__codelineno-34-5" name="__codelineno-34-5"></a>        mov     edx, DWORD PTR [rbp-40]
<a id="__codelineno-34-6" name="__codelineno-34-6"></a>        mov     eax, edx
<a id="__codelineno-34-7" name="__codelineno-34-7"></a>        add     eax, eax
<a id="__codelineno-34-8" name="__codelineno-34-8"></a>        add     eax, edx
<a id="__codelineno-34-9" name="__codelineno-34-9"></a>        sal     eax, 4
<a id="__codelineno-34-10" name="__codelineno-34-10"></a>        cdqe
<a id="__codelineno-34-11" name="__codelineno-34-11"></a>        sal     rax, 3
<a id="__codelineno-34-12" name="__codelineno-34-12"></a>        add     rax, rcx
<a id="__codelineno-34-13" name="__codelineno-34-13"></a>        mov     QWORD PTR [rbp-240], rax
<a id="__codelineno-34-14" name="__codelineno-34-14"></a>        mov     rcx, QWORD PTR b[rip]
<a id="__codelineno-34-15" name="__codelineno-34-15"></a>        mov     edx, DWORD PTR [rbp-40]
<a id="__codelineno-34-16" name="__codelineno-34-16"></a>        mov     eax, edx
<a id="__codelineno-34-17" name="__codelineno-34-17"></a>        add     eax, eax
<a id="__codelineno-34-18" name="__codelineno-34-18"></a>        add     eax, edx
<a id="__codelineno-34-19" name="__codelineno-34-19"></a>        sal     eax, 4
<a id="__codelineno-34-20" name="__codelineno-34-20"></a>        cdqe
<a id="__codelineno-34-21" name="__codelineno-34-21"></a>        sal     rax, 3
<a id="__codelineno-34-22" name="__codelineno-34-22"></a>        add     rax, rcx
<a id="__codelineno-34-23" name="__codelineno-34-23"></a>        mov     QWORD PTR [rbp-248], rax
<a id="__codelineno-34-24" name="__codelineno-34-24"></a>        mov     rax, QWORD PTR d[rip]
<a id="__codelineno-34-25" name="__codelineno-34-25"></a>        mov     edx, DWORD PTR [rbp-40]
<a id="__codelineno-34-26" name="__codelineno-34-26"></a>        sal     edx, 4
<a id="__codelineno-34-27" name="__codelineno-34-27"></a>        movsx   rdx, edx
<a id="__codelineno-34-28" name="__codelineno-34-28"></a>        sal     rdx, 3
<a id="__codelineno-34-29" name="__codelineno-34-29"></a>        add     rax, rdx
<a id="__codelineno-34-30" name="__codelineno-34-30"></a>        mov     QWORD PTR [rbp-256], rax
<a id="__codelineno-34-31" name="__codelineno-34-31"></a>        mov     rax, QWORD PTR [rbp-240]
<a id="__codelineno-34-32" name="__codelineno-34-32"></a>        mov     QWORD PTR [rbp-56], rax
<a id="__codelineno-34-33" name="__codelineno-34-33"></a>        mov     rax, QWORD PTR [rbp-240]
<a id="__codelineno-34-34" name="__codelineno-34-34"></a>        add     rax, 96
<a id="__codelineno-34-35" name="__codelineno-34-35"></a>        mov     QWORD PTR [rbp-64], rax
<a id="__codelineno-34-36" name="__codelineno-34-36"></a>        mov     rax, QWORD PTR [rbp-240]
<a id="__codelineno-34-37" name="__codelineno-34-37"></a>        add     rax, 192
<a id="__codelineno-34-38" name="__codelineno-34-38"></a>        mov     QWORD PTR [rbp-72], rax
<a id="__codelineno-34-39" name="__codelineno-34-39"></a>        mov     rax, QWORD PTR [rbp-240]
<a id="__codelineno-34-40" name="__codelineno-34-40"></a>        add     rax, 288
<a id="__codelineno-34-41" name="__codelineno-34-41"></a>        mov     QWORD PTR [rbp-80], rax
<a id="__codelineno-34-42" name="__codelineno-34-42"></a>        vxorpd  xmm0, xmm0, xmm0  //对双精度浮点数执行按位异或（XOR）操作。不过，在这个特定的例子中，由于源操作数和目标操作数都是同一个寄存器（xmm0），这条指令的效果实际上是将xmm0寄存器中的所有位都设置为0。
<a id="__codelineno-34-43" name="__codelineno-34-43"></a>        vmovapd YMMWORD PTR [rbp-112], ymm0  //将ymm0寄存器中存储的256位（32个双精度浮点数）双精度浮点数数据移动到由rbp-112指定的内存地址处
<a id="__codelineno-34-44" name="__codelineno-34-44"></a>        vxorpd  xmm0, xmm0, xmm0
<a id="__codelineno-34-45" name="__codelineno-34-45"></a>        vmovapd YMMWORD PTR [rbp-144], ymm0
<a id="__codelineno-34-46" name="__codelineno-34-46"></a>        vxorpd  xmm0, xmm0, xmm0
<a id="__codelineno-34-47" name="__codelineno-34-47"></a>        vmovapd YMMWORD PTR [rbp-176], ymm0
<a id="__codelineno-34-48" name="__codelineno-34-48"></a>        vxorpd  xmm0, xmm0, xmm0
<a id="__codelineno-34-49" name="__codelineno-34-49"></a>        vmovapd YMMWORD PTR [rbp-208], ymm0
<a id="__codelineno-34-50" name="__codelineno-34-50"></a>        mov     DWORD PTR [rbp-44], 0
<a id="__codelineno-34-51" name="__codelineno-34-51"></a>        jmp     .L24
<a id="__codelineno-34-52" name="__codelineno-34-52"></a>.L34:
<a id="__codelineno-34-53" name="__codelineno-34-53"></a>        mov     rax, QWORD PTR [rbp-56]
<a id="__codelineno-34-54" name="__codelineno-34-54"></a>        lea     rdx, [rax+8]
<a id="__codelineno-34-55" name="__codelineno-34-55"></a>        mov     QWORD PTR [rbp-56], rdx
<a id="__codelineno-34-56" name="__codelineno-34-56"></a>        vmovsd  xmm0, QWORD PTR [rax]
<a id="__codelineno-34-57" name="__codelineno-34-57"></a>        vmovsd  QWORD PTR [rbp-264], xmm0
<a id="__codelineno-34-58" name="__codelineno-34-58"></a>        mov     rax, QWORD PTR [rbp-64]
<a id="__codelineno-34-59" name="__codelineno-34-59"></a>        lea     rdx, [rax+8]
<a id="__codelineno-34-60" name="__codelineno-34-60"></a>        mov     QWORD PTR [rbp-64], rdx
<a id="__codelineno-34-61" name="__codelineno-34-61"></a>        vmovsd  xmm0, QWORD PTR [rax]
<a id="__codelineno-34-62" name="__codelineno-34-62"></a>        vmovsd  QWORD PTR [rbp-272], xmm0
<a id="__codelineno-34-63" name="__codelineno-34-63"></a>        mov     rax, QWORD PTR [rbp-72]
<a id="__codelineno-34-64" name="__codelineno-34-64"></a>        lea     rdx, [rax+8]
<a id="__codelineno-34-65" name="__codelineno-34-65"></a>        mov     QWORD PTR [rbp-72], rdx
<a id="__codelineno-34-66" name="__codelineno-34-66"></a>        vmovsd  xmm0, QWORD PTR [rax]
<a id="__codelineno-34-67" name="__codelineno-34-67"></a>        vmovsd  QWORD PTR [rbp-280], xmm0
<a id="__codelineno-34-68" name="__codelineno-34-68"></a>        mov     rax, QWORD PTR [rbp-80]
<a id="__codelineno-34-69" name="__codelineno-34-69"></a>        lea     rdx, [rax+8]
<a id="__codelineno-34-70" name="__codelineno-34-70"></a>        mov     QWORD PTR [rbp-80], rdx
<a id="__codelineno-34-71" name="__codelineno-34-71"></a>        vmovsd  xmm0, QWORD PTR [rax]
<a id="__codelineno-34-72" name="__codelineno-34-72"></a>        vmovsd  QWORD PTR [rbp-288], xmm0
<a id="__codelineno-34-73" name="__codelineno-34-73"></a>        mov     eax, DWORD PTR [rbp-44]
<a id="__codelineno-34-74" name="__codelineno-34-74"></a>        sal     eax, 2
<a id="__codelineno-34-75" name="__codelineno-34-75"></a>        cdqe
<a id="__codelineno-34-76" name="__codelineno-34-76"></a>        lea     rdx, [0+rax*8]
<a id="__codelineno-34-77" name="__codelineno-34-77"></a>        mov     rax, QWORD PTR [rbp-248]
<a id="__codelineno-34-78" name="__codelineno-34-78"></a>        add     rax, rdx
<a id="__codelineno-34-79" name="__codelineno-34-79"></a>        mov     QWORD PTR [rbp-960], rax
<a id="__codelineno-34-80" name="__codelineno-34-80"></a>        mov     rax, QWORD PTR [rbp-960]
<a id="__codelineno-34-81" name="__codelineno-34-81"></a>        vmovupd ymm0, YMMWORD PTR [rax]  //从rax指向的地址加载256位（32字节）的未对齐双精度浮点数数据到ymm0寄存器。
<a id="__codelineno-34-82" name="__codelineno-34-82"></a>        vmovapd YMMWORD PTR [rbp-336], ymm0  //将ymm0寄存器中的256位双精度浮点数数据存储到栈上的rbp-336位置
<a id="__codelineno-34-83" name="__codelineno-34-83"></a>        vmovsd  xmm0, QWORD PTR [rbp-264]  //从栈上的rbp-264位置加载一个64位（8字节）的双精度浮点数到xmm0寄存器的低64位。
<a id="__codelineno-34-84" name="__codelineno-34-84"></a>        vmovsd  QWORD PTR [rbp-952], xmm0  //将xmm0寄存器中的64位双精度浮点数数据存储到栈上的rbp-952位置
<a id="__codelineno-34-85" name="__codelineno-34-85"></a>        vbroadcastsd    ymm0, QWORD PTR [rbp-952]
<a id="__codelineno-34-86" name="__codelineno-34-86"></a>        vmovapd YMMWORD PTR [rbp-368], ymm0
<a id="__codelineno-34-87" name="__codelineno-34-87"></a>        vmovapd ymm0, YMMWORD PTR [rbp-368]
<a id="__codelineno-34-88" name="__codelineno-34-88"></a>        vmovapd YMMWORD PTR [rbp-880], ymm0
<a id="__codelineno-34-89" name="__codelineno-34-89"></a>        vmovapd ymm0, YMMWORD PTR [rbp-336]
<a id="__codelineno-34-90" name="__codelineno-34-90"></a>        vmovapd YMMWORD PTR [rbp-912], ymm0
<a id="__codelineno-34-91" name="__codelineno-34-91"></a>        vmovapd ymm0, YMMWORD PTR [rbp-112]
<a id="__codelineno-34-92" name="__codelineno-34-92"></a>        vmovapd YMMWORD PTR [rbp-944], ymm0
<a id="__codelineno-34-93" name="__codelineno-34-93"></a>        vmovapd ymm1, YMMWORD PTR [rbp-912]
<a id="__codelineno-34-94" name="__codelineno-34-94"></a>        vmovapd ymm0, YMMWORD PTR [rbp-944]
<a id="__codelineno-34-95" name="__codelineno-34-95"></a>        vfmadd231pd     ymm0, ymm1, YMMWORD PTR [rbp-880]  //执行一个三操作数的浮点乘法加法操作。具体来说，它将ymm1寄存器中的每个双精度浮点数与rbp-880地址处的相应双精度浮点数相乘，然后将乘积加到ymm0寄存器中对应位置的双精度浮点数上
<a id="__codelineno-34-96" name="__codelineno-34-96"></a>        nop
<a id="__codelineno-34-97" name="__codelineno-34-97"></a>        vmovapd YMMWORD PTR [rbp-112], ymm0  
<a id="__codelineno-34-98" name="__codelineno-34-98"></a>        vmovsd  xmm0, QWORD PTR [rbp-272]
<a id="__codelineno-34-99" name="__codelineno-34-99"></a>        vmovsd  QWORD PTR [rbp-824], xmm0
<a id="__codelineno-34-100" name="__codelineno-34-100"></a>        vbroadcastsd    ymm0, QWORD PTR [rbp-824]
<a id="__codelineno-34-101" name="__codelineno-34-101"></a>        vmovapd YMMWORD PTR [rbp-400], ymm0
<a id="__codelineno-34-102" name="__codelineno-34-102"></a>        vmovapd ymm0, YMMWORD PTR [rbp-400]
<a id="__codelineno-34-103" name="__codelineno-34-103"></a>        vmovapd YMMWORD PTR [rbp-752], ymm0
<a id="__codelineno-34-104" name="__codelineno-34-104"></a>        vmovapd ymm0, YMMWORD PTR [rbp-336]
<a id="__codelineno-34-105" name="__codelineno-34-105"></a>        vmovapd YMMWORD PTR [rbp-784], ymm0
<a id="__codelineno-34-106" name="__codelineno-34-106"></a>        vmovapd ymm0, YMMWORD PTR [rbp-144]
<a id="__codelineno-34-107" name="__codelineno-34-107"></a>        vmovapd YMMWORD PTR [rbp-816], ymm0
<a id="__codelineno-34-108" name="__codelineno-34-108"></a>        vmovapd ymm1, YMMWORD PTR [rbp-784]
<a id="__codelineno-34-109" name="__codelineno-34-109"></a>        vmovapd ymm0, YMMWORD PTR [rbp-816]
<a id="__codelineno-34-110" name="__codelineno-34-110"></a>        vfmadd231pd     ymm0, ymm1, YMMWORD PTR [rbp-752]
<a id="__codelineno-34-111" name="__codelineno-34-111"></a>        nop
<a id="__codelineno-34-112" name="__codelineno-34-112"></a>        vmovapd YMMWORD PTR [rbp-144], ymm0
<a id="__codelineno-34-113" name="__codelineno-34-113"></a>        vmovsd  xmm0, QWORD PTR [rbp-280]
<a id="__codelineno-34-114" name="__codelineno-34-114"></a>        vmovsd  QWORD PTR [rbp-696], xmm0
<a id="__codelineno-34-115" name="__codelineno-34-115"></a>        vbroadcastsd    ymm0, QWORD PTR [rbp-696]
<a id="__codelineno-34-116" name="__codelineno-34-116"></a>        vmovapd YMMWORD PTR [rbp-432], ymm0
<a id="__codelineno-34-117" name="__codelineno-34-117"></a>        vmovapd ymm0, YMMWORD PTR [rbp-432]
<a id="__codelineno-34-118" name="__codelineno-34-118"></a>        vmovapd YMMWORD PTR [rbp-624], ymm0
<a id="__codelineno-34-119" name="__codelineno-34-119"></a>        vmovapd ymm0, YMMWORD PTR [rbp-336]
<a id="__codelineno-34-120" name="__codelineno-34-120"></a>        vmovapd YMMWORD PTR [rbp-656], ymm0
<a id="__codelineno-34-121" name="__codelineno-34-121"></a>        vmovapd ymm0, YMMWORD PTR [rbp-176]
<a id="__codelineno-34-122" name="__codelineno-34-122"></a>        vmovapd YMMWORD PTR [rbp-688], ymm0
<a id="__codelineno-34-123" name="__codelineno-34-123"></a>        vmovapd ymm1, YMMWORD PTR [rbp-656]
<a id="__codelineno-34-124" name="__codelineno-34-124"></a>        vmovapd ymm0, YMMWORD PTR [rbp-688]
<a id="__codelineno-34-125" name="__codelineno-34-125"></a>        vfmadd231pd     ymm0, ymm1, YMMWORD PTR [rbp-624]
<a id="__codelineno-34-126" name="__codelineno-34-126"></a>        nop
<a id="__codelineno-34-127" name="__codelineno-34-127"></a>        vmovapd YMMWORD PTR [rbp-176], ymm0
<a id="__codelineno-34-128" name="__codelineno-34-128"></a>        vmovsd  xmm0, QWORD PTR [rbp-288]
<a id="__codelineno-34-129" name="__codelineno-34-129"></a>        vmovsd  QWORD PTR [rbp-568], xmm0
<a id="__codelineno-34-130" name="__codelineno-34-130"></a>        vbroadcastsd    ymm0, QWORD PTR [rbp-568]
<a id="__codelineno-34-131" name="__codelineno-34-131"></a>        vmovapd YMMWORD PTR [rbp-464], ymm0
<a id="__codelineno-34-132" name="__codelineno-34-132"></a>        vmovapd ymm0, YMMWORD PTR [rbp-464]
<a id="__codelineno-34-133" name="__codelineno-34-133"></a>        vmovapd YMMWORD PTR [rbp-496], ymm0
<a id="__codelineno-34-134" name="__codelineno-34-134"></a>        vmovapd ymm0, YMMWORD PTR [rbp-336]
<a id="__codelineno-34-135" name="__codelineno-34-135"></a>        vmovapd YMMWORD PTR [rbp-528], ymm0
<a id="__codelineno-34-136" name="__codelineno-34-136"></a>        vmovapd ymm0, YMMWORD PTR [rbp-208]
<a id="__codelineno-34-137" name="__codelineno-34-137"></a>        vmovapd YMMWORD PTR [rbp-560], ymm0
<a id="__codelineno-34-138" name="__codelineno-34-138"></a>        vmovapd ymm1, YMMWORD PTR [rbp-528]
<a id="__codelineno-34-139" name="__codelineno-34-139"></a>        vmovapd ymm0, YMMWORD PTR [rbp-560]
<a id="__codelineno-34-140" name="__codelineno-34-140"></a>        vfmadd231pd     ymm0, ymm1, YMMWORD PTR [rbp-496]
<a id="__codelineno-34-141" name="__codelineno-34-141"></a>        nop
<a id="__codelineno-34-142" name="__codelineno-34-142"></a>        vmovapd YMMWORD PTR [rbp-208], ymm0
<a id="__codelineno-34-143" name="__codelineno-34-143"></a>        add     DWORD PTR [rbp-44], 1
<a id="__codelineno-34-144" name="__codelineno-34-144"></a>.L24:
<a id="__codelineno-34-145" name="__codelineno-34-145"></a>        cmp     DWORD PTR [rbp-44], 11
<a id="__codelineno-34-146" name="__codelineno-34-146"></a>        jle     .L34
<a id="__codelineno-34-147" name="__codelineno-34-147"></a>        mov     rax, QWORD PTR [rbp-256]
<a id="__codelineno-34-148" name="__codelineno-34-148"></a>        mov     QWORD PTR [rbp-1144], rax
<a id="__codelineno-34-149" name="__codelineno-34-149"></a>        vmovapd ymm0, YMMWORD PTR [rbp-112]
<a id="__codelineno-34-150" name="__codelineno-34-150"></a>        vmovapd YMMWORD PTR [rbp-1200], ymm0
<a id="__codelineno-34-151" name="__codelineno-34-151"></a>        vmovapd ymm0, YMMWORD PTR [rbp-1200]
<a id="__codelineno-34-152" name="__codelineno-34-152"></a>        mov     rax, QWORD PTR [rbp-1144]
<a id="__codelineno-34-153" name="__codelineno-34-153"></a>        vmovupd YMMWORD PTR [rax], ymm0
<a id="__codelineno-34-154" name="__codelineno-34-154"></a>        nop
<a id="__codelineno-34-155" name="__codelineno-34-155"></a>        mov     rax, QWORD PTR [rbp-256]
<a id="__codelineno-34-156" name="__codelineno-34-156"></a>        add     rax, 32
<a id="__codelineno-34-157" name="__codelineno-34-157"></a>        mov     QWORD PTR [rbp-1080], rax
<a id="__codelineno-34-158" name="__codelineno-34-158"></a>        vmovapd ymm0, YMMWORD PTR [rbp-144]
<a id="__codelineno-34-159" name="__codelineno-34-159"></a>        vmovapd YMMWORD PTR [rbp-1136], ymm0
<a id="__codelineno-34-160" name="__codelineno-34-160"></a>        vmovapd ymm0, YMMWORD PTR [rbp-1136]
<a id="__codelineno-34-161" name="__codelineno-34-161"></a>        mov     rax, QWORD PTR [rbp-1080]
<a id="__codelineno-34-162" name="__codelineno-34-162"></a>        vmovupd YMMWORD PTR [rax], ymm0
<a id="__codelineno-34-163" name="__codelineno-34-163"></a>        nop
<a id="__codelineno-34-164" name="__codelineno-34-164"></a>        mov     rax, QWORD PTR [rbp-256]
<a id="__codelineno-34-165" name="__codelineno-34-165"></a>        add     rax, 64
<a id="__codelineno-34-166" name="__codelineno-34-166"></a>        mov     QWORD PTR [rbp-1016], rax
<a id="__codelineno-34-167" name="__codelineno-34-167"></a>        vmovapd ymm0, YMMWORD PTR [rbp-176]
<a id="__codelineno-34-168" name="__codelineno-34-168"></a>        vmovapd YMMWORD PTR [rbp-1072], ymm0
<a id="__codelineno-34-169" name="__codelineno-34-169"></a>        vmovapd ymm0, YMMWORD PTR [rbp-1072]
<a id="__codelineno-34-170" name="__codelineno-34-170"></a>        mov     rax, QWORD PTR [rbp-1016]
<a id="__codelineno-34-171" name="__codelineno-34-171"></a>        vmovupd YMMWORD PTR [rax], ymm0
<a id="__codelineno-34-172" name="__codelineno-34-172"></a>        nop
<a id="__codelineno-34-173" name="__codelineno-34-173"></a>        mov     rax, QWORD PTR [rbp-256]
<a id="__codelineno-34-174" name="__codelineno-34-174"></a>        add     rax, 96
<a id="__codelineno-34-175" name="__codelineno-34-175"></a>        mov     QWORD PTR [rbp-968], rax
<a id="__codelineno-34-176" name="__codelineno-34-176"></a>        vmovapd ymm0, YMMWORD PTR [rbp-208]
<a id="__codelineno-34-177" name="__codelineno-34-177"></a>        vmovapd YMMWORD PTR [rbp-1008], ymm0
<a id="__codelineno-34-178" name="__codelineno-34-178"></a>        vmovapd ymm0, YMMWORD PTR [rbp-1008]
<a id="__codelineno-34-179" name="__codelineno-34-179"></a>        mov     rax, QWORD PTR [rbp-968]
<a id="__codelineno-34-180" name="__codelineno-34-180"></a>        vmovupd YMMWORD PTR [rax], ymm0
<a id="__codelineno-34-181" name="__codelineno-34-181"></a>        nop
<a id="__codelineno-34-182" name="__codelineno-34-182"></a>        add     DWORD PTR [rbp-40], 1
<a id="__codelineno-34-183" name="__codelineno-34-183"></a>.L19:
<a id="__codelineno-34-184" name="__codelineno-34-184"></a>        cmp     DWORD PTR [rbp-40], 9999999
<a id="__codelineno-34-185" name="__codelineno-34-185"></a>        jle     .L35
</code></pre></div></td></tr></table></div>
<p>其实感觉也看不出什么东西来。<code>for</code> 循环的实现中<br />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="o">*</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
汇编代码会很复杂，先把n,i,j,k取出来，移位，算索引，取数据，相乘，累加； AVX的实现中将原来的四个 <code>for</code> 循环减少到了两个，使用AVX指令集后向量运算也比较简洁，但是向量运算前后的load和重新写入内存的开销明显更多，对内存的读写应该是可以进一步优化的。  </p>
<h2 id="lab5">Lab5 简单神经网络训练与加速<a class="headerlink" href="#lab5" title="Permanent link">&para;</a></h2>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Transformer 模型的训练  </li>
</ul>
<h3 id="_1">实验介绍<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p><strong>深度学习（Deep Learning）</strong> 是机器学习的分支，是一种以人工神经网络为架构，对数据进行表征学习的算法。其中，网络的训练过程对算力的要求巨大，也因此成为 HPC 领域经常研究的话题。  </p>
<p><strong>注意力机制（Self-Attention）</strong> 是深度学习中的一种网络结构，也是 <strong>Transformer 架构</strong>中的核心部分。</p>
<h3 id="_2">实验环境<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>集群提供两张 A100 40G，一张 A100 80G 和两张 2080ti 显卡。  </p>
<p>新建一个 python 版本为 3.12 的空环境，并使用 <code>pip install -r requirements.txt</code> 安装所必须的包。  </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1">1</a></span>
<span class="normal"><a href="#__codelineno-36-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a>conda<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>mytorch<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.12
<a id="__codelineno-36-2" name="__codelineno-36-2"></a>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt<span class="w">  </span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-37-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-37-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-37-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-37-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-37-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-37-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-37-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-37-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-37-10">10</a></span>
<span class="normal"><a href="#__codelineno-37-11">11</a></span>
<span class="normal"><a href="#__codelineno-37-12">12</a></span>
<span class="normal"><a href="#__codelineno-37-13">13</a></span>
<span class="normal"><a href="#__codelineno-37-14">14</a></span>
<span class="normal"><a href="#__codelineno-37-15">15</a></span>
<span class="normal"><a href="#__codelineno-37-16">16</a></span>
<span class="normal"><a href="#__codelineno-37-17">17</a></span>
<span class="normal"><a href="#__codelineno-37-18">18</a></span>
<span class="normal"><a href="#__codelineno-37-19">19</a></span>
<span class="normal"><a href="#__codelineno-37-20">20</a></span>
<span class="normal"><a href="#__codelineno-37-21">21</a></span>
<span class="normal"><a href="#__codelineno-37-22">22</a></span>
<span class="normal"><a href="#__codelineno-37-23">23</a></span>
<span class="normal"><a href="#__codelineno-37-24">24</a></span>
<span class="normal"><a href="#__codelineno-37-25">25</a></span>
<span class="normal"><a href="#__codelineno-37-26">26</a></span>
<span class="normal"><a href="#__codelineno-37-27">27</a></span>
<span class="normal"><a href="#__codelineno-37-28">28</a></span>
<span class="normal"><a href="#__codelineno-37-29">29</a></span>
<span class="normal"><a href="#__codelineno-37-30">30</a></span>
<span class="normal"><a href="#__codelineno-37-31">31</a></span>
<span class="normal"><a href="#__codelineno-37-32">32</a></span>
<span class="normal"><a href="#__codelineno-37-33">33</a></span>
<span class="normal"><a href="#__codelineno-37-34">34</a></span>
<span class="normal"><a href="#__codelineno-37-35">35</a></span>
<span class="normal"><a href="#__codelineno-37-36">36</a></span>
<span class="normal"><a href="#__codelineno-37-37">37</a></span>
<span class="normal"><a href="#__codelineno-37-38">38</a></span>
<span class="normal"><a href="#__codelineno-37-39">39</a></span>
<span class="normal"><a href="#__codelineno-37-40">40</a></span>
<span class="normal"><a href="#__codelineno-37-41">41</a></span>
<span class="normal"><a href="#__codelineno-37-42">42</a></span>
<span class="normal"><a href="#__codelineno-37-43">43</a></span>
<span class="normal"><a href="#__codelineno-37-44">44</a></span>
<span class="normal"><a href="#__codelineno-37-45">45</a></span>
<span class="normal"><a href="#__codelineno-37-46">46</a></span>
<span class="normal"><a href="#__codelineno-37-47">47</a></span>
<span class="normal"><a href="#__codelineno-37-48">48</a></span>
<span class="normal"><a href="#__codelineno-37-49">49</a></span>
<span class="normal"><a href="#__codelineno-37-50">50</a></span>
<span class="normal"><a href="#__codelineno-37-51">51</a></span>
<span class="normal"><a href="#__codelineno-37-52">52</a></span>
<span class="normal"><a href="#__codelineno-37-53">53</a></span>
<span class="normal"><a href="#__codelineno-37-54">54</a></span>
<span class="normal"><a href="#__codelineno-37-55">55</a></span>
<span class="normal"><a href="#__codelineno-37-56">56</a></span>
<span class="normal"><a href="#__codelineno-37-57">57</a></span>
<span class="normal"><a href="#__codelineno-37-58">58</a></span>
<span class="normal"><a href="#__codelineno-37-59">59</a></span>
<span class="normal"><a href="#__codelineno-37-60">60</a></span>
<span class="normal"><a href="#__codelineno-37-61">61</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a># requirements.txt
<a id="__codelineno-37-2" name="__codelineno-37-2"></a>aiohttp==3.9.5
<a id="__codelineno-37-3" name="__codelineno-37-3"></a>aiosignal==1.3.1
<a id="__codelineno-37-4" name="__codelineno-37-4"></a>attrs==23.2.0
<a id="__codelineno-37-5" name="__codelineno-37-5"></a>certifi==2024.7.4
<a id="__codelineno-37-6" name="__codelineno-37-6"></a>charset-normalizer==3.3.2
<a id="__codelineno-37-7" name="__codelineno-37-7"></a>click==8.1.7
<a id="__codelineno-37-8" name="__codelineno-37-8"></a>datasets==2.20.0
<a id="__codelineno-37-9" name="__codelineno-37-9"></a>dill==0.3.8
<a id="__codelineno-37-10" name="__codelineno-37-10"></a>docutils==0.21.2
<a id="__codelineno-37-11" name="__codelineno-37-11"></a>filelock==3.15.4
<a id="__codelineno-37-12" name="__codelineno-37-12"></a>frozenlist==1.4.1
<a id="__codelineno-37-13" name="__codelineno-37-13"></a>fsspec==2024.5.0
<a id="__codelineno-37-14" name="__codelineno-37-14"></a>huggingface-hub==0.23.4
<a id="__codelineno-37-15" name="__codelineno-37-15"></a>idna==3.7
<a id="__codelineno-37-16" name="__codelineno-37-16"></a>Jinja2==3.1.4
<a id="__codelineno-37-17" name="__codelineno-37-17"></a>joblib==1.4.2
<a id="__codelineno-37-18" name="__codelineno-37-18"></a>MarkupSafe==2.1.5
<a id="__codelineno-37-19" name="__codelineno-37-19"></a>mpmath==1.3.0
<a id="__codelineno-37-20" name="__codelineno-37-20"></a>multidict==6.0.5
<a id="__codelineno-37-21" name="__codelineno-37-21"></a>multiprocess==0.70.16
<a id="__codelineno-37-22" name="__codelineno-37-22"></a>networkx==3.3
<a id="__codelineno-37-23" name="__codelineno-37-23"></a>nltk==3.8.1
<a id="__codelineno-37-24" name="__codelineno-37-24"></a>numpy==1.26.4
<a id="__codelineno-37-25" name="__codelineno-37-25"></a>nvidia-cublas-cu12==12.1.3.1
<a id="__codelineno-37-26" name="__codelineno-37-26"></a>nvidia-cuda-cupti-cu12==12.1.105
<a id="__codelineno-37-27" name="__codelineno-37-27"></a>nvidia-cuda-nvrtc-cu12==12.1.105
<a id="__codelineno-37-28" name="__codelineno-37-28"></a>nvidia-cuda-runtime-cu12==12.1.105
<a id="__codelineno-37-29" name="__codelineno-37-29"></a>nvidia-cudnn-cu12==8.9.2.26
<a id="__codelineno-37-30" name="__codelineno-37-30"></a>nvidia-cufft-cu12==11.0.2.54
<a id="__codelineno-37-31" name="__codelineno-37-31"></a>nvidia-curand-cu12==10.3.2.106
<a id="__codelineno-37-32" name="__codelineno-37-32"></a>nvidia-cusolver-cu12==11.4.5.107
<a id="__codelineno-37-33" name="__codelineno-37-33"></a>nvidia-cusparse-cu12==12.1.0.106
<a id="__codelineno-37-34" name="__codelineno-37-34"></a>nvidia-nccl-cu12==2.20.5
<a id="__codelineno-37-35" name="__codelineno-37-35"></a>nvidia-nvjitlink-cu12==12.5.82
<a id="__codelineno-37-36" name="__codelineno-37-36"></a>nvidia-nvtx-cu12==12.1.105
<a id="__codelineno-37-37" name="__codelineno-37-37"></a>packaging==24.1
<a id="__codelineno-37-38" name="__codelineno-37-38"></a>pandas==2.2.2
<a id="__codelineno-37-39" name="__codelineno-37-39"></a>pillow==10.4.0
<a id="__codelineno-37-40" name="__codelineno-37-40"></a>pyarrow==16.1.0
<a id="__codelineno-37-41" name="__codelineno-37-41"></a>pyarrow-hotfix==0.6
<a id="__codelineno-37-42" name="__codelineno-37-42"></a>python-dateutil==2.9.0.post0
<a id="__codelineno-37-43" name="__codelineno-37-43"></a>pytz==2024.1
<a id="__codelineno-37-44" name="__codelineno-37-44"></a>PyYAML==6.0.1
<a id="__codelineno-37-45" name="__codelineno-37-45"></a>regex==2024.5.15
<a id="__codelineno-37-46" name="__codelineno-37-46"></a>requests==2.32.3
<a id="__codelineno-37-47" name="__codelineno-37-47"></a>safetensors==0.4.3
<a id="__codelineno-37-48" name="__codelineno-37-48"></a>six==1.16.0
<a id="__codelineno-37-49" name="__codelineno-37-49"></a>sympy==1.13.0
<a id="__codelineno-37-50" name="__codelineno-37-50"></a>tokenizers==0.19.1
<a id="__codelineno-37-51" name="__codelineno-37-51"></a>torch==2.3.1
<a id="__codelineno-37-52" name="__codelineno-37-52"></a>torchaudio==2.3.1
<a id="__codelineno-37-53" name="__codelineno-37-53"></a>torchvision==0.18.1
<a id="__codelineno-37-54" name="__codelineno-37-54"></a>tqdm==4.66.4
<a id="__codelineno-37-55" name="__codelineno-37-55"></a>transformers==4.42.3
<a id="__codelineno-37-56" name="__codelineno-37-56"></a>triton==2.3.1
<a id="__codelineno-37-57" name="__codelineno-37-57"></a>typing_extensions==4.12.2
<a id="__codelineno-37-58" name="__codelineno-37-58"></a>tzdata==2024.1
<a id="__codelineno-37-59" name="__codelineno-37-59"></a>urllib3==2.2.2
<a id="__codelineno-37-60" name="__codelineno-37-60"></a>xxhash==3.4.1
<a id="__codelineno-37-61" name="__codelineno-37-61"></a>yarl==1.9.4
</code></pre></div></td></tr></table></div>
<p>这里我重装了一台 Ubuntu 虚拟机，在这个很干净的系统上装了 VS Code 和 Ananconda。接着在 VS Code 中使用 conda 配置 Python 虚拟环境，具体可以参考 <a href="https://blog.csdn.net/weixin_54383080/article/details/138613865?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172249837516800188578310%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=172249837516800188578310&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-2-138613865-null-null.142^v100^pc_search_result_base8&amp;utm_term=%E5%9C%A8vscode%E4%B8%AD%E5%88%9B%E5%BB%BAconda&amp;spm=1018.2226.3001.4187">CSDN</a>。  </p>
<p>这里下载包用的是<a href="https://pypi.tuna.tsinghua.edu.cn/simple">清华源</a>，总体效果非常好  </p>
<p><img alt="alt text" src="../image-107.png" />  </p>
<p>然后在虚拟机上配置 SSH 连接到 ZJUSCT 的集群。在使用 Terminal 成功 ping 通后又尝试了在 VS Code 中用 Remote-SSH。如果是 Terminal 直接连接的话只要把端口设置为 <code>-p 443</code> 即可；如果是用 Remote-SSH 需要挂上浙大的 RVPN（看98上说默认的22端口被封住了，应该是也必须从443端口连接，不过我没有试验）。  </p>
<h3 id="_3">实验基础知识<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>这个实验本质就是在复现那篇著名的文章 <a href="http://arxiv-org-s.webvpn.zju.edu.cn:8001/pdf/1706.03762">Attention Is All You Need</a> 中基于 Transformer 架构的机器翻译。那么首先就要理解 Transformer 架构。  </p>
<p>对 Transformer 形成一个框架可以看<a href="https://www.bilibili.com/video/BV1Ab421Y7D6/?spm_id_from=333.788&amp;vd_source=5742e02a7566918d65a441adce5bc163">b站视频</a>，接着看 <a href="https://www.bilibili.com/video/BV13z421U7cs/?spm_id_from=333.999.0.0&amp;vd_source=5742e02a7566918d65a441adce5bc163">3Blue1Brown</a> 可视化 Transformer 的两个视频。</p>
<h4 id="model-architecture">Model Architecture<a class="headerlink" href="#model-architecture" title="Permanent link">&para;</a></h4>
<p><img alt="alt text" src="../image-109.png" /></p>
<h4 id="attention">Attention<a class="headerlink" href="#attention" title="Permanent link">&para;</a></h4>
<p>An attention function can be described as mapping a <strong>query</strong> and a set of <strong>key-value pairs</strong> to an output, where the query, keys, values, and output are all vectors. The output is computed as <u>a weighted sum of the values</u>, where the weight assigned to each value is computed by a <strong>compatibility function</strong> of the query with the corresponding key.  </p>
<p><img alt="alt text" src="../image-108.png" />  </p>
<h4 id="embeddings-and-softmax">Embeddings and Softmax<a class="headerlink" href="#embeddings-and-softmax" title="Permanent link">&para;</a></h4>
<p>Similarly to other sequence transduction models, we use <strong>learned embeddings</strong> to <u>convert the input tokens and output tokens to vectors of dimension d<sub>model</sub> </u>. We also use the usual learned <strong>linear transformation</strong> and <strong>softmax function</strong> to <u>convert the decoder output to predicted next-token probabilities</u>. In our model, we share the same weight matrix between the two embedding layers and the pre-softmax linear transformation. In the embedding layers, we multiply those weights by <span class="arithmatex">\(\sqrt{d~model~}\)</span>.   </p>
<p><img alt="alt text" src="../image-124.png" /></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-38-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-38-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-38-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-38-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-38-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-38-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-38-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-38-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-38-10">10</a></span>
<span class="normal"><a href="#__codelineno-38-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="k">class</span> <span class="nc">InputEmbeddings</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-38-2" name="__codelineno-38-2"></a>
<a id="__codelineno-38-3" name="__codelineno-38-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-38-4" name="__codelineno-38-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-38-5" name="__codelineno-38-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
<a id="__codelineno-38-6" name="__codelineno-38-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">vocab_size</span>
<a id="__codelineno-38-7" name="__codelineno-38-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
<a id="__codelineno-38-8" name="__codelineno-38-8"></a>        <span class="c1"># &quot;nn.Embedding&quot; is a class in Pytorch to &quot;convert the input tokens and output tokens to vectors of dimension d_model&quot;</span>
<a id="__codelineno-38-9" name="__codelineno-38-9"></a>
<a id="__codelineno-38-10" name="__codelineno-38-10"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-38-11" name="__codelineno-38-11"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_model</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">1</a></span>
<span class="normal"><a href="#__codelineno-39-2">2</a></span>
<span class="normal"><a href="#__codelineno-39-3">3</a></span>
<span class="normal"><a href="#__codelineno-39-4">4</a></span>
<span class="normal"><a href="#__codelineno-39-5">5</a></span>
<span class="normal"><a href="#__codelineno-39-6">6</a></span>
<span class="normal"><a href="#__codelineno-39-7">7</a></span>
<span class="normal"><a href="#__codelineno-39-8">8</a></span>
<span class="normal"><a href="#__codelineno-39-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="k">class</span> <span class="nc">ProjectionLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-39-2" name="__codelineno-39-2"></a>
<a id="__codelineno-39-3" name="__codelineno-39-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-39-4" name="__codelineno-39-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-39-5" name="__codelineno-39-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">)</span>
<a id="__codelineno-39-6" name="__codelineno-39-6"></a>
<a id="__codelineno-39-7" name="__codelineno-39-7"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-39-8" name="__codelineno-39-8"></a>        <span class="c1"># &lt;batch, seq_len, d_model&gt; --&gt; &lt;batch, seq_len, vocab_size&gt;</span>
<a id="__codelineno-39-9" name="__codelineno-39-9"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">dim</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="positional-encoding">Positional Encoding<a class="headerlink" href="#positional-encoding" title="Permanent link">&para;</a></h4>
<p>Since our model contains no recurrence and no convolution, in order for the model to make use of <u>the order of the sequence</u>, we must inject some information about the relative or absolute position of the tokens in the sequence. To this end, we add "<strong>positional encodings</strong>" to the input embeddings at the bottoms of the encoder and decoder stacks. The positional encodings have the same dimension d<sub>model</sub> as the embeddings, so that the two can be summed. There are many choices of positional encodings, learned and fixed [9].  </p>
<p>In this work, we use sine and cosine functions of different frequencie:  </p>
<p><img alt="alt text" src="../image-110.png" />  </p>
<p>We chose this function because we hypothesized it would allow the model to easily learn to attend by relative positions, since for any fixed offset k, PE<sub>pos+k</sub> can be represented as a linear function of PEpos.  </p>
<p><img alt="alt text" src="../image-113.png" />  </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-40-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-40-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-40-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-40-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-40-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-40-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-40-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-40-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-40-10">10</a></span>
<span class="normal"><a href="#__codelineno-40-11">11</a></span>
<span class="normal"><a href="#__codelineno-40-12">12</a></span>
<span class="normal"><a href="#__codelineno-40-13">13</a></span>
<span class="normal"><a href="#__codelineno-40-14">14</a></span>
<span class="normal"><a href="#__codelineno-40-15">15</a></span>
<span class="normal"><a href="#__codelineno-40-16">16</a></span>
<span class="normal"><a href="#__codelineno-40-17">17</a></span>
<span class="normal"><a href="#__codelineno-40-18">18</a></span>
<span class="normal"><a href="#__codelineno-40-19">19</a></span>
<span class="normal"><a href="#__codelineno-40-20">20</a></span>
<span class="normal"><a href="#__codelineno-40-21">21</a></span>
<span class="normal"><a href="#__codelineno-40-22">22</a></span>
<span class="normal"><a href="#__codelineno-40-23">23</a></span>
<span class="normal"><a href="#__codelineno-40-24">24</a></span>
<span class="normal"><a href="#__codelineno-40-25">25</a></span>
<span class="normal"><a href="#__codelineno-40-26">26</a></span>
<span class="normal"><a href="#__codelineno-40-27">27</a></span>
<span class="normal"><a href="#__codelineno-40-28">28</a></span>
<span class="normal"><a href="#__codelineno-40-29">29</a></span>
<span class="normal"><a href="#__codelineno-40-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="k">class</span> <span class="nc">PositionalEncoding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-40-2" name="__codelineno-40-2"></a>
<a id="__codelineno-40-3" name="__codelineno-40-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-40-4" name="__codelineno-40-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-40-5" name="__codelineno-40-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
<a id="__codelineno-40-6" name="__codelineno-40-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span> <span class="o">=</span> <span class="n">seq_len</span>
<a id="__codelineno-40-7" name="__codelineno-40-7"></a>        <span class="c1"># Reduce overfitting of neural networks</span>
<a id="__codelineno-40-8" name="__codelineno-40-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-40-9" name="__codelineno-40-9"></a>
<a id="__codelineno-40-10" name="__codelineno-40-10"></a>        <span class="c1"># Create a matrix of shape &lt;seq_len, d_model&gt;  </span>
<a id="__codelineno-40-11" name="__codelineno-40-11"></a>        <span class="n">pe</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
<a id="__codelineno-40-12" name="__codelineno-40-12"></a>        <span class="c1"># Create a vector of shape &lt;seq_len, 1&gt;</span>
<a id="__codelineno-40-13" name="__codelineno-40-13"></a>        <span class="n">position</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-40-14" name="__codelineno-40-14"></a>        <span class="n">div_term</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10000.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">d_model</span><span class="p">))</span>
<a id="__codelineno-40-15" name="__codelineno-40-15"></a>        <span class="c1"># Apply the sin to even position</span>
<a id="__codelineno-40-16" name="__codelineno-40-16"></a>        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>
<a id="__codelineno-40-17" name="__codelineno-40-17"></a>        <span class="c1"># Apply the cos to odd position</span>
<a id="__codelineno-40-18" name="__codelineno-40-18"></a>        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>
<a id="__codelineno-40-19" name="__codelineno-40-19"></a>        <span class="c1"># Use the equivalent form of the original formula</span>
<a id="__codelineno-40-20" name="__codelineno-40-20"></a>
<a id="__codelineno-40-21" name="__codelineno-40-21"></a>        <span class="c1"># Add a new dimension &quot;batch&quot; to deal with a batch of sentences</span>
<a id="__codelineno-40-22" name="__codelineno-40-22"></a>        <span class="n">pe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># &lt;1, seq_len, d_model&gt;  </span>
<a id="__codelineno-40-23" name="__codelineno-40-23"></a>
<a id="__codelineno-40-24" name="__codelineno-40-24"></a>        <span class="c1"># Register a given tensor or any other object as a buffer for the model</span>
<a id="__codelineno-40-25" name="__codelineno-40-25"></a>        <span class="c1"># It will be saved and loaded along with the model</span>
<a id="__codelineno-40-26" name="__codelineno-40-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;pe&#39;</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span>
<a id="__codelineno-40-27" name="__codelineno-40-27"></a>
<a id="__codelineno-40-28" name="__codelineno-40-28"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-40-29" name="__codelineno-40-29"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pe</span><span class="p">[:,</span> <span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:])</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-40-30" name="__codelineno-40-30"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="add-norm">Add &amp; Norm<a class="headerlink" href="#add-norm" title="Permanent link">&para;</a></h4>
<p>For each item of a batch, we calculate a mean value and a variance independently, and then calculating the new value for each of them using their own mean value and their own variance.  </p>
<p><img alt="alt text" src="../image-112.png" />  </p>
<p>We also introduce two parameters, usually called <strong>gamma</strong>(multiplicative) and <strong>beta</strong>(additive) that introduce some <u>fluctuations</u> in the data, because maybe having all values between 0 and 1 may be too restrictive for the introduce fluctuations when necessary.   </p>
<p><img alt="alt text" src="../image-122.png" /></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-41-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-41-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-41-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-41-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-41-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-41-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-41-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-41-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-41-10">10</a></span>
<span class="normal"><a href="#__codelineno-41-11">11</a></span>
<span class="normal"><a href="#__codelineno-41-12">12</a></span>
<span class="normal"><a href="#__codelineno-41-13">13</a></span>
<span class="normal"><a href="#__codelineno-41-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="k">class</span> <span class="nc">LayerNormalization</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-41-2" name="__codelineno-41-2"></a>
<a id="__codelineno-41-3" name="__codelineno-41-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-41-4" name="__codelineno-41-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-41-5" name="__codelineno-41-5"></a>        <span class="c1"># In case &quot;sigma = 0&quot; or sigma being extremely small</span>
<a id="__codelineno-41-6" name="__codelineno-41-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>
<a id="__codelineno-41-7" name="__codelineno-41-7"></a>        <span class="c1"># Register as model parameters, which means that these tensors will be updated during the training of the model (learnable)</span>
<a id="__codelineno-41-8" name="__codelineno-41-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># multiplicative</span>
<a id="__codelineno-41-9" name="__codelineno-41-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># additive  </span>
<a id="__codelineno-41-10" name="__codelineno-41-10"></a>
<a id="__codelineno-41-11" name="__codelineno-41-11"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-41-12" name="__codelineno-41-12"></a>        <span class="n">mean</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-41-13" name="__codelineno-41-13"></a>        <span class="n">std</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-41-14" name="__codelineno-41-14"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
</code></pre></div></td></tr></table></div>
<h4 id="position-wise-feed-forward-networks">Position-wise Feed-Forward Networks<a class="headerlink" href="#position-wise-feed-forward-networks" title="Permanent link">&para;</a></h4>
<p>In addition to <u>attention sub-layers</u>, each of the layers in our encoder and decoder contains <strong>a fully connected feed-forward network</strong>, which is applied to each position separately and identically. This consists of two <u>linear transformations</u> with a <strong>ReLU(Rectified Linear Unit)</strong> activation in between.  </p>
<p><img alt="alt text" src="../image-114.png" />  </p>
<p>While the linear transformations are the same across different positions, they use different parameters from layer to layer. Another way of describing this is as two convolutions with kernel size 1.
The dimensionality of input and output is d<sub>model</sub> = 512, and the inner-layer has dimensionality d<sub>ff</sub> = 2048.  </p>
<p><img alt="alt text" src="../image-115.png" />  </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-42-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-42-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-42-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-42-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-42-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-42-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-42-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-42-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-42-10">10</a></span>
<span class="normal"><a href="#__codelineno-42-11">11</a></span>
<span class="normal"><a href="#__codelineno-42-12">12</a></span>
<span class="normal"><a href="#__codelineno-42-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="k">class</span> <span class="nc">FeedForwardBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-42-2" name="__codelineno-42-2"></a>
<a id="__codelineno-42-3" name="__codelineno-42-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">dropout</span><span class="p">:</span><span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-42-4" name="__codelineno-42-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-42-5" name="__codelineno-42-5"></a>        <span class="c1"># W1 &amp; B1</span>
<a id="__codelineno-42-6" name="__codelineno-42-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">)</span> <span class="c1"># &quot;bias:bool = True&quot; is the default</span>
<a id="__codelineno-42-7" name="__codelineno-42-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-42-8" name="__codelineno-42-8"></a>        <span class="c1"># W2 &amp; B2</span>
<a id="__codelineno-42-9" name="__codelineno-42-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_ff</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
<a id="__codelineno-42-10" name="__codelineno-42-10"></a>
<a id="__codelineno-42-11" name="__codelineno-42-11"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-42-12" name="__codelineno-42-12"></a>        <span class="c1"># &lt;batch, seq_len, d_model&gt; --&gt; &lt;batch, seq_len, d_ff&gt; --&gt; &lt;batch, seq_len, d_model&gt;  </span>
<a id="__codelineno-42-13" name="__codelineno-42-13"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_1</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
</code></pre></div></td></tr></table></div>
<h4 id="multi-head-attention">Multi-Head Attention<a class="headerlink" href="#multi-head-attention" title="Permanent link">&para;</a></h4>
<p>Instead of performing a single attention function with d<sub>model</sub>-dimensional keys, values and queries, we found it beneficial to <strong>linearly project the queries, keys and values h times with different, learned linear projections to d<sub>k</sub>, d<sub>k</sub> and d<sub>v</sub> dimensions, respectively</strong>. On each of these projected versions of queries, keys and values we then perform the attention function <u>in parallel</u>, yielding d<sub>v</sub>-dimensional output values. These are concatenated and once again projected, resulting in the final value.  </p>
<p>Multi-head attention allows the model to jointly attend to information from different representation
subspaces at different positions. With a single attention head, averaging inhibits this.  </p>
<p><img alt="alt text" src="../image-116.png" />  </p>
<p>Where the projections are parameter matrices W<sup>Q</sup> ∈ R<sup>dmodel×dk</sup> , W<sup>K</sup> ∈ R<sup>dmodel×dk</sup> , W<sup>V</sup> ∈ R<sup>dmodel×dv</sup> and W<sup>O</sup> ∈ R<sup>hdv×dmodel</sup>.  </p>
<p>In this work we employ h = 8 parallel attention layers, or heads. For each of these we use d<sub>k</sub> = d<sub>v</sub> = d<sub>model</sub>/h = 64. Due to the reduced dimension of each head, the total computational cost is similar to that of single-head attention with full dimensionality.  </p>
<p><img alt="alt text" src="../image-117.png" />  </p>
<p><img alt="alt text" src="../image-118.png" />  </p>
<p><img alt="alt text" src="../image-119.png" />  </p>
<p><img alt="alt text" src="../image-120.png" />  </p>
<p>To sum up:  </p>
<p><img alt="alt text" src="../image-121.png" />  </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-43-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-43-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-43-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-43-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-43-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-43-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-43-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-43-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-43-10">10</a></span>
<span class="normal"><a href="#__codelineno-43-11">11</a></span>
<span class="normal"><a href="#__codelineno-43-12">12</a></span>
<span class="normal"><a href="#__codelineno-43-13">13</a></span>
<span class="normal"><a href="#__codelineno-43-14">14</a></span>
<span class="normal"><a href="#__codelineno-43-15">15</a></span>
<span class="normal"><a href="#__codelineno-43-16">16</a></span>
<span class="normal"><a href="#__codelineno-43-17">17</a></span>
<span class="normal"><a href="#__codelineno-43-18">18</a></span>
<span class="normal"><a href="#__codelineno-43-19">19</a></span>
<span class="normal"><a href="#__codelineno-43-20">20</a></span>
<span class="normal"><a href="#__codelineno-43-21">21</a></span>
<span class="normal"><a href="#__codelineno-43-22">22</a></span>
<span class="normal"><a href="#__codelineno-43-23">23</a></span>
<span class="normal"><a href="#__codelineno-43-24">24</a></span>
<span class="normal"><a href="#__codelineno-43-25">25</a></span>
<span class="normal"><a href="#__codelineno-43-26">26</a></span>
<span class="normal"><a href="#__codelineno-43-27">27</a></span>
<span class="normal"><a href="#__codelineno-43-28">28</a></span>
<span class="normal"><a href="#__codelineno-43-29">29</a></span>
<span class="normal"><a href="#__codelineno-43-30">30</a></span>
<span class="normal"><a href="#__codelineno-43-31">31</a></span>
<span class="normal"><a href="#__codelineno-43-32">32</a></span>
<span class="normal"><a href="#__codelineno-43-33">33</a></span>
<span class="normal"><a href="#__codelineno-43-34">34</a></span>
<span class="normal"><a href="#__codelineno-43-35">35</a></span>
<span class="normal"><a href="#__codelineno-43-36">36</a></span>
<span class="normal"><a href="#__codelineno-43-37">37</a></span>
<span class="normal"><a href="#__codelineno-43-38">38</a></span>
<span class="normal"><a href="#__codelineno-43-39">39</a></span>
<span class="normal"><a href="#__codelineno-43-40">40</a></span>
<span class="normal"><a href="#__codelineno-43-41">41</a></span>
<span class="normal"><a href="#__codelineno-43-42">42</a></span>
<span class="normal"><a href="#__codelineno-43-43">43</a></span>
<span class="normal"><a href="#__codelineno-43-44">44</a></span>
<span class="normal"><a href="#__codelineno-43-45">45</a></span>
<span class="normal"><a href="#__codelineno-43-46">46</a></span>
<span class="normal"><a href="#__codelineno-43-47">47</a></span>
<span class="normal"><a href="#__codelineno-43-48">48</a></span>
<span class="normal"><a href="#__codelineno-43-49">49</a></span>
<span class="normal"><a href="#__codelineno-43-50">50</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="k">class</span> <span class="nc">MultiHeadAttentionBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-43-2" name="__codelineno-43-2"></a>
<a id="__codelineno-43-3" name="__codelineno-43-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-43-4" name="__codelineno-43-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-43-5" name="__codelineno-43-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
<a id="__codelineno-43-6" name="__codelineno-43-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
<a id="__codelineno-43-7" name="__codelineno-43-7"></a>        <span class="k">assert</span> <span class="n">d_model</span> <span class="o">%</span> <span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;d_model is not divisible by h&quot;</span>
<a id="__codelineno-43-8" name="__codelineno-43-8"></a>
<a id="__codelineno-43-9" name="__codelineno-43-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span> <span class="o">=</span> <span class="n">d_model</span> <span class="o">//</span> <span class="n">h</span>
<a id="__codelineno-43-10" name="__codelineno-43-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">w_q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span> <span class="c1"># wq</span>
<a id="__codelineno-43-11" name="__codelineno-43-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">w_k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span> <span class="c1"># wk</span>
<a id="__codelineno-43-12" name="__codelineno-43-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">w_v</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span> <span class="c1"># wv</span>
<a id="__codelineno-43-13" name="__codelineno-43-13"></a>
<a id="__codelineno-43-14" name="__codelineno-43-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">w_o</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span> <span class="c1"># wo</span>
<a id="__codelineno-43-15" name="__codelineno-43-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-43-16" name="__codelineno-43-16"></a>
<a id="__codelineno-43-17" name="__codelineno-43-17"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-43-18" name="__codelineno-43-18"></a>    <span class="k">def</span> <span class="nf">attention</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">dropout</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">):</span>
<a id="__codelineno-43-19" name="__codelineno-43-19"></a>        <span class="n">d_k</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-43-20" name="__codelineno-43-20"></a>
<a id="__codelineno-43-21" name="__codelineno-43-21"></a>        <span class="c1"># &lt;batch, h, seq_len, d_k&gt; --&gt; &lt;batch, h, seq_len, seq_len&gt;</span>
<a id="__codelineno-43-22" name="__codelineno-43-22"></a>        <span class="n">attention_scores</span> <span class="o">=</span> <span class="p">(</span><span class="n">query</span> <span class="o">@</span> <span class="n">key</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d_k</span><span class="p">))</span>
<a id="__codelineno-43-23" name="__codelineno-43-23"></a>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-43-24" name="__codelineno-43-24"></a>            <span class="n">attention_scores</span><span class="o">.</span><span class="n">mask_fill_</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">)</span>
<a id="__codelineno-43-25" name="__codelineno-43-25"></a>        <span class="n">attention_scores</span> <span class="o">=</span> <span class="n">attention_scores</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-43-26" name="__codelineno-43-26"></a>        <span class="k">if</span> <span class="n">dropout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-43-27" name="__codelineno-43-27"></a>            <span class="n">attention_scores</span> <span class="o">=</span> <span class="n">dropout</span><span class="p">(</span><span class="n">attention_scores</span><span class="p">)</span>
<a id="__codelineno-43-28" name="__codelineno-43-28"></a>
<a id="__codelineno-43-29" name="__codelineno-43-29"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">attention_scores</span> <span class="o">@</span> <span class="n">value</span><span class="p">),</span> <span class="n">attention_scores</span> 
<a id="__codelineno-43-30" name="__codelineno-43-30"></a>
<a id="__codelineno-43-31" name="__codelineno-43-31"></a>
<a id="__codelineno-43-32" name="__codelineno-43-32"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<a id="__codelineno-43-33" name="__codelineno-43-33"></a>        <span class="c1"># 1. dot product with weight matrices</span>
<a id="__codelineno-43-34" name="__codelineno-43-34"></a>        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_q</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="c1"># &lt;batch, seq_len, d_model&gt; --&gt; &lt;batch, seq_len, d_model&gt;</span>
<a id="__codelineno-43-35" name="__codelineno-43-35"></a>        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_k</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="c1"># &lt;batch, seq_len, d_model&gt; --&gt; &lt;batch, seq_len, d_model&gt;</span>
<a id="__codelineno-43-36" name="__codelineno-43-36"></a>        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_v</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="c1"># &lt;batch, seq_len, d_model&gt; --&gt; &lt;batch, seq_len, d_model&gt;</span>
<a id="__codelineno-43-37" name="__codelineno-43-37"></a>
<a id="__codelineno-43-38" name="__codelineno-43-38"></a>        <span class="c1"># 2. split tensor by number of heads</span>
<a id="__codelineno-43-39" name="__codelineno-43-39"></a>        <span class="c1"># &lt;batch, seq_len, d_model&gt; --&gt; &lt;batch, seq_len, h, d_k&gt; --&gt; &lt;batch, h, seq_len, d_k&gt;</span>
<a id="__codelineno-43-40" name="__codelineno-43-40"></a>        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-43-41" name="__codelineno-43-41"></a>        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-43-42" name="__codelineno-43-42"></a>        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-43-43" name="__codelineno-43-43"></a>
<a id="__codelineno-43-44" name="__codelineno-43-44"></a>        <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_scores</span> <span class="o">=</span> <span class="n">MultiHeadAttentionBlock</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-43-45" name="__codelineno-43-45"></a>
<a id="__codelineno-43-46" name="__codelineno-43-46"></a>        <span class="c1"># &lt;batch, h, seq_len, d_k&gt; --&gt; &lt;batch, seq_len, h, d_k&gt; --&gt; &lt;batch, seq_len, d_model&gt;</span>
<a id="__codelineno-43-47" name="__codelineno-43-47"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span>
<a id="__codelineno-43-48" name="__codelineno-43-48"></a>
<a id="__codelineno-43-49" name="__codelineno-43-49"></a>        <span class="c1"># &lt;batch, seq_len, d_model&gt; --&gt; &lt;batch, seq_len, d_model&gt;</span>
<a id="__codelineno-43-50" name="__codelineno-43-50"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_o</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p><img alt="alt text" src="../image-123.png" /></p>
<h4 id="encoder-stacks">Encoder Stacks<a class="headerlink" href="#encoder-stacks" title="Permanent link">&para;</a></h4>
<p>The encoder is composed of a stack of <em>N</em> = 6 identical layers. Each layer has <u>two sub-layers</u>. The first is a <strong>multi-head self-attention mechanism</strong>, and the second is a <strong>simple, position-wise fully connected feed-forward network</strong>. We employ a <strong>residual connection</strong> around each of the two sub-layers, followed by <strong>layer normalization</strong>. That is, the output of each sub-layer is <strong><em>LayerNorm(x + Sublayer(x))</em></strong>, where <em>Sublayer(x)</em> is the function implemented by the sub-layer itself. To facilitate these residual connections, all sub-layers in the model, as well as the embedding layers, produce outputs of dimension d<sub>model</sub> = 512.  </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1">1</a></span>
<span class="normal"><a href="#__codelineno-44-2">2</a></span>
<span class="normal"><a href="#__codelineno-44-3">3</a></span>
<span class="normal"><a href="#__codelineno-44-4">4</a></span>
<span class="normal"><a href="#__codelineno-44-5">5</a></span>
<span class="normal"><a href="#__codelineno-44-6">6</a></span>
<span class="normal"><a href="#__codelineno-44-7">7</a></span>
<span class="normal"><a href="#__codelineno-44-8">8</a></span>
<span class="normal"><a href="#__codelineno-44-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="k">class</span> <span class="nc">ResidualConnection</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-44-2" name="__codelineno-44-2"></a>
<a id="__codelineno-44-3" name="__codelineno-44-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-44-4" name="__codelineno-44-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-44-5" name="__codelineno-44-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-44-6" name="__codelineno-44-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">LayerNormalization</span><span class="p">()</span>
<a id="__codelineno-44-7" name="__codelineno-44-7"></a>
<a id="__codelineno-44-8" name="__codelineno-44-8"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">sublayer</span><span class="p">):</span>
<a id="__codelineno-44-9" name="__codelineno-44-9"></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">sublayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-45-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-45-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-45-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-45-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-45-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-45-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-45-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-45-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-45-10">10</a></span>
<span class="normal"><a href="#__codelineno-45-11">11</a></span>
<span class="normal"><a href="#__codelineno-45-12">12</a></span>
<span class="normal"><a href="#__codelineno-45-13">13</a></span>
<span class="normal"><a href="#__codelineno-45-14">14</a></span>
<span class="normal"><a href="#__codelineno-45-15">15</a></span>
<span class="normal"><a href="#__codelineno-45-16">16</a></span>
<span class="normal"><a href="#__codelineno-45-17">17</a></span>
<span class="normal"><a href="#__codelineno-45-18">18</a></span>
<span class="normal"><a href="#__codelineno-45-19">19</a></span>
<span class="normal"><a href="#__codelineno-45-20">20</a></span>
<span class="normal"><a href="#__codelineno-45-21">21</a></span>
<span class="normal"><a href="#__codelineno-45-22">22</a></span>
<span class="normal"><a href="#__codelineno-45-23">23</a></span>
<span class="normal"><a href="#__codelineno-45-24">24</a></span>
<span class="normal"><a href="#__codelineno-45-25">25</a></span>
<span class="normal"><a href="#__codelineno-45-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="k">class</span> <span class="nc">EncoderBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-45-2" name="__codelineno-45-2"></a>
<a id="__codelineno-45-3" name="__codelineno-45-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">self_attention_block</span><span class="p">:</span> <span class="n">MultiHeadAttentionBlock</span><span class="p">,</span> <span class="n">feed_forward_block</span><span class="p">:</span> <span class="n">FeedForwardBlock</span><span class="p">,</span> <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-45-4" name="__codelineno-45-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-45-5" name="__codelineno-45-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">self_attention_block</span> <span class="o">=</span> <span class="n">self_attention_block</span>
<a id="__codelineno-45-6" name="__codelineno-45-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">feed_forward_block</span> <span class="o">=</span> <span class="n">feed_forward_block</span>
<a id="__codelineno-45-7" name="__codelineno-45-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">residual_connections</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">ResidualConnection</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
<a id="__codelineno-45-8" name="__codelineno-45-8"></a>
<a id="__codelineno-45-9" name="__codelineno-45-9"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">):</span>
<a id="__codelineno-45-10" name="__codelineno-45-10"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_connections</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_attention_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">))</span>
<a id="__codelineno-45-11" name="__codelineno-45-11"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_connections</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_forward_block</span><span class="p">)</span>
<a id="__codelineno-45-12" name="__codelineno-45-12"></a>
<a id="__codelineno-45-13" name="__codelineno-45-13"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-45-14" name="__codelineno-45-14"></a>
<a id="__codelineno-45-15" name="__codelineno-45-15"></a><span class="k">class</span> <span class="nc">Encoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-45-16" name="__codelineno-45-16"></a>
<a id="__codelineno-45-17" name="__codelineno-45-17"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-45-18" name="__codelineno-45-18"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-45-19" name="__codelineno-45-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">layers</span>
<a id="__codelineno-45-20" name="__codelineno-45-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">LayerNormalization</span><span class="p">()</span>
<a id="__codelineno-45-21" name="__codelineno-45-21"></a>
<a id="__codelineno-45-22" name="__codelineno-45-22"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<a id="__codelineno-45-23" name="__codelineno-45-23"></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
<a id="__codelineno-45-24" name="__codelineno-45-24"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
<a id="__codelineno-45-25" name="__codelineno-45-25"></a>
<a id="__codelineno-45-26" name="__codelineno-45-26"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="decoder-stacks">Decoder Stacks<a class="headerlink" href="#decoder-stacks" title="Permanent link">&para;</a></h4>
<p>The decoder is also composed of a stack of <em>N</em> = 6 identical layers. In addition to the two sub-layers in each encoder layer, the decoder inserts a third sub-layer, which <strong>performs multi-head attention over the output of the encoder stack</strong>. Similar to the encoder, we employ residual connections around each of the sub-layers, followed by layer normalization. We also modify the self-attention sub-layer in the decoder stack to prevent positions from attending to subsequent positions. This masking, combined with fact that the output embeddings are offset by one position, <u>ensures that the predictions for position <em>i</em> can depend only on the known outputs at positions less than <em>i</em></u>.  </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-46-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-46-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-46-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-46-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-46-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-46-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-46-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-46-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-46-10">10</a></span>
<span class="normal"><a href="#__codelineno-46-11">11</a></span>
<span class="normal"><a href="#__codelineno-46-12">12</a></span>
<span class="normal"><a href="#__codelineno-46-13">13</a></span>
<span class="normal"><a href="#__codelineno-46-14">14</a></span>
<span class="normal"><a href="#__codelineno-46-15">15</a></span>
<span class="normal"><a href="#__codelineno-46-16">16</a></span>
<span class="normal"><a href="#__codelineno-46-17">17</a></span>
<span class="normal"><a href="#__codelineno-46-18">18</a></span>
<span class="normal"><a href="#__codelineno-46-19">19</a></span>
<span class="normal"><a href="#__codelineno-46-20">20</a></span>
<span class="normal"><a href="#__codelineno-46-21">21</a></span>
<span class="normal"><a href="#__codelineno-46-22">22</a></span>
<span class="normal"><a href="#__codelineno-46-23">23</a></span>
<span class="normal"><a href="#__codelineno-46-24">24</a></span>
<span class="normal"><a href="#__codelineno-46-25">25</a></span>
<span class="normal"><a href="#__codelineno-46-26">26</a></span>
<span class="normal"><a href="#__codelineno-46-27">27</a></span>
<span class="normal"><a href="#__codelineno-46-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="k">class</span> <span class="nc">DecoderBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-46-2" name="__codelineno-46-2"></a>
<a id="__codelineno-46-3" name="__codelineno-46-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">self_attention_block</span><span class="p">:</span> <span class="n">MultiHeadAttentionBlock</span><span class="p">,</span> <span class="n">cross_attention_block</span><span class="p">:</span> <span class="n">MultiHeadAttentionBlock</span><span class="p">,</span> <span class="n">feed_forward_block</span><span class="p">:</span> <span class="n">FeedForwardBlock</span><span class="p">,</span> <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-46-4" name="__codelineno-46-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-46-5" name="__codelineno-46-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">self_attention_block</span> <span class="o">=</span> <span class="n">self_attention_block</span>
<a id="__codelineno-46-6" name="__codelineno-46-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cross_attention_block</span> <span class="o">=</span> <span class="n">cross_attention_block</span>
<a id="__codelineno-46-7" name="__codelineno-46-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">feed_forward_block</span> <span class="o">=</span> <span class="n">feed_forward_block</span>
<a id="__codelineno-46-8" name="__codelineno-46-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">residual_connections</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">ResidualConnection</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
<a id="__codelineno-46-9" name="__codelineno-46-9"></a>
<a id="__codelineno-46-10" name="__codelineno-46-10"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">encoder_output</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="p">):</span>
<a id="__codelineno-46-11" name="__codelineno-46-11"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_connections</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_attention_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="p">))</span>
<a id="__codelineno-46-12" name="__codelineno-46-12"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_connections</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_attention_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">encoder_output</span><span class="p">,</span> <span class="n">encoder_output</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">))</span>
<a id="__codelineno-46-13" name="__codelineno-46-13"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_connections</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_forward_block</span><span class="p">)</span>
<a id="__codelineno-46-14" name="__codelineno-46-14"></a>
<a id="__codelineno-46-15" name="__codelineno-46-15"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-46-16" name="__codelineno-46-16"></a>
<a id="__codelineno-46-17" name="__codelineno-46-17"></a><span class="k">class</span> <span class="nc">Decoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-46-18" name="__codelineno-46-18"></a>
<a id="__codelineno-46-19" name="__codelineno-46-19"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-46-20" name="__codelineno-46-20"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-46-21" name="__codelineno-46-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">layers</span>
<a id="__codelineno-46-22" name="__codelineno-46-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nom</span> <span class="o">=</span> <span class="n">LayerNormalization</span><span class="p">()</span>
<a id="__codelineno-46-23" name="__codelineno-46-23"></a>
<a id="__codelineno-46-24" name="__codelineno-46-24"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">encoder_ouput</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="p">):</span>
<a id="__codelineno-46-25" name="__codelineno-46-25"></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
<a id="__codelineno-46-26" name="__codelineno-46-26"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">encoder_ouput</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span><span class="n">tgt_mask</span><span class="p">)</span>
<a id="__codelineno-46-27" name="__codelineno-46-27"></a>
<a id="__codelineno-46-28" name="__codelineno-46-28"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nom</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="projection-layers">Projection Layers<a class="headerlink" href="#projection-layers" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1">1</a></span>
<span class="normal"><a href="#__codelineno-47-2">2</a></span>
<span class="normal"><a href="#__codelineno-47-3">3</a></span>
<span class="normal"><a href="#__codelineno-47-4">4</a></span>
<span class="normal"><a href="#__codelineno-47-5">5</a></span>
<span class="normal"><a href="#__codelineno-47-6">6</a></span>
<span class="normal"><a href="#__codelineno-47-7">7</a></span>
<span class="normal"><a href="#__codelineno-47-8">8</a></span>
<span class="normal"><a href="#__codelineno-47-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="k">class</span> <span class="nc">ProjectionLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-47-2" name="__codelineno-47-2"></a>
<a id="__codelineno-47-3" name="__codelineno-47-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-47-4" name="__codelineno-47-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-47-5" name="__codelineno-47-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">)</span>
<a id="__codelineno-47-6" name="__codelineno-47-6"></a>
<a id="__codelineno-47-7" name="__codelineno-47-7"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-47-8" name="__codelineno-47-8"></a>        <span class="c1"># &lt;batch, seq_len, d_model&gt; --&gt; &lt;batch, seq_len, vocab_size&gt;</span>
<a id="__codelineno-47-9" name="__codelineno-47-9"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">dim</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="transformer-build-transformer">Transformer &amp; Build Transformer<a class="headerlink" href="#transformer-build-transformer" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-48-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-48-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-48-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-48-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-48-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-48-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-48-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-48-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-48-10">10</a></span>
<span class="normal"><a href="#__codelineno-48-11">11</a></span>
<span class="normal"><a href="#__codelineno-48-12">12</a></span>
<span class="normal"><a href="#__codelineno-48-13">13</a></span>
<span class="normal"><a href="#__codelineno-48-14">14</a></span>
<span class="normal"><a href="#__codelineno-48-15">15</a></span>
<span class="normal"><a href="#__codelineno-48-16">16</a></span>
<span class="normal"><a href="#__codelineno-48-17">17</a></span>
<span class="normal"><a href="#__codelineno-48-18">18</a></span>
<span class="normal"><a href="#__codelineno-48-19">19</a></span>
<span class="normal"><a href="#__codelineno-48-20">20</a></span>
<span class="normal"><a href="#__codelineno-48-21">21</a></span>
<span class="normal"><a href="#__codelineno-48-22">22</a></span>
<span class="normal"><a href="#__codelineno-48-23">23</a></span>
<span class="normal"><a href="#__codelineno-48-24">24</a></span>
<span class="normal"><a href="#__codelineno-48-25">25</a></span>
<span class="normal"><a href="#__codelineno-48-26">26</a></span>
<span class="normal"><a href="#__codelineno-48-27">27</a></span>
<span class="normal"><a href="#__codelineno-48-28">28</a></span>
<span class="normal"><a href="#__codelineno-48-29">29</a></span>
<span class="normal"><a href="#__codelineno-48-30">30</a></span>
<span class="normal"><a href="#__codelineno-48-31">31</a></span>
<span class="normal"><a href="#__codelineno-48-32">32</a></span>
<span class="normal"><a href="#__codelineno-48-33">33</a></span>
<span class="normal"><a href="#__codelineno-48-34">34</a></span>
<span class="normal"><a href="#__codelineno-48-35">35</a></span>
<span class="normal"><a href="#__codelineno-48-36">36</a></span>
<span class="normal"><a href="#__codelineno-48-37">37</a></span>
<span class="normal"><a href="#__codelineno-48-38">38</a></span>
<span class="normal"><a href="#__codelineno-48-39">39</a></span>
<span class="normal"><a href="#__codelineno-48-40">40</a></span>
<span class="normal"><a href="#__codelineno-48-41">41</a></span>
<span class="normal"><a href="#__codelineno-48-42">42</a></span>
<span class="normal"><a href="#__codelineno-48-43">43</a></span>
<span class="normal"><a href="#__codelineno-48-44">44</a></span>
<span class="normal"><a href="#__codelineno-48-45">45</a></span>
<span class="normal"><a href="#__codelineno-48-46">46</a></span>
<span class="normal"><a href="#__codelineno-48-47">47</a></span>
<span class="normal"><a href="#__codelineno-48-48">48</a></span>
<span class="normal"><a href="#__codelineno-48-49">49</a></span>
<span class="normal"><a href="#__codelineno-48-50">50</a></span>
<span class="normal"><a href="#__codelineno-48-51">51</a></span>
<span class="normal"><a href="#__codelineno-48-52">52</a></span>
<span class="normal"><a href="#__codelineno-48-53">53</a></span>
<span class="normal"><a href="#__codelineno-48-54">54</a></span>
<span class="normal"><a href="#__codelineno-48-55">55</a></span>
<span class="normal"><a href="#__codelineno-48-56">56</a></span>
<span class="normal"><a href="#__codelineno-48-57">57</a></span>
<span class="normal"><a href="#__codelineno-48-58">58</a></span>
<span class="normal"><a href="#__codelineno-48-59">59</a></span>
<span class="normal"><a href="#__codelineno-48-60">60</a></span>
<span class="normal"><a href="#__codelineno-48-61">61</a></span>
<span class="normal"><a href="#__codelineno-48-62">62</a></span>
<span class="normal"><a href="#__codelineno-48-63">63</a></span>
<span class="normal"><a href="#__codelineno-48-64">64</a></span>
<span class="normal"><a href="#__codelineno-48-65">65</a></span>
<span class="normal"><a href="#__codelineno-48-66">66</a></span>
<span class="normal"><a href="#__codelineno-48-67">67</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="k">class</span> <span class="nc">Transformer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-48-2" name="__codelineno-48-2"></a>
<a id="__codelineno-48-3" name="__codelineno-48-3"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">,</span> <span class="n">decoder</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">,</span> <span class="n">src_embed</span><span class="p">:</span> <span class="n">InputEmbeddings</span><span class="p">,</span> <span class="n">tgt_embed</span><span class="p">:</span> <span class="n">InputEmbeddings</span><span class="p">,</span> <span class="n">src_pos</span><span class="p">:</span> <span class="n">PositionalEncoding</span><span class="p">,</span> <span class="n">tgt_pos</span><span class="p">:</span> <span class="n">PositionalEncoding</span><span class="p">,</span> <span class="n">projection_layer</span><span class="p">:</span> <span class="n">ProjectionLayer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-48-4" name="__codelineno-48-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-48-5" name="__codelineno-48-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span>
<a id="__codelineno-48-6" name="__codelineno-48-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">decoder</span>
<a id="__codelineno-48-7" name="__codelineno-48-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">src_embed</span> <span class="o">=</span> <span class="n">src_embed</span>
<a id="__codelineno-48-8" name="__codelineno-48-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tgt_embed</span> <span class="o">=</span> <span class="n">tgt_embed</span>
<a id="__codelineno-48-9" name="__codelineno-48-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">src_pos</span> <span class="o">=</span> <span class="n">src_pos</span>
<a id="__codelineno-48-10" name="__codelineno-48-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tgt_pos</span> <span class="o">=</span> <span class="n">tgt_pos</span>
<a id="__codelineno-48-11" name="__codelineno-48-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">projection_layer</span> <span class="o">=</span> <span class="n">projection_layer</span>
<a id="__codelineno-48-12" name="__codelineno-48-12"></a>
<a id="__codelineno-48-13" name="__codelineno-48-13"></a>    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">):</span>
<a id="__codelineno-48-14" name="__codelineno-48-14"></a>        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_embed</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<a id="__codelineno-48-15" name="__codelineno-48-15"></a>        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_pos</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<a id="__codelineno-48-16" name="__codelineno-48-16"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">)</span>
<a id="__codelineno-48-17" name="__codelineno-48-17"></a>
<a id="__codelineno-48-18" name="__codelineno-48-18"></a>    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder_output</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="p">):</span>
<a id="__codelineno-48-19" name="__codelineno-48-19"></a>        <span class="n">tgt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_embed</span><span class="p">(</span><span class="n">tgt</span><span class="p">)</span>
<a id="__codelineno-48-20" name="__codelineno-48-20"></a>        <span class="n">tgt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_pos</span><span class="p">(</span><span class="n">tgt</span><span class="p">)</span>
<a id="__codelineno-48-21" name="__codelineno-48-21"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">encoder_output</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="p">)</span>
<a id="__codelineno-48-22" name="__codelineno-48-22"></a>
<a id="__codelineno-48-23" name="__codelineno-48-23"></a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-48-24" name="__codelineno-48-24"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection_layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-48-25" name="__codelineno-48-25"></a>
<a id="__codelineno-48-26" name="__codelineno-48-26"></a><span class="k">def</span> <span class="nf">build_transformer</span><span class="p">(</span><span class="n">src_vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">src_seq_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="n">N</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transformer</span><span class="p">:</span>
<a id="__codelineno-48-27" name="__codelineno-48-27"></a>    <span class="c1"># Create the embedding layers</span>
<a id="__codelineno-48-28" name="__codelineno-48-28"></a>    <span class="n">src_embed</span> <span class="o">=</span> <span class="n">InputEmbeddings</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">src_vocab_size</span><span class="p">)</span>
<a id="__codelineno-48-29" name="__codelineno-48-29"></a>    <span class="n">tgt_embed</span> <span class="o">=</span> <span class="n">InputEmbeddings</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">)</span>
<a id="__codelineno-48-30" name="__codelineno-48-30"></a>
<a id="__codelineno-48-31" name="__codelineno-48-31"></a>    <span class="c1"># Create the positional encoding layers</span>
<a id="__codelineno-48-32" name="__codelineno-48-32"></a>    <span class="n">src_pos</span> <span class="o">=</span> <span class="n">PositionalEncoding</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">src_seq_len</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-48-33" name="__codelineno-48-33"></a>    <span class="n">tgt_pos</span> <span class="o">=</span> <span class="n">PositionalEncoding</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">tgt_seq_len</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-48-34" name="__codelineno-48-34"></a>
<a id="__codelineno-48-35" name="__codelineno-48-35"></a>    <span class="c1"># Create the encoder blocks</span>
<a id="__codelineno-48-36" name="__codelineno-48-36"></a>    <span class="n">encoder_blocks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-48-37" name="__codelineno-48-37"></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">N</span><span class="p">):</span>
<a id="__codelineno-48-38" name="__codelineno-48-38"></a>        <span class="n">encoder_self_attention_block</span> <span class="o">=</span> <span class="n">MultiHeadAttentionBlock</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-48-39" name="__codelineno-48-39"></a>        <span class="n">feed_forward_block</span> <span class="o">=</span> <span class="n">FeedForwardBlock</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-48-40" name="__codelineno-48-40"></a>        <span class="n">encoder_block</span> <span class="o">=</span> <span class="n">EncoderBlock</span><span class="p">(</span><span class="n">encoder_self_attention_block</span><span class="p">,</span> <span class="n">feed_forward_block</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-48-41" name="__codelineno-48-41"></a>        <span class="n">encoder_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">encoder_block</span><span class="p">)</span>
<a id="__codelineno-48-42" name="__codelineno-48-42"></a>
<a id="__codelineno-48-43" name="__codelineno-48-43"></a>    <span class="c1"># Create the decoder blocks</span>
<a id="__codelineno-48-44" name="__codelineno-48-44"></a>    <span class="n">decoder_blocks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-48-45" name="__codelineno-48-45"></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">N</span><span class="p">):</span>
<a id="__codelineno-48-46" name="__codelineno-48-46"></a>        <span class="n">decoder_self_attention_block</span> <span class="o">=</span> <span class="n">MultiHeadAttentionBlock</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-48-47" name="__codelineno-48-47"></a>        <span class="n">decoder_cross_attention_block</span> <span class="o">=</span> <span class="n">MultiHeadAttentionBlock</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-48-48" name="__codelineno-48-48"></a>        <span class="n">feed_forward_block</span> <span class="o">=</span> <span class="n">FeedForwardBlock</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-48-49" name="__codelineno-48-49"></a>        <span class="n">decoder_block</span> <span class="o">=</span> <span class="n">DecoderBlock</span><span class="p">(</span><span class="n">decoder_self_attention_block</span><span class="p">,</span> <span class="n">decoder_cross_attention_block</span><span class="p">,</span> <span class="n">feed_forward_block</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-48-50" name="__codelineno-48-50"></a>        <span class="n">decoder_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decoder_block</span><span class="p">)</span>
<a id="__codelineno-48-51" name="__codelineno-48-51"></a>
<a id="__codelineno-48-52" name="__codelineno-48-52"></a>    <span class="c1"># Create the encoder &amp; decoder</span>
<a id="__codelineno-48-53" name="__codelineno-48-53"></a>    <span class="n">encoder</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">[</span><span class="n">encoder_blocks</span><span class="p">])</span>
<a id="__codelineno-48-54" name="__codelineno-48-54"></a>    <span class="n">decoder</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">[</span><span class="n">decoder_blocks</span><span class="p">])</span>
<a id="__codelineno-48-55" name="__codelineno-48-55"></a>
<a id="__codelineno-48-56" name="__codelineno-48-56"></a>    <span class="c1"># Create the projection layer</span>
<a id="__codelineno-48-57" name="__codelineno-48-57"></a>    <span class="n">projection_layer</span> <span class="o">=</span> <span class="n">ProjectionLayer</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">tgt_vocab_size</span><span class="p">)</span>
<a id="__codelineno-48-58" name="__codelineno-48-58"></a>
<a id="__codelineno-48-59" name="__codelineno-48-59"></a>    <span class="c1"># Create the Transformer</span>
<a id="__codelineno-48-60" name="__codelineno-48-60"></a>    <span class="n">transformer</span> <span class="o">=</span> <span class="n">Transformer</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="n">src_embed</span><span class="p">,</span> <span class="n">tgt_embed</span><span class="p">,</span> <span class="n">src_pos</span><span class="p">,</span> <span class="n">tgt_pos</span><span class="p">,</span> <span class="n">projection_layer</span><span class="p">)</span>
<a id="__codelineno-48-61" name="__codelineno-48-61"></a>
<a id="__codelineno-48-62" name="__codelineno-48-62"></a>    <span class="c1"># Initialize the parameters</span>
<a id="__codelineno-48-63" name="__codelineno-48-63"></a>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">transformer</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<a id="__codelineno-48-64" name="__codelineno-48-64"></a>        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-48-65" name="__codelineno-48-65"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<a id="__codelineno-48-66" name="__codelineno-48-66"></a>
<a id="__codelineno-48-67" name="__codelineno-48-67"></a>    <span class="k">return</span> <span class="n">transformer</span>
</code></pre></div></td></tr></table></div>









  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        此页面有帮助吗？
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              谢谢你的反馈！
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              Thanks for your feedback! Help us improve this page by using our <a href="https://marketingplatform.google.com/about/analytics/" target="_blank" rel="noopener">feedback form</a>.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../HPC%20Learning/notebook/HPC%20Learning/" class="md-footer__link md-footer__link--prev" aria-label="上一页: HPC-Learning">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                HPC-Learning
              </div>
            </div>
          </a>
        
        
          
          <a href="../../Lab%20Reports/lab1%20report/lab1%20report/" class="md-footer__link md-footer__link--next" aria-label="下一页: Lab1 Report">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                Lab1 Report
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022~2024 Lee/All Rights Reserved.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/dongqianyu99" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:<2015475633@qq.com>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M64 112c-8.8 0-16 7.2-16 16v22.1l172.5 141.6c20.7 17 50.4 17 71.1 0L464 150.1V128c0-8.8-7.2-16-16-16zM48 212.2V384c0 8.8 7.2 16 16 16h384c8.8 0 16-7.2 16-16V212.2L322 328.8c-38.4 31.5-93.7 31.5-132 0zM0 128c0-35.3 28.7-64 64-64h384c35.3 0 64 28.7 64 64v256c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["announce.dismiss", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.top", "navigation.footer", "search.suggest", "search.highlight", "search.share", "navigation.expand", "navigation.indexes", "content.tabs.link", "content.tooltips", "content.code.copy", "content.action.edit", "content.action.view", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.525ec568.min.js"></script>
      
        <script src="../../../javascripts/extra.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.0.2/dist/add-html-label-6e56ed67.min.js"></script>
      
    
  </body>
</html>